<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panopto Canvas Prompt Builder</title>
<link rel="icon" type="image/png" href="favicon.png" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  
  * { margin:0; padding:0; box-sizing:border-box; }
  
  :root {
    --qub: #E0001B;
    --qub-red: #E0001B;
    --primary: #E0001B;
    --primary-hover: #b00016;
    --primary-gradient: linear-gradient(135deg, #E0001B 0%, #ff4757 100%);
    --success: #34c759;
    --success-gradient: linear-gradient(135deg, #34c759 0%, #00d9ff 100%);
    --warning: #ff9500;
    --danger: #ff3b30;
    --bg: #fafafa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f0f2f5;
    --text: #0a0a0a;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;
    --border: #e5e7eb;
    --shadow: 0 4px 20px rgba(0,0,0,0.06);
    --shadow-md: 0 8px 30px rgba(0,0,0,0.08);
    --shadow-lg: 0 20px 60px rgba(0,0,0,0.12);
    --shadow-xl: 0 30px 80px rgba(0,0,0,0.15);
    --radius: 16px;
    --radius-lg: 24px;
    --radius-xl: 32px;
    --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-qub: linear-gradient(135deg, #E0001B 0%, #ff4757 50%, #ff6b81 100%);
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }
  
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    position: relative;
    overflow-x: hidden;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(224,0,27,0.03) 0%, transparent 70%);
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }
  
  body::after {
    content: '';
    position: fixed;
    bottom: -50%;
    left: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(102,126,234,0.03) 0%, transparent 70%);
    animation: float 25s ease-in-out infinite reverse;
    pointer-events: none;
    z-index: 0;
  }
  
  /* Header */
  header {
    background: rgba(255,255,255,0.8);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    backdrop-filter: blur(30px) saturate(180%);
    border-bottom: 1px solid rgba(224,0,27,0.1);
    padding: 1.25rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: fadeInUp 0.6s ease-out;
  }
  
  header:hover {
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
  }
  
  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    z-index: 1;
  }
  
  .brand {
    display: flex;
    align-items: center;
    gap: 14px;
    position: relative;
    z-index: 1;
  }
  
  .brand img {
    height: 32px;
    transition: transform 0.3s ease;
    filter: drop-shadow(0 2px 8px rgba(224,0,27,0.15));
  }
  
  .brand img:hover {
    transform: scale(1.05);
  }
  
  .brand h1 {
    font-size: 1.35rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .logo {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    font-size: 1.35rem;
    font-weight: 700;
  }
  
  .logo-icon {
    width: 42px;
    height: 42px;
    background: var(--gradient-qub);
    background-size: 200% 200%;
    animation: gradientShift 8s ease infinite;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    box-shadow: 0 8px 24px rgba(224,0,27,0.25);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
  }
  
  .logo-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
  }
  
  .logo-icon:hover {
    transform: rotate(-5deg) scale(1.1);
    box-shadow: 0 12px 32px rgba(224,0,27,0.35);
  }
  
  /* Navigation Menu */
  .workflow-selector {
    display: flex;
    gap: 2rem;
    align-items: center;
  }
  
  .workflow-btn {
    padding: 0.625rem 0;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    letter-spacing: -0.01em;
  }
  
  .workflow-btn::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--gradient-qub);
    border-radius: 999px;
    transform: scaleX(0);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .workflow-btn:hover:not(.active) {
    color: var(--text);
  }
  
  .workflow-btn.active {
    color: var(--primary);
    font-weight: 700;
  }
  
  .workflow-btn.active::after {
    transform: scaleX(1);
  }
  
  /* Main Container */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 4rem 2rem;
    position: relative;
    z-index: 1;
  }
  
  /* Hero Banner */
  .hero-banner {
    position: relative;
    width: 100%;
    height: 400px;
    background: linear-gradient(135deg, rgba(224,0,27,0.85) 0%, rgba(147,51,234,0.85) 50%, rgba(59,130,246,0.85) 100%), 
                url('QUB-gallery-image-lanyon-building.jpg') center/cover;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: white;
    overflow: hidden;
    margin-bottom: 4rem;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .hero-banner.quiz-hero {
    background: linear-gradient(135deg, rgba(224,0,27,0.85) 0%, rgba(147,51,234,0.85) 50%, rgba(59,130,246,0.85) 100%), 
               url('businessschoolimage_2800_q80.jpg') center/cover;
  }
  
  .hero-banner.study-hero {
    background: linear-gradient(135deg, rgba(16,185,129,0.85) 0%, rgba(59,130,246,0.85) 100%), 
                url('_S6A0583a.jpg') center/cover;
  }
  
  .hero-banner.notes-hero {
    background: linear-gradient(135deg, rgba(245,158,11,0.85) 0%, rgba(239,68,68,0.85) 100%), 
               url('images/campus3.jpg') center/cover;
  }
  
  .hero-banner.help-hero {
    background: linear-gradient(135deg, rgba(124,58,237,0.85) 0%, rgba(236,72,153,0.85) 100%), 
                url('QUB-gallery-image-lanyon-building.jpg') center/cover;
  }
  
  .hero-banner::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.15) 0%, transparent 50%);
    animation: float 20s ease-in-out infinite;
  }
  
  .hero-content {
    position: relative;
    z-index: 1;
    max-width: 1100px; /* allow wider single-line headings on desktop */
    padding: 0 2rem;
    animation: fadeInUp 0.8s ease-out 0.2s both;
  }
  
  .hero-title {
    font-size: clamp(2.25rem, 5.5vw, 4.5rem);
    font-weight: 800;
    line-height: 1.05;
    margin: 0 0 1.5rem;
    letter-spacing: -0.03em;
    text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    /* text-wrap: balance; */ /* disabled for Safari < 17.5 compatibility */
  }
  
  .hero-subtitle {
    font-size: clamp(1rem, 1.25vw, 1.35rem);
    line-height: 1.6;
    margin: 0;
    opacity: 0.95;
    font-weight: 400;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    /* text-wrap: pretty; */ /* disabled for Firefox/Safari compatibility */
  }

  @media (max-width: 1024px) {
    .hero-content { max-width: 900px; }
  }
  @media (max-width: 768px) {
    .hero-content { max-width: 700px; }
  }
  
  .hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1.25rem;
    background: rgba(255,255,255,0.2);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    border-radius: 999px;
    font-size: 0.9375rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255,255,255,0.3);
    /* text-wrap: balance; */ /* disabled for Safari < 17.4 compatibility */
  }
  
  /* Hero Section */
  .hero {
    max-width: 1000px;
    margin: 0 auto 4rem;
    text-align: center;
    display: none;
  }
  
  .hero h2 {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1.1;
    margin: 0 0 1.5rem;
    letter-spacing: -0.03em;
    background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
  }
  
  .hero h2::after {
    content: '';
    position: absolute;
    bottom: -12px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 5px;
    background: var(--gradient-qub);
    border-radius: 999px;
    opacity: 0.6;
  }
  
  .hero p {
    font-size: 1.25rem;
    color: var(--text-secondary);
    max-width: 680px;
    margin: 0 auto;
    line-height: 1.7;
    font-weight: 400;
  }
  
  .hero-sub {
    max-width: 920px;
    margin: 12px auto 0;
    color: var(--text-tertiary);
  }
  
  .info {
    max-width: 920px;
    margin: 2rem auto;
    padding: 2rem;
    border: 1px solid rgba(224,0,27,0.1);
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
    display: none;
  }
  
  .info.show {
    display: block;
    animation: fadeInUp 0.4s ease-out both;
  }
  
  .info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-qub);
  }
  
  /* Help Button */
  .help-toggle {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.75rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #d946ef 100%);
    color: white;
    border: none;
    border-radius: 999px;
    font-size: 1.0625rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(124,58,237,0.3);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .help-toggle:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 12px 32px rgba(124,58,237,0.5);
    background: linear-gradient(135deg, #6d28d9 0%, #9333ea 50%, #c026d3 100%);
  }
  
  .help-toggle-icon {
    font-size: 1.5rem;
    line-height: 1;
  }
  
  /* Quick Start Section */
  .quick-start {
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    padding: 3rem;
    margin-bottom: 3rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    animation: fadeInUp 0.8s ease-out 0.3s both;
  }
  
  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  
  .preset-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
  }
  
  .preset-card {
    background: white;
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  
  .preset-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gradient-qub);
    opacity: 0;
    transition: opacity 0.4s;
    z-index: 0;
  }
  
  .preset-card:hover {
    border-color: var(--primary);
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-xl);
  }
  
  .preset-card:hover::before {
    opacity: 0.03;
  }
  
  .preset-card.active {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(224,0,27,0.05) 0%, rgba(224,0,27,0.02) 100%);
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }
  
  .preset-icon {
    font-size: 3rem;
    margin-bottom: 0.75rem;
    position: relative;
    z-index: 1;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .preset-card:hover .preset-icon {
    transform: scale(1.2) rotate(-5deg);
  }
  
  .preset-name {
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
    position: relative;
    z-index: 1;
    letter-spacing: -0.01em;
  }
  
  .preset-desc {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.6;
    position: relative;
    z-index: 1;
  }

  .tool-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: rgba(224,0,27,0.08);
    border: 1px solid rgba(224,0,27,0.2);
    font-weight: 600;
    font-size: 0.8125rem;
    color: #E0001B;
    margin-bottom: 0.75rem;
  }
  
  .tool-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  
  .btn-ghost {
    background: transparent;
    border: 2px solid var(--border);
  }
  
  .btn-ghost:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  .study-tools-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  @media (max-width: 900px) {
    .study-tools-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 600px) {
    .study-tools-grid {
      grid-template-columns: 1fr;
    }
  }

  .tool-card {
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    padding: 24px;
    display: flex;
    flex-direction: column;
    gap: 16px;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    border: 2px solid transparent;
  }

  .tool-card:hover {
    box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    transform: translateY(-4px);
    border-color: var(--tool-accent, var(--primary));
  }

  .tool-card .tool-badge {
    background: var(--tool-badge-bg, rgba(224,0,27,0.12));
    color: var(--tool-accent, var(--primary));
    border-radius: 12px;
    padding: 8px 16px;
    font-size: 1.125rem;
    font-weight: 700;
    letter-spacing: -0.01em;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    width: fit-content;
    align-self: flex-start;
  }

  .tool-points {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 8px;
    flex-grow: 1;
  }

  .tool-points li {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    font-size: 0.95rem;
    line-height: 1.5;
    color: #555;
    position: relative;
    padding-left: 20px;
    text-align: left;
  }

  .tool-points li::before {
    content: '‚úì';
    position: absolute;
    left: 0;
    top: 0;
    color: var(--tool-accent, var(--primary));
    font-weight: 700;
    flex-shrink: 0;
  }

  .tool-card .tool-actions {
    display: flex;
    flex-direction: column;
    gap: 10px;
    width: 100%;
  }

  .tool-card .btn-primary {
    width: 100%;
    justify-content: center;
    background: var(--tool-accent, var(--primary));
    color: #ffffff;
    padding: 12px 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    font-size: 1rem;
    font-weight: 700;
    border-radius: 8px;
    border: none;
  }

  .tool-card .btn-primary:hover {
    background: var(--tool-accent-hover, var(--primary-hover));
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.15);
  }

  .tool-card .btn-ghost {
    width: 100%;
    justify-content: center;
    background: #ffffff;
    border: 2px solid var(--tool-accent, var(--primary));
    color: var(--tool-accent, var(--primary));
    padding: 10px 20px;
    font-weight: 600;
    border-radius: 8px;
  }

  .tool-card .btn-ghost:hover {
    background: var(--tool-accent, var(--primary));
    color: #ffffff;
    border-color: var(--tool-accent, var(--primary));
  }

  .tool-card .btn-primary,
  .tool-card .btn-ghost {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
    letter-spacing: -0.01em;
    white-space: nowrap;
  }

  /* Output Format Card Specific Styles */
  .output-format-card {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid var(--border);
    text-align: left;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    padding: 24px;
    box-sizing: border-box;
    overflow: hidden;
  }

  .output-format-card h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: #111;
    margin: 0 0 8px 0;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .output-format-card p {
    font-size: 0.95rem;
    color: #555;
    margin: 0 0 16px 0;
    line-height: 1.5;
    flex-grow: 1;
  }

  .output-format-options {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: auto;
    width: 100%;
    box-sizing: border-box;
  }

  .format-option {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    background: #ffffff;
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 10px 12px;
    font-size: 0.9rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
    text-align: center;
    min-height: 48px;
    position: relative;
    z-index: 1;
    pointer-events: auto;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden;
  }

  .format-option:hover {
    border-color: var(--primary);
    background: rgba(224,0,27,0.02);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  }

  .format-option.active {
    background: #E0001B;
    color: white;
    border-color: #E0001B;
    box-shadow: 0 4px 12px rgba(224,0,27,0.3);
  }

  .format-option.active:hover {
    background: #c00017;
    border-color: #c00017;
    transform: translateY(-2px);
  }

  .study-preview-panel {
    margin-top: 2rem;
    background: rgba(255,255,255,0.95);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
  }

  .study-preview-panel.hidden {
    display: none;
  }

  .study-preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .study-preview-title {
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  .study-preview-meta {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .study-preview-body {
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    background: #f9fafb;
    padding: 1.5rem;
    max-height: 420px;
    overflow-y: auto;
  }

  .study-preview-placeholder {
    color: var(--text-secondary);
    font-style: italic;
    text-align: center;
    padding: 2rem 1rem;
  }

  .study-preview-text {
    font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.925rem;
    line-height: 1.6;
    white-space: pre-wrap;
    color: var(--text);
  }
  
  /* Primary Action */
  .primary-action {
    text-align: center;
    margin: 3rem 0;
  }
  
  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.125rem 2.5rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #d946ef 100%);
    background-size: 200% 200%;
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 1.125rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 8px 24px rgba(124,58,237,0.3);
    position: relative;
    overflow: hidden;
    letter-spacing: -0.01em;
  }
  
  .btn-primary::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
  }
  
  .btn-primary:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 16px 40px rgba(124,58,237,0.45);
    background: linear-gradient(135deg, #6d28d9 0%, #9333ea 50%, #c026d3 100%);
    background-position: 100% 50%;
  }
  
  .btn-primary:active {
    transform: translateY(-2px) scale(0.98);
  }
  
  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  .btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.875rem 1.75rem;
    background: white;
    color: var(--text);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: -0.01em;
  }
  
  .btn-secondary:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }
  
  .btn-secondary:active {
    transform: translateY(-1px);
  }
  
  /* Advanced Options (Collapsible) */
  .advanced-options {
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    overflow: hidden;
    animation: fadeInUp 0.8s ease-out 0.5s both;
  }
  
  .advanced-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 2rem;
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
    transition: all 0.3s;
  }
  
  .advanced-header:hover {
    background: linear-gradient(135deg, rgba(224,0,27,0.02) 0%, transparent 100%);
  }
  
  .advanced-title {
    font-weight: 700;
    font-size: 1.25rem;
    letter-spacing: -0.02em;
  }
  
  .advanced-toggle {
    color: var(--text-secondary);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    font-size: 1.25rem;
  }
  
  .advanced-toggle.open {
    transform: rotate(180deg);
  }
  
  .advanced-content {
    display: none;
    padding: 0 2rem 2rem;
    border-top: 1px solid var(--border);
  }
  
  .advanced-content.open {
    display: block;
    animation: fadeInUp 0.4s ease-out;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
  }

  /* Quiz maker two-row alignment (stable across screen sizes) */
  .form-grid.align-end { align-items: end; }

  /* Row 2: make right column a fixed action cell; left column flexible */
  .quiz-grid { grid-template-columns: 1fr 320px; }
  .quiz-grid .actions {
    display: flex;
    flex-direction: column;
    justify-content: flex-end;
    align-items: flex-end;
    gap: 0.75rem;
    height: 100%;
  }
  .quiz-grid .actions .btn-primary { min-width: 260px; }
  .feedback-note {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    text-align: right;
    margin-top: 0.5rem;
  }

  /* Responsive: stack cleanly and keep full-width button */
  @media (max-width: 1100px) {
    .quiz-grid { grid-template-columns: 1fr; }
    .quiz-grid .actions { align-items: stretch; }
    .quiz-grid .actions .btn-primary { width: 100%; min-width: 0; }
    .feedback-note { text-align: left; }
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .form-label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.01em;
  }
  
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    padding: 0.875rem 1rem;
    border: 2px solid var(--border);
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    background: white;
  }
  
  input:hover,
  select:hover,
  textarea:hover {
    border-color: var(--text-tertiary);
  }
  
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(224,0,27,0.08);
    transform: translateY(-2px);
  }
  
  textarea {
    resize: vertical;
    min-height: 120px;
  }
  
  .chip-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.75rem;
  }
  
  .chip {
    padding: 0.625rem 1.125rem;
    background: white;
    border: 2px solid var(--border);
    border-radius: 999px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: -0.01em;
    position: relative;
    overflow: hidden;
  }
  
  .chip::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gradient-qub);
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 0;
  }
  
  .chip:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }
  
  .chip:hover::before {
    opacity: 0.05;
  }
  
  .chip.active {
    background: var(--gradient-qub);
    color: white !important;
    border-color: transparent;
    box-shadow: 0 6px 20px rgba(224,0,27,0.25);
    transform: translateY(-2px);
    position: relative;
    z-index: 2;
  }
  
  .chip.active::before {
    opacity: 1;
    z-index: -1;
  }
  
  .chip > * {
    position: relative;
    z-index: 3;
    color: inherit;
  }
  
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  /* Preview Section */
  .preview-section {
    background: white;
    border-radius: var(--radius-xl);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
    animation: fadeInUp 0.8s ease-out 0.6s both;
    position: relative;
    overflow: hidden;
  }
  
  .preview-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: var(--gradient-qub);
  }
  
  .preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-top: 0.5rem;
  }
  
  .preview-stats {
    display: flex;
    align-items: center;
    gap: 2rem;
    font-size: 0.9375rem;
    color: var(--text-secondary);
  }
  
  .stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .stat-value {
    font-weight: 700;
    color: var(--text);
    font-size: 1.125rem;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--success-gradient);
    color: white;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(52,199,89,0.25);
    letter-spacing: -0.01em;
  }
  
  .status-badge.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #ffa726 100%);
    box-shadow: 0 4px 12px rgba(255,149,0,0.25);
  }
  
  .status-badge.danger {
    background: linear-gradient(135deg, var(--danger) 0%, #ff6b6b 100%);
    box-shadow: 0 4px 12px rgba(255,59,48,0.25);
  }
  
  .preview-box {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    max-height: 500px;
    overflow-y: auto;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
    position: relative;
  }
  
  .preview-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--gradient-qub);
    opacity: 0.3;
  }
  
  .preview-text {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;
    font-size: 0.9375rem;
    line-height: 1.7;
    white-space: pre-wrap;
    color: var(--text);
    font-weight: 500;
  }
  
  .preview-placeholder {
    text-align: center;
    padding: 4rem 1rem;
    color: var(--text-secondary);
  }
  
  .preview-placeholder-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.3;
    animation: float 3s ease-in-out infinite;
  }
  
  /* Progress Bar */
  .progress-bar {
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 999px;
    margin: 1.5rem 0;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
  }
  
  .progress-fill {
    height: 100%;
    background: var(--success-gradient);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 999px;
    box-shadow: 0 0 12px rgba(52,199,89,0.4);
  }
  
  .progress-fill.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #ffa726 100%);
    box-shadow: 0 0 12px rgba(255,149,0,0.4);
  }
  
  .progress-fill.danger {
    background: var(--danger);
  }
  
  /* Toast */
  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%);
    color: white;
    padding: 1.25rem 2rem;
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    transform: translateY(150%) scale(0.9);
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
    z-index: 10000;
    opacity: 0;
    font-weight: 600;
    letter-spacing: -0.01em;
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
  }
  
  .toast.show {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  
  .toast::before {
    content: '‚úì';
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--success-gradient);
    border-radius: 50%;
    font-size: 16px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(52,199,89,0.4);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .hero h2 {
      font-size: 2.5rem;
    }
    
    .preset-cards {
      grid-template-columns: 1fr;
    }
    
    .workflow-selector {
      flex-direction: column;
      width: 100%;
    }
    
    .header-content {
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .toast {
      left: 1rem;
      right: 1rem;
      bottom: 1rem;
    }
  }
  
  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }
  
  ::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: 999px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--border) 0%, var(--text-tertiary) 100%);
    border-radius: 999px;
    border: 3px solid var(--bg-tertiary);
    transition: background 0.3s;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--text-tertiary) 0%, var(--text-secondary) 100%);
  }
  
  /* Hidden */
  .hidden {
    display: none !important;
  }
  
  /* Utility classes */
  .w-100 {
    width: 100%;
  }
  
  .min-h-200 {
    min-height: 200px;
  }
  
  .mt-1half {
    margin-top: 1.5rem;
  }
  
  /* Radio group styles */
  .radio-group {
    display: flex;
    gap: 1.25rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .radio-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: color 0.2s;
  }
  
  .radio-group label:hover {
    color: var(--primary);
  }
  
  .radio-group input[type="radio"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary);
    cursor: pointer;
  }
  
  /* Muted text */
  .muted {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-top: 0.75rem;
  }
  
  /* Help text */
  .help {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
    margin-top: 0.5rem;
  }
  
  /* Helper message */
  .helper-message {
    background: linear-gradient(135deg, rgba(224,0,27,0.05) 0%, rgba(224,0,27,0.02) 100%);
    border-left: 4px solid var(--primary);
    padding: 1.25rem 1.5rem;
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    box-shadow: 0 4px 12px rgba(224,0,27,0.08);
  }
  
  .helper-message-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
    color: var(--primary);
  }
  
  .helper-message-text {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: var(--text);
  }
  
  .helper-message-text strong {
    font-weight: 700;
    color: var(--text);
  }
  
  /* Preview actions row */
  .preview-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  
  /* Utility classes additions */
  .centered {
    margin-left: auto;
    margin-right: auto;
  }
  
  .align-center {
    text-align: center;
  }
  
  .help {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  
  .kb {
    font-size: 0.8125rem;
    line-height: 1.45;
  }
  
  .tooltip {
    border-bottom: 1px dotted #8aa;
    cursor: help;
  }
  
  .row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  fieldset {
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1.75rem 2rem;
    margin-bottom: 2rem;
    background: white;
    box-shadow: var(--shadow);
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  fieldset:hover {
    border-color: var(--text-tertiary);
    box-shadow: var(--shadow-md);
  }
  
  legend {
    font-weight: 700;
    padding: 0 0.75rem;
    color: var(--text);
    font-size: 1.125rem;
    letter-spacing: -0.01em;
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    color: var(--text);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    letter-spacing: -0.01em;
  }
  
  .btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  /* FAQ Section */
  .faq-section {
    max-width: 1200px;
    margin: 6rem auto 4rem;
    padding: 0 2rem;
    animation: fadeInUp 0.8s ease-out 0.7s both;
  }
  
  .gradient-title {
    font-size: 3.5rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 3rem;
    letter-spacing: -0.03em;
    line-height: 1.1;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 25%, #d946ef 50%, #ec4899 75%, #f43f5e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    background-size: 200% auto;
    animation: gradientShift 8s ease infinite;
  }
  
  .faq-title {
    font-size: 3.5rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 3rem;
    letter-spacing: -0.03em;
    line-height: 1.1;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 25%, #d946ef 50%, #ec4899 75%, #f43f5e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    background-size: 200% auto;
    animation: gradientShift 8s ease infinite;
  }
  
  .faq-items {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  
  .faq-item {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .faq-item:hover {
    box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    transform: translateY(-4px);
  }
  
  .faq-question {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.75rem 2rem;
    cursor: pointer;
    background: white;
    transition: all 0.3s;
    -webkit-user-select: none;
    user-select: none;
    gap: 1.5rem;
  }
  
  .faq-question:hover {
    background: linear-gradient(135deg, rgba(224,0,27,0.02) 0%, transparent 100%);
  }
  
  .faq-question-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.01em;
    line-height: 1.5;
    flex: 1;
  }
  
  .faq-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    font-size: 1.25rem;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .faq-item.open .faq-icon {
    transform: rotate(180deg);
    background: var(--gradient-qub);
    color: white;
    box-shadow: 0 4px 12px rgba(224,0,27,0.25);
  }
  
  .faq-answer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), padding 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0 2rem;
  }
  
  .faq-item.open .faq-answer {
    max-height: 1000px;
    padding: 0 2rem 2rem;
  }
  
  .faq-answer-text {
    font-size: 1rem;
    line-height: 1.75;
    color: var(--text-secondary);
    padding-top: 0.5rem;
    border-top: 2px solid var(--bg-tertiary);
  }
  
  .faq-answer-text strong {
    color: var(--text);
    font-weight: 600;
  }
  
  .faq-answer-text ul {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }
  
  .faq-answer-text li {
    margin-bottom: 0.5rem;
  }
</style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="brand">
      <img src="qub-logo.png" alt="Queen's University Belfast" />
      <h1>Prompt Builder</h1>
    </div>
    
    <div class="workflow-selector">
      <button class="workflow-btn active" data-tab="help" onclick="switchWorkflow('help')">Getting Started</button>
      <button class="workflow-btn" data-tab="quiz" onclick="switchWorkflow('quiz')">Canvas Quiz</button>
      <button class="workflow-btn" data-tab="study" onclick="switchWorkflow('study')">Study Guide</button>
      <button class="workflow-btn" data-tab="notes" onclick="switchWorkflow('notes')">From Notes</button>
    </div>
  </div>
</header>

<!-- Hero Banner -->
<div class="hero-banner help-hero" id="heroBanner">
  <div class="hero-content">
    <div class="hero-badge">
      <span>üß≠</span>
      <span id="heroBadgeText">Getting Started</span>
    </div>
    <h1 class="hero-title" id="heroTitle">Welcome to Prompt Builder</h1>
    <p class="hero-subtitle" id="heroSubtitle">Your guide to generating QUB-aligned quizzes, study guides, and note-based resources in minutes</p>
  </div>
</div>

<main>
  <!-- Help Info Boxes (Hidden by default) -->
  <div class="info" id="about">
    <div class="section-title">
      <strong>About this tool</strong>
      <button class="btn" id="dismissAbout" title="Hide this message">‚úï</button>
    </div>
    <p class="kb">Choose a pedagogy approach, customise your settings, then paste the prompt into the Copilot sidebar with your Panopto lecture open. Copilot reads your captions/slides and produces a Canvas-ready QTI zip and a lecturer PDF, using only your materials.</p>
  </div>
  
  <!-- Quiz Workflow -->
  <div class="workflow-content quiz-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Canvas Quiz Maker</h2>
    
    <div class="info" id="preflight">
      <div class="section-title">
        <strong>‚ö° Panopto Preflight (1 minute)</strong>
        <button class="btn" id="hidePreflight" title="Hide this checklist">‚úï</button>
        </div>
      <ol class="kb" style="margin-top: 0.75rem; padding-left: 1.5rem;">
        <li style="margin-bottom: 0.5rem;">Open the full Panopto <em>Watch</em> page (not the small Canvas embed).</li>
        <li style="margin-bottom: 0.5rem;">Open <em>Captions</em> and <em>Contents/Slides</em> panels.</li>
        <li style="margin-bottom: 0.5rem;">Scroll the transcript to the bottom once (loads all captions).</li>
        <li>Open Copilot and enable <em>Use page content</em>/<em>Allow this page</em>.</li>
      </ol>
    </div>
    
    <!-- Customise Options (Now at Top) -->
    <div class="advanced-options" style="margin-bottom: 2rem;">
      <div class="advanced-header" id="advancedToggle">
        <span class="advanced-title">Customise Options</span>
        <span class="advanced-toggle open">‚ñº</span>
      </div>
      <div class="advanced-content open" id="advancedContent">
        <!-- ROW 1: Pedagogy preset + Questions per type -->
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Pedagogy Preset</label>
            <select id="pedagogy" title="Sets tone and question style across disciplines.">
              <option>Concept Check (Retrieval)</option>
              <option>Worked Examples (Scaffolded)</option>
              <option>Case/Scenario-Based</option>
              <option>Debate / Critical Analysis</option>
              <option>Metacognitive Reflection</option>
              <option>Accessibility-First (UDL)</option>
            </select>
            <p class="help" id="pedBrief"></p>
          </div>

          <div class="form-group">
            <label class="form-label" for="quizCount">Questions per type</label>
            <input type="number" id="quizCount" min="1" max="12" value="3" title="How many items to generate for each selected question type.">
          </div>
        </div>

        <!-- ROW 2: Question types + Build & Copy button -->
        <div class="form-grid align-end quiz-grid">
          <div class="form-group">
            <label class="form-label">Question Types</label>
            <div class="chip-group" id="questionTypes"></div>
            <p class="help">Allowed types: Multiple Choice, Multiple Answers, True/False, Short Answer, Essay, Numerical.</p>
          </div>

          <div class="form-group actions">
            <button class="btn-primary" id="generateQuiz" onclick="copyPrompt();">
              üõ†Ô∏è Build &amp; Copy Prompt
            </button>
            <p class="feedback-note">Detailed feedback is included by default.</p>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Canvas How-To (Quiz Only) -->
    <div class="info" id="canvasHow">
      <div class="section-title">
        <strong>Using this in Canvas (New or Classic Quizzes)</strong>
        <button class="btn" id="hideCanvasHow" title="Hide instructions">‚úï</button>
        </div>
      <ol class="kb" style="margin-top: 1rem; padding-left: 1.5rem;">
        <li style="margin-bottom: 0.5rem;">Complete the Panopto preflight steps above (open Watch page, captions/slides panels, scroll transcript).</li>
        <li style="margin-bottom: 0.5rem;">Copy the prompt (button above) and paste it into Copilot sidebar. It will produce:
          <ul style="margin-top: 0.25rem; padding-left: 1.5rem;"><li>A QTI <code>.zip</code> for Canvas</li><li>A lecturer PDF</li></ul>
        </li>
        <li style="margin-bottom: 0.5rem;"><strong>Import to Canvas:</strong> In your course, go to <strong>Settings ‚Üí Import Course Content ‚Üí Content Type: QTI .zip file</strong>. Choose the downloaded ZIP and click <strong>Import</strong>.</li>
        <li style="margin-bottom: 0.5rem;">After import, check <strong>Quizzes</strong> (or <strong>Assignments</strong> for New Quizzes). If you only see an item bank, the importer auto-rewrote items‚Äîopen the bank and build a quiz from it.</li>
        <li>Review points, feedback, and availability dates; then publish.</li>
      </ol>
      <p class="help" style="margin-top: 0.75rem;"><strong>Note:</strong> If Copilot returns "INSUFFICIENT_PAGE_CONTENT", go back and ensure captions/contents panels are fully expanded and loaded.</p>
      <p class="help" style="margin-top: 0.75rem;">
        <strong>About feedback in QTI:</strong> The package embeds general item feedback in each question using the QTI
        <code>&lt;itemfeedback ident="fb"&gt;</code> plus a <code>&lt;displayfeedback linkrefid="fb"&gt;</code> reference.
        Canvas shows this after submission if your quiz settings allow it. We include it because it explains the reasoning with a timestamp back to your lecture, supports retrieval practice with specific guidance, and saves time compared with writing feedback in Canvas.
      </p>
      </div>
    </div>
  </div>
    
  <!-- Study Guide Workflow -->
  <div class="workflow-content study-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Study Guide Builder</h2>

    <!-- Study Guide Quick Intro (no customiser) -->
    <div class="helper-message" style="margin-top: 0.5rem; margin-bottom: 1.5rem;">
      <div class="helper-message-icon">üß≠</div>
      <div class="helper-message-text">
        <strong>Pick a Study Guide Tool below</strong> ‚Äî each card contains a complete, QUB‚Äëaligned prompt. Click <em>Copy Prompt</em>, paste into Copilot with your Panopto <em>Watch</em> page open, and it will auto‚Äëscroll captions &amp; slides, extract evidence, and generate a Word file.
      </div>
    </div>

    <!-- Five Study Tools (Glasmorphic Cards) -->
    <div class="quick-start" id="studyToolsDeck" style="margin-top:1.5rem;">
      <div class="section-title">
        <span>Study Guide Tools</span>
        <span class="help">Pick a tool and copy its pre-built prompt to Copilot</span>
      </div>
      <div class="preset-cards study-tools-grid" id="studyToolsGrid">
        <!-- Cards populated by JS -->
      </div>
    </div>
  </div>
  
  <!-- From Notes Workflow -->
  <div class="workflow-content notes-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Build From Your Notes</h2>
    
    <!-- Notes Input -->
    <div class="quick-start">
      <div class="section-title">Paste your notes</div>
      <textarea id="notesInput" placeholder="Paste your lecture notes here (plain text, headings, bullets)..." class="w-100 min-h-200"></textarea>
      <p class="help">Aim for 400‚Äì2000 words. Keep headings and key ideas ‚Äî we'll combine your notes with the selected tool and ensure the prompt stays under 8000 characters.</p>
    </div>

    <div class="helper-message" style="margin-bottom: 1.5rem;">
      <div class="helper-message-icon">üóÇÔ∏è</div>
      <div class="helper-message-text">
        <strong>Select a Notes Tool</strong> ‚Äî each card wraps your pasted notes in a ready-to-copy prompt. 
      </div>
    </div>

    <div class="quick-start" id="notesToolsDeck" style="margin-top:1rem;">
      <div class="section-title">
        <span>Notes Tools</span>
        <span class="help">Choose an output style, then copy the prompt.</span>
      </div>
      <div class="preset-cards study-tools-grid" id="notesToolsGrid">
        <!-- Cards populated by JS -->
      </div>
    </div>
  </div>
  
  
  <!-- Help/Getting Started Workflow -->
  <div class="workflow-content help-workflow">
    <h2 class="gradient-title" style="margin-top: 0;">Getting Started with Prompt Builder</h2>
    
    <div class="quick-start" style="margin-bottom: 4rem; padding: 3rem;">
      <h3 style="font-size: 1.75rem; margin-bottom: 1.5rem; color: var(--text);">Quick Start Guide</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(147,51,234,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #3b82f6; box-shadow: 0 4px 20px rgba(59,130,246,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üé•</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Open Your Panopto Video</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Navigate to your Panopto Watch page (not the Canvas embed). Ensure captions and slides panels are open and scroll through the transcript once.</p>
        </div>
        
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(168,85,247,0.1) 0%, rgba(236,72,153,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #a855f7; box-shadow: 0 4px 20px rgba(168,85,247,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚öôÔ∏è</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Customise Your Settings</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Choose your pedagogy preset and question types. Detailed feedback is included by default. The prompt updates automatically as you make changes.</p>
        </div>
        
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(236,72,153,0.1) 0%, rgba(244,63,94,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #ec4899; box-shadow: 0 4px 20px rgba(236,72,153,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚ú®</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Copy & Paste to Copilot</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Click "Copy Prompt" and paste it into Microsoft Copilot's sidebar. Copilot will read your Panopto page and generate your quiz or study guide!</p>
        </div>
      </div>
    </div>
    
    <h2 class="faq-title">Frequently Asked Questions</h2>
    
    <div class="faq-items">
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">How do I use the Prompt Builder with Panopto?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p><strong>Step-by-step (about 2 minutes):</strong></p>
            <ol>
              <li>Open your Panopto <em>Watch</em> page in a browser tab (avoid the small Canvas embed).</li>
              <li>Open the <strong>Captions/Transcript</strong> panel and the <strong>Contents/Slides</strong> panel. Scroll through the transcript once so all captions load.</li>
              <li>Open <strong>Microsoft Copilot</strong> in the sidebar and allow it to "Use page content".</li>
              <li>In Prompt Builder, choose your <strong>Pedagogy preset</strong> and select your <strong>question types</strong>. Detailed feedback is included by default; no toggle needed.</li>
              <li>Click <strong>Copy Prompt</strong> and paste it into Copilot. It will read <em>only</em> your Panopto page (captions + slides) and generate the requested files.</li>
            </ol>
            <p class="help">Tip: If Copilot returns <code>INSUFFICIENT_PAGE_CONTENT</code>, reload the Panopto page, open both panels, scroll to the bottom of the transcript, and try again.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">What outputs does the Prompt Builder create?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <ul>
              <li><strong>Canvas Quiz package (QTI .zip):</strong> Standards‚Äëcompliant file that imports into Canvas (New or Classic Quizzes). Includes question stems, options, scoring, and optional per‚Äëchoice feedback.</li>
              <li><strong>Lecturer PDF (quiz version):</strong> One page per question with the answer key and concise teaching notes to help during delivery.</li>
              <li><strong>Study Guide / Notes Pack:</strong> A pedagogy‚Äëfirst resource (PDF, Word, or PPTX) containing an executive summary, learning outcomes, key concepts, worked examples or cases, a problem set with solutions, 20‚Äì40 flashcards, reflection prompts and (optionally) a two‚Äëweek study planner.</li>
            </ul>
            <p class="help">All outputs are created from your lecture materials only‚Äîno external sources are introduced.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">What are pedagogy presets and how do I choose one?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p>Presets shape the <strong>tone, structure and feedback style</strong> of what is generated, aligned with Queen's <em>Beyond Blended</em> approach:</p>
            <ul>
              <li><strong>Concept Check (Retrieval):</strong> Short, focused questions that probe essential ideas and common misconceptions.</li>
              <li><strong>Worked Examples (Scaffolded):</strong> Step‚Äëby‚Äëstep reasoning with "why this step" notes and common slips.</li>
              <li><strong>Case/Scenario‚ÄëBased:</strong> Realistic vignettes that ask students to apply ideas; one answer is most defensible from the lecture.</li>
              <li><strong>Debate / Critical Analysis:</strong> Contrast positions and justify the preferred option using evidence from slides/captions.</li>
              <li><strong>Metacognitive Reflection:</strong> Prompts that surface process, limits and next steps (great for short‚Äëanswer / essay).</li>
              <li><strong>Accessibility‚ÄëFirst (UDL):</strong> Plain UK English, clear structure, and inclusive phrasing; avoids jargon and culture‚Äëbound idioms.</li>
            </ul>
            <p class="help">Choose the preset that matches your intended learning outcome. You can still edit the prompt details before copying.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">How do I import the quiz into Canvas?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <ol>
              <li>In your Canvas course go to <strong>Settings ‚Üí Import Course Content</strong>.</li>
              <li>Set <strong>Content Type</strong> to <strong>QTI .zip file</strong>, choose the downloaded file (e.g., <code>Lecture_5_‚Ä¶_quiz_qti.zip</code>) and click <strong>Import</strong>.</li>
              <li>After processing, check <strong>Quizzes</strong>. For New Quizzes, the item also appears in <strong>Assignments</strong>.</li>
              <li>If you only see an <strong>Item Bank</strong>, open it and build a quiz from those questions‚ÄîCanvas sometimes does this automatically.</li>
              <li>Open the quiz to review points, availability, and <strong>Student Feedback</strong> settings; then <strong>Publish</strong>.</li>
            </ol>
            <p class="help">Troubleshooting: If Canvas shows "No question type used‚Ä¶", the QTI was malformed. Regenerate using this tool's latest prompt and ensure only Canvas‚Äësupported types are selected.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">Can I customize the generated content?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p><strong>Yes.</strong> The app lets you tailor:</p>
            <ul>
              <li><strong>Question types & counts:</strong> Start with Multiple Choice, then add others as needed.</li>
              <li><strong>Feedback:</strong> Detailed feedback is included in the QTI by default (see "About feedback" below). You can control student visibility in Canvas after import.</li>
              <li><strong>Pedagogy preset:</strong> Sets style, depth and feedback tone.</li>
              <li><strong>Study Guide components:</strong> Toggle concept map, glossary, worked examples, cases, problem set, flashcards, reflections and planner.</li>
              <li><strong>Output format:</strong> PDF/Word/PPTX for study guides; QTI + PDF for quizzes.</li>
            </ul>
            <p class="help">Everything generated is editable: you can revise wording in the PDF/Word/PPTX and change quiz settings in Canvas.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">Is my content secure and private?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p>This tool runs entirely in your browser and only creates a <em>prompt</em>. Your materials are not uploaded to our servers. When you paste the prompt into Microsoft Copilot, your data is handled under Microsoft's terms and your institutional account settings.</p>
            <ul>
              <li>The prompt instructs Copilot to use <strong>only</strong> your Panopto captions/slides or notes and to avoid external sources.</li>
              <li>No student data is processed.</li>
              <li>Generated files are saved locally by you.</li>
            </ul>
            <p class="help"><strong>Disclaimer:</strong> We aim for accuracy and accessibility, but AI outputs can contain errors or omissions. Always review before sharing with students. If you spot an issue, regenerate or edit the output.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <footer style="max-width:1400px;margin:3rem auto 2rem;padding:1.5rem 2rem;border-top:2px solid var(--border);text-align:center;color:var(--text-secondary);">
    <p style="margin-bottom:0.5rem;"><strong>Teaching & Training Unit ‚Äì D&IS, Queen's University Belfast</strong></p>
    <p style="margin-bottom:0.5rem;">Patrick Phillips ‚Ä¢ Support & enquiries: <a href="mailto:p.phillips@qub.ac.uk" style="color:inherit; text-decoration:underline;">p.phillips@qub.ac.uk</a></p>
    <p style="font-size:0.875rem;">We strive to create high‚Äëquality resources aligned with Queen's pedagogy. However, AI‚Äëgenerated content may contain inaccuracies. Always review outputs for accuracy, inclusivity and accessibility before use.</p>
  </footer>
</main>

<!-- Help Button -->
<button class="help-toggle" id="helpToggle">
  <span class="help-toggle-icon">?</span>
  <span>Need Help?</span>
</button>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <span>‚úì</span>
  <span>Prompt copied to clipboard!</span>
</div>

<script>
function exposePanoptoTranscriptForCopilot() {
  try {
    // Gather candidate text fragments
    const nodes = document.querySelectorAll('.transcript * , .caption, .caption-text, [class*="transcript"] span, [class*="caption"] span');
    const texts = Array.from(nodes).map(n => (n.innerText || '').trim()).filter(Boolean);
    const full = texts.join(' ').replace(/\s+/g, ' ').trim();
    // Only expose if sufficiently long and not already present
    if (full.length > 300 && !document.getElementById('copilot-visible-transcript')) {
      const helper = document.createElement('div');
      helper.id = 'copilot-visible-transcript';
      helper.textContent = full;
      helper.style.cssText = 'position:fixed;left:-99999px;top:-99999px;white-space:pre-wrap;visibility:visible;height:auto;width:1px;';
      document.body.appendChild(helper);
    }
  } catch(e) {
    console.warn('Transcript expose failed:', e);
  }
}
</script>
<script>
// Make Panopto transcript text visible to Copilot's DOM reader (no UI impact)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', exposePanoptoTranscriptForCopilot);
} else {
  exposePanoptoTranscriptForCopilot();
}
// Pedagogy presets (QUB-aligned)
const PEDAGOGY = {
  "Concept Check (Retrieval)": {
    brief: "Quick checks of core ideas. Tight stems, one clearly best answer, and distractors based on likely misunderstandings.",
    inject: [
      "Use retrieval-practice style questions that check essential concepts from the lecture.",
      "Distractors must reflect plausible misunderstandings taken from the lecture wording only.",
      "Brief feedback explains the correct idea and points to a timestamp if detectable."
    ]
  },
  "Worked Examples (Scaffolded)": {
    brief: "Step-by-step problem solving with hints that fade. Great for methods and processes.",
    inject: [
      "Prefer worked-example prompts with ordered steps.",
      "Add a short 'why this step' note; in detailed feedback include 'common slip' guidance."
    ]
  },
  "Case/Scenario-Based": {
    brief: "Apply the lecture ideas to realistic situations; one answer is most defensible from the material.",
    inject: [
      "Frame items as short scenarios derived strictly from lecture captions/slides.",
      "Provide one best answer; others can be reasonable but less supported."
    ]
  },
  "Debate / Critical Analysis": {
    brief: "Compare viewpoints; justify the preferred answer with evidence from the lecture.",
    inject: [
      "Pose contrastive options; mark the one most defensible by the lecture evidence.",
      "Feedback references the relevant slide/timestamp where possible."
    ]
  },
  "Metacognitive Reflection": {
    brief: "Students reflect on process, limits, and next steps. Good as SA/Essay.",
    inject: [
      "Include prompts that ask students to explain approach and next steps tied to outcomes.",
      "Prefer short-answer or essay for depth where MC is weak."
    ]
  },
  "Accessibility-First (UDL)": {
    brief: "Plain UK English, inclusive phrasing, and multiple means of representation.",
    inject: [
      "Ensure each item stands alone without images; suggest alt text when PDF is generated.",
      "Avoid idioms and culturally specific references."
    ]
  }
};

// State
let state = {
  workflow: 'help',
  pedagogy: 'Concept Check (Retrieval)',
  quizTitle: '',
  quizLang: 'en-GB',
  quizCount: 3,
  quizFeedback: 'detailed',
  questionTypes: ['multiple_choice_question'],
  notesInput: '',
  studyFormat: 'word'
};

const QUESTION_TYPES = [
  { id: 'multiple_choice_question', label: 'Multiple Choice' },
  { id: 'multiple_answers_question', label: 'Multiple Answers' },
  { id: 'true_false_question', label: 'True/False' },
  { id: 'short_answer_question', label: 'Short Answer' },
  { id: 'essay_question', label: 'Essay' },
  { id: 'numerical_question', label: 'Numerical' }
];

const TYPE_LABEL = {
  multiple_choice_question: 'Multiple Choice',
  multiple_answers_question: 'Multiple Answers',
  true_false_question: 'True/False',
  short_answer_question: 'Short Answer',
  essay_question: 'Essay',
  numerical_question: 'Numerical'
};

function getSelectedTypes() {
  const arr = Array.isArray(state.questionTypes) ? state.questionTypes.filter(Boolean) : [];
  return arr.length ? arr : ['multiple_choice_question'];
}

function getQuizCount() {
  let n = parseInt(state.quizCount, 10);
  if (Number.isNaN(n)) n = 3;
  if (n < 1) n = 1;
  if (n > 12) n = 12;
  return n;
}

function getPedagogy() {
  return state.pedagogy || 'Concept Check (Retrieval)';
}

function selectedTypesList() {
  return getSelectedTypes().map(t => TYPE_LABEL[t] || t).join(', ');
}

/* ---------- Initialisation: mount chips once DOM is ready ---------- */
document.addEventListener('DOMContentLoaded', () => {
  try {
    mountStudyToolCards();
    mountNotesToolCards();
  } catch (e) {
    console.warn('Tool deck init failed:', e);
  }
});

function updatePedBrief() {
  const sel = document.getElementById('pedagogy');
  const key = sel && sel.value ? sel.value : 'Concept Check (Retrieval)';
  const brief = (PEDAGOGY[key] && PEDAGOGY[key].brief) || '';
  const el = document.getElementById('pedBrief');
  if (el) el.textContent = brief;
}
document.addEventListener('DOMContentLoaded', () => {
  const sel = document.getElementById('pedagogy');
  if (sel) {
    updatePedBrief();
    sel.addEventListener('change', () => {
      state.pedagogy = sel.value;
      updatePedBrief();
      if (typeof render === 'function') render();
    });
  }
});

// DOM helpers
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);

// Hero content for each workflow page
const heroContent = {
  help: {
    badge: 'Getting Started',
    title: 'Welcome to Prompt Builder',
    subtitle: 'Your guide to generating QUB-aligned quizzes and study resources in minutes',
    class: 'help-hero'
  },
  quiz: {
    badge: 'Canvas Quiz Builder',
    title: 'Create Perfect Quizzes in Seconds',
    subtitle: 'Transform your Panopto lectures into Canvas-ready quizzes with AI‚Äîaligned with Queen\'s Beyond Blended pedagogy',
    class: 'quiz-hero'
  },
  study: {
    badge: 'Study Guide Generator',
    title: 'Build Comprehensive Study Resources',
    subtitle: 'Generate rich, pedagogy-first study guides with flashcards, problems, and reflections from your lectures',
    class: 'study-hero'
  },
  notes: {
    badge: 'Notes to Resources',
    title: 'Transform Notes into Study Packs',
    subtitle: 'Convert your lecture notes into structured, student-ready study materials with expert guidance',
    class: 'notes-hero'
  },
};

// switchWorkflow function - must be global for inline onclick handlers
window.switchWorkflow = function(tab) {
  console.log('switchWorkflow called with tab:', tab);
  if (!tab) return;
  
  // Update active state
  $$('.workflow-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.querySelector('[data-tab="' + tab + '"]');
  if (activeBtn) activeBtn.classList.add('active');
  if (typeof state !== 'undefined') state.workflow = tab;

  // Toggle content visibility
  $$('.workflow-content').forEach(w => w.classList.add('hidden'));
  const target = document.querySelector('.' + tab + '-workflow');
  console.log('Target element for', tab + '-workflow:', target);
  if (target) {
    target.classList.remove('hidden');
    console.log('Successfully switched to', tab, 'workflow');
  } else {
    console.error('Could not find element with class', tab + '-workflow');
  }

  // Update hero banner
  const hero = heroContent[tab];
  if (hero) {
    const heroBanner = $('heroBanner');
    if (heroBanner) {
      heroBanner.className = 'hero-banner ' + hero.class;
      if ($('heroBadgeText')) $('heroBadgeText').textContent = hero.badge;
      if ($('heroTitle')) $('heroTitle').textContent = hero.title;
      if ($('heroSubtitle')) $('heroSubtitle').textContent = hero.subtitle;
    }
  }

  if (tab === 'study') {
    setTimeout(() => {
      try {
        if (typeof mountStudyToolCards === 'function') mountStudyToolCards();
      } catch (e) {
        console.warn('Study tools deck failed:', e);
      }
    }, 0);
  } else if (tab === 'notes') {
    setTimeout(() => {
      try {
        if (typeof mountNotesToolCards === 'function') mountNotesToolCards();
      } catch (e) {
        console.warn('Notes tools deck failed:', e);
      }
    }, 0);
  }

  // Show/hide preview section
  const previewSection = $('previewSection');
  if (previewSection) previewSection.style.display = (tab === 'help' || tab === 'study' || tab === 'notes') ? 'none' : 'block';

  const studyPanel = $('studyPreviewPanel');
  if (studyPanel && typeof setStudyPreview === 'function') {
    if (tab === 'study') {
      studyPanel.classList.remove('hidden');
      setStudyPreview('', '');
    } else {
      studyPanel.classList.add('hidden');
    }
  }

  const notesPanel = $('notesPreviewPanel');
  if (notesPanel) {
    if (tab === 'notes') {
      notesPanel.classList.remove('hidden');
    } else {
      notesPanel.classList.add('hidden');
    }
  }

  // Re-setup FAQ when switching to help page
  if (tab === 'help') {
    setTimeout(() => {
      if (typeof setupFaqAccordion === 'function') setupFaqAccordion();
    }, 0);
  } else if (tab !== 'study' && tab !== 'notes') {
    if (typeof render === 'function') render();
  }
};

// Detect Panopto title (enhanced)
function detectPanoptoTitle() {
  const og = document.querySelector('meta[property="og:title"]')?.content?.trim();
  const data = document.querySelector('[data-role="session-title"], .session-title, .video-title')?.textContent?.trim();
  const doc = document.title?.trim();
  return og || data || doc || '';
}

const panoptoTitle = detectPanoptoTitle();

function slugify(s) {
  const a = (s || '').normalize('NFKD').replace(/[^\x00-\x7F]/g, '');
  return (a.replace(/[^A-Za-z0-9]+/g, '_').replace(/_+/g, '_').replace(/^_+|_+$/g, '') || 'Lecture_Quiz');
}

// Panopto source block (ultra-compact)
const PANOPTO_BLOCK = `SRC: Panopto Watch pg. Open+scroll Captions/Slides to bottom. DOM only. Real title from og:title|session-title|doc.title (never "Lecture Quiz"). FAIL if <300 words: "INSUFFICIENT_PAGE_CONTENT"`;

// Prompt builders
function buildQuizPrompt() {
  const title = panoptoTitle || 'Lecture Quiz';
  const slug = slugify(title);
  const count = getQuizCount();
  const types = getSelectedTypes();
  const target = types.length * count;
  const pedagogyKey = getPedagogy();
  const ped = PEDAGOGY[pedagogyKey] || PEDAGOGY["Concept Check (Retrieval)"];
  const pedBlock = ped.inject.map(l => `‚Ä¢ ${l}`).join(' ');
  const typesList = selectedTypesList();
  
  return `SYS: ${slug}_quiz_qti.zip + .pdf | Lang=${state.quizLang} | Panopto pg only
${PANOPTO_BLOCK}
PED: ${pedBlock}
HE: Clear stems, plausible distractors, feedback+TS, Bloom mix | ${count}/type (${typesList}) = ${target} total

QTI: imsmanifest.xml=<manifest id="m1" xmlns="http://www.imsglobal.org/xsd/imscp_v1p1"><resources><resource id="r1" type="imsqti_xmlv1p2" href="assessment.xml"><file href="assessment.xml"/></resource></resources></manifest> | assessment.xml=<questestinterop xmlns="http://www.imsglobal.org/xsd/ims_qtiasiv1p2"><assessment id="a1" title="[REAL]"><section id="s1"><!--${target}--></section></assessment></questestinterop>

BASE: <item ident="ID" title="Q#"><itemmetadata><qtimetadata><qtimetadatafield><fieldlabel>question_type</fieldlabel><fieldentry>TYPE</fieldentry></qtimetadatafield><qtimetadatafield><fieldlabel>points_possible</fieldlabel><fieldentry>1</fieldentry></qtimetadatafield></qtimetadata></itemmetadata><presentation><material><mattext texttype="text/html">STEM</mattext></material>RSP</presentation><resprocessing><outcomes><decvar varname="SCORE" vartype="Decimal" minvalue="0" maxvalue="100"/></outcomes>SCORE</resprocessing>${state.quizFeedback !== 'off' ? 'FB' : ''}</item>

MC: TYPE=multiple_choice_question | RSP=<response_lid ident="r1" rcardinality="Single"><render_choice shuffle="Yes"><response_label ident="A"><material><mattext>OPT_A</mattext></material></response_label>...(B,C,D)</render_choice></response_lid> | SCORE=<respcondition continue="No"><conditionvar><varequal respident="r1">A</varequal></conditionvar><setvar varname="SCORE" action="Set">100</setvar></respcondition>

MA: TYPE=multiple_answers_question | RSP=rcardinality="Multiple" | SCORE=<respcondition><conditionvar><and><varequal respident="r1">A</varequal><varequal respident="r1">C</varequal><not><varequal respident="r1">B</varequal></not></and></conditionvar><setvar varname="SCORE" action="Set">100</setvar></respcondition>

TF: TYPE=true_false_question | RSP=<response_lid ident="r1" rcardinality="Single"><render_choice shuffle="No"><response_label ident="true"><material><mattext>True</mattext></material></response_label><response_label ident="false"><material><mattext>False</mattext></material></response_label></render_choice></response_lid> | SCORE=<respcondition><conditionvar><varequal respident="r1">true</varequal></conditionvar><setvar varname="SCORE" action="Set">100</setvar></respcondition>

SA: TYPE=short_answer_question | RSP=<response_str ident="r1" rcardinality="Single"><render_fib fibtype="String"><response_label ident="a1" rshuffle="No"/></render_fib></response_str> | SCORE=<respcondition continue="Yes"><conditionvar><varequal respident="r1">ans1</varequal></conditionvar><setvar varname="SCORE" action="Set">100</setvar></respcondition> (add <respcondition> for alts)

ESSAY: TYPE=essay_question | RSP=<response_str ident="r1" rcardinality="Single"><render_fib fibtype="String"><response_label ident="a1" rshuffle="No"/></render_fib></response_str> | SCORE=(empty-manual)

NUM: TYPE=numerical_question | RSP=<response_num ident="r1" rcardinality="Single"><render_fib fibtype="Decimal"><response_label ident="a1" rshuffle="No"/></render_fib></response_num> | SCORE=<respcondition><conditionvar><or><varequal respident="r1">42</varequal><and><vargte respident="r1">41.5</vargte><varlte respident="r1">42.5</varlte></and></or></conditionvar><setvar varname="SCORE" action="Set">100</setvar></respcondition>

ESC: &amp; &lt; &gt; &quot; &apos; | VAL: ${target} items, UTF-8, <mattext>‚â§1200ch, all tags closed, real title, Bloom mix | PDF: A4, TOC, 1Q/pg${state.quizFeedback !== 'off' ? '+FB' : ''} | OUT: [REAL_SLUG]_quiz_qti.zip+.pdf from og:title`;
}

// -------- Study Tool Prompts (v13 with scroll/expand + Bloom intent) --------

function promptCoreConceptsV13(){
  const ext = state.studyFormat === 'powerpoint' ? 'pptx (PowerPoint)' : 'docx (Word A4)';
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_core_concepts.${ext}.
Use only the Panopto Watch page. No external sources.

SOURCE PREPARATION
1. Confirm this is a Panopto "Watch" page.
2. Virtually scroll through and fully expand:
   ‚Äì "Captions" / "Transcript" tab ‚Üí bottom
   ‚Äì "Contents" / "Slides" tabs ‚Üí expand all
3. Wait until no new lines appear.
4. Extract and dedupe all caption + slide text (preserve [mm:ss]).
If corpus < 500 words ‚Üí
"INSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll fully, then retry."

TITLE & FILENAME
Extract REAL title from <meta property="og:title"> or [data-role="session-title"] or .session-title or document.title.
Use that title for H1 and filename [REAL_TITLE_SLUG]_study_core_concepts.docx.

TASK
Run all phases (collect ‚Üí analyse ‚Üí write ‚Üí validate ‚Üí output) automatically.
Do NOT pause or ask questions.

PURPOSE
Produce a timestamp-based conceptual study guide that explains key ideas and how they connect, using clear language and evidence.

STRUCTURE
1. Title page ‚Äî REAL title, module, date + 120-word "How to use this guide".
2. Learning outcomes ‚Äî 5 outcomes (10‚Äì18 words, ‚â• 3 Bloom levels) + 120-word alignment note.
3. Threshold concepts ‚Äî 3‚Äì5 ideas (80‚Äì110 words + [mm:ss]).
4. Key concepts ‚Äî ‚â• 12 concepts (55‚Äì75 words + [mm:ss]).
5. Concept map ‚Äî ‚âà 200 words (10‚Äì14 nodes/edges, ‚â• 6 timestamp links).
6. Appendix A ‚Äî ‚â• 24 quoted fragments (5‚Äì20 words + [mm:ss]).

BLOOM GUIDANCE (Student-friendly)
‚Ä¢ Remember = recall a definition or law
‚Ä¢ Understand = explain the idea in your own words
‚Ä¢ Apply = use the principle to solve a new problem
‚Ä¢ Analyse = break down parts and relationships
‚Ä¢ Evaluate = judge the best approach or solution
‚Ä¢ Create = design or combine ideas into something new

PEDAGOGY
Link concepts to outcomes; embed Beyond Blended pillars; apply ‚â•7 UDL checkpoints; UK English; QUB red #E0001B; WCAG-AA.

VALIDATION
Corpus ‚â• 500 words; ‚â• 3 thresholds; ‚â• 12 key concepts; ‚â• 24 timestamps; no placeholders; one .${state.studyFormat === 'powerpoint' ? 'pptx' : 'docx'} output.`;
}

function promptKnowledgeToolsV13(){
  const ext = state.studyFormat === 'powerpoint' ? 'pptx (PowerPoint)' : 'docx (Word A4)';
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_knowledge_tools.${ext}.

SOURCE PREPARATION ‚Äî same scroll/expand steps as Prompt 1; fail if < 500 words.

PURPOSE
Turn lecture content into usable terminology and reasoning patterns that model expert thinking.

STRUCTURE
1. Glossary ‚Äî ‚â• 28 terms (25‚Äì35 words + authentic example + [mm:ss]).
2. Worked examples ‚Äî 3 (180‚Äì220 words): Context; Steps; Why; Common slip; "Check you can‚Ä¶" + [mm:ss] and a short intent note (e.g., apply/analyse).
3. Mini cases ‚Äî 2 (180‚Äì220 words) with decision-making analysis + [mm:ss].
4. Appendix A ‚Äî ‚â• 24 timestamped quotes.

PEDAGOGY
Link each term/example to outcomes; Bloom Apply/Analyse via intent phrasing; ‚â•7 UDL checkpoints; Beyond Blended alignment; UK English.

VALIDATION
Glossary ‚â• 28; Examples = 3; Cases = 2; ‚â• 24 timestamps; no duplicates; one .${state.studyFormat === 'powerpoint' ? 'pptx' : 'docx'} output.`;
}

function promptPracticeTestingV13Word(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_practice_testing.docx (Word A4).
Use UK English. Use only the Panopto Watch page. No external sources. Work silently.

SOURCE PREPARATION
1) Confirm this is a Panopto "Watch" page.
2) Open Captions or Transcript and Contents or Slides. Expand all sections.
3) Scroll the transcript to the last line so all captions load. Wait until no new lines appear.
4) Click slide thumbnails so all slide text loads.
5) Extract and de-dup e captions + slide text. Preserve timestamps. Accept [m:ss], [mm:ss], [h:mm:ss].
‚Üí If corpus after de-duplication is less than 500 words, output exactly:
"INSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll fully, then retry."

TIMESTAMPS
Before output, normalise all times:
‚Ä¢ Use [mm:ss] if total duration is under 1 hour, zero-pad minutes and seconds.
‚Ä¢ Use [h:mm:ss] if 1 hour or longer.

COLLECT
Build QUOTES with at least 30 unique fragments, each 5‚Äì20 words, each with a distinct timestamp.
If a caption fragment is messy or filler, use the matching phrasing from Slides or Contents.

TITLE
Extract the real title from og:title or [data-role="session-title"] or .session-title or document.title.
Use it as H1 and to build [REAL_TITLE_SLUG].

STRUCTURE

H2 Introduction
Write 80‚Äì120 words on how to use this section for retrieval and reasoning. Mention that each item cites the lecture with timestamps.

H2 Problem Set (exactly 10 items)
Create 10 unique items that cover at least 3 distinct topics and a spread of Bloom levels:
‚Ä¢ 4 items at Remember or Understand
‚Ä¢ 4 items at Apply or Analyse
‚Ä¢ 2 items at Evaluate or Create

For each item provide:
‚Ä¢ Prompt: 25 words or fewer
‚Ä¢ Hint: 15‚Äì30 words
‚Ä¢ Solution: 60‚Äì110 words using one direct "quote" + timestamp from QUOTES
‚Ä¢ Why Correct: 30‚Äì50 words
‚Ä¢ Common Misconception: 20 words or fewer
‚Ä¢ Bloom intent: one level name

Each problem must use a different quote and timestamp. No repeats.

H2 Self-check Quiz (exactly 10 items)
Create 10 items on different ideas than the Problem Set.
For each item provide:
‚Ä¢ Question type: MC or Short Answer
‚Ä¢ Question text
‚Ä¢ Correct answer
‚Ä¢ Rationale: 20‚Äì35 words using one direct "quote" + timestamp from QUOTES
‚Ä¢ Common Misconception: 20 words or fewer
‚Ä¢ Bloom intent: one level name

Use 10 new quotes and timestamps not used in the Problem Set.

H2 Mini Rubric
Provide a 3 √ó 3 table with levels Developing, Competent, Excellent. Tie criteria to lecture specifics.

H2 Appendix A ‚Äî Quotes Used
List only the quotes actually used in Problems and Quiz, grouped by section.
Format each as: "quoted text" [normalised time].
Do not add new quotes here.

UNIQUENESS AND QUALITY CHECKS
Before output:
‚Ä¢ No quote text or timestamp is reused anywhere except in Appendix A.
‚Ä¢ Problems do not duplicate topics. Quiz items use different ideas than Problems.
‚Ä¢ No placeholders like "[Insert‚Ä¶]" or "Sample quote".
‚Ä¢ UK spelling throughout.

VALIDATION
1) Exactly 10 Problems and 10 Quiz items are present.
2) Every quoted fragment exists in Captions or Slides.
3) Each item's timestamp is normalised to [mm:ss] or [h:mm:ss] and the quote appears verbatim.
4) One .docx file only.`;
}

function promptPracticeTestingV13Pptx(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_practice_testing.pptx (PowerPoint).
Use UK English. Use only the Panopto Watch page. No external sources. Work silently.

SOURCE PREPARATION
1) Confirm this is a Panopto "Watch" page.
2) Open Captions or Transcript and Contents or Slides. Expand all sections.
3) Scroll the transcript to the last line so all captions load. Wait until no new lines appear.
4) Click slide thumbnails so all slide text loads.
5) Extract and de-dup captions + slide text. Preserve timestamps. Accept [m:ss], [mm:ss], [h:mm:ss].
‚Üí If corpus after de-duplication is less than 500 words, output exactly:
"INSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll fully, then retry."

TIMESTAMPS
Before output, normalise all times:
‚Ä¢ Use [mm:ss] if total duration is under 1 hour, zero-pad minutes and seconds.
‚Ä¢ Use [h:mm:ss] if 1 hour or longer.

COLLECT
Build QUOTES with at least 30 unique fragments, each 5‚Äì20 words, each with a distinct timestamp.
If a caption fragment is messy or filler, use the matching phrasing from Slides or Contents.

TITLE
Extract the real title from og:title or [data-role="session-title"] or .session-title or document.title.
Use it for the Title Slide and to build [REAL_TITLE_SLUG].

STRUCTURE (Slides)

Title Slide
‚Ä¢ Display the extracted title.

Section Header: Introduction
‚Ä¢ Create one content slide (80‚Äì120 words) explaining how to use this section for retrieval and reasoning. Mention that each item cites the lecture with timestamps.

Section Header: Problem Set (exactly 10 slides)
Create 10 content slides titled "Problem X" that cover at least 3 distinct topics and a spread of Bloom levels:
‚Ä¢ 4 slides at Remember or Understand
‚Ä¢ 4 slides at Apply or Analyse
‚Ä¢ 2 slides at Evaluate or Create
For each slide include:
‚Ä¢ Prompt: 25 words or fewer
‚Ä¢ Hint: 15‚Äì30 words
‚Ä¢ Solution: 60‚Äì110 words using one direct "quote" + timestamp from QUOTES
‚Ä¢ Why Correct: 30‚Äì50 words
‚Ä¢ Common Misconception: 20 words or fewer
‚Ä¢ Bloom intent: one level name
Each problem slide must use a different quote and timestamp. No repeats.

Section Header: Self-check Quiz (exactly 10 slides)
Create 10 content slides on different ideas than the Problem Set. For each slide include:
‚Ä¢ Question type: MC or Short Answer
‚Ä¢ Question text
‚Ä¢ Correct answer
‚Ä¢ Rationale: 20‚Äì35 words using one direct "quote" + timestamp from QUOTES
‚Ä¢ Common Misconception: 20 words or fewer
‚Ä¢ Bloom intent: one level name
Use 10 new quotes and timestamps not used in the Problem Set.

Section Header: Mini Rubric
‚Ä¢ Create one content slide with a 3 √ó 3 table (Developing, Competent, Excellent). Tie criteria to lecture specifics.

Section Header: Appendix A ‚Äî Quotes Used
‚Ä¢ Create content slide(s) listing only the quotes actually used in Problems and Quiz, grouped by section.
‚Ä¢ Format each as: "quoted text" [normalised time].
‚Ä¢ Do not add new quotes here.

UNIQUENESS AND QUALITY CHECKS
Before output:
‚Ä¢ No quote text or timestamp is reused anywhere except in Appendix A.
‚Ä¢ Problems do not duplicate topics. Quiz slides use different ideas than Problems.
‚Ä¢ No placeholders like "[Insert‚Ä¶]" or "Sample quote".
‚Ä¢ UK spelling throughout.

VALIDATION
1) Exactly 10 Problem slides and 10 Quiz slides are present.
2) Every quoted fragment exists in Captions or Slides.
3) Each slide's timestamp is normalised to [mm:ss] or [h:mm:ss] and the quote appears verbatim.
4) One .pptx file only.`;
}

function promptPracticeTestingV13(){
  return state.studyFormat === 'powerpoint' ? promptPracticeTestingV13Pptx() : promptPracticeTestingV13Word();
}

function promptReflectionPlanningV13(){
  const ext = state.studyFormat === 'powerpoint' ? 'pptx (PowerPoint)' : 'docx (Word A4)';
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_reflection_planning.${ext}.

SOURCE PREPARATION ‚Äî scroll & expand captions/slides fully; fail if < 500 words.

PURPOSE
Develop self-reflection and study planning skills based on timestamped lecture evidence and awareness of thinking levels.

STRUCTURE
1. Reflection prompts ‚Äî 6‚Äì8 questions (each with a brief intent phrase like "This helps you evaluate ‚Ä¶" + [mm:ss]).
2. Rewatch guide ‚Äî 8 clip intervals [mm:ss‚Äìmm:ss] with "watch for‚Ä¶" and an active task + intent note.
3. Two-week planner ‚Äî 14 rows with task, time estimate, and thinking skill column.
4. Appendix A ‚Äî ‚â• 24 timestamped quotes.

PEDAGOGY
Link to outcomes; Beyond Blended (Pace & Flex); ‚â•7 UDL checkpoints; inclusive UK English.

VALIDATION
‚â•6 reflections; 8 rewatch segments; 14-day planner; ‚â•24 timestamps; one .${state.studyFormat === 'powerpoint' ? 'pptx' : 'docx'} output.`;
}

function promptExtensionSupportV13Word(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_extension_support.docx (Word A4).
Use UK English. Use only the Panopto Watch page. No external sources. Work silently.

SOURCE PREP
1) Confirm this is a Panopto Watch page.
2) Open Captions/Transcript and Contents/Slides. Expand all sections.
3) Scroll the transcript to the last line so all captions load. Wait until no new lines appear.
4) Click slide thumbnails so all slide text loads.
5) Extract on-screen text from Captions, Contents and Slides with timestamps in [h:mm:ss] or [mm:ss].
‚Üí If combined text after de-duplication is < 500 words, output exactly:
"INSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll transcript fully, then retry."

COLLECT
Build a pool named QUOTES with at least 36 UNIQUE fragments, each 5‚Äì20 words, each with a DISTINCT timestamp.
If a caption fragment is garbled, prefer the parallel wording from Slides or Contents for that concept.

TITLE
Extract the real title from <meta property="og:title"> or [data-role="session-title"] or .session-title or document.title.
Use it as H1 and to build [REAL_TITLE_SLUG].

FORMAT
Use Word styles: H1 for title, H2 for sections, H3 for subheads. Use proper tables where requested.

H2 Flashcards (12)
Create TWELVE flashcards covering at least THREE distinct topics from the lecture. Do not use any one topic more than THREE times.
Each card fields:
‚Ä¢ ID: FC01‚ÄìFC12
‚Ä¢ Question: specific to the lecture wording. Ban generic stems such as "What is X?"
‚Ä¢ Answer: 1‚Äì3 sentences using lecture wording and include ONE quote + timestamp from QUOTES
‚Ä¢ Connection: why this matters for study or practice
‚Ä¢ Difficulty: Foundation or Intermediate or Advanced
‚Ä¢ Related IDs: 1‚Äì3 IDs. Do not include the card's own ID. Do not repeat the same ID twice.
‚Ä¢ Source: the same timestamp used in the Answer
Use TWELVE different quotes and timestamps. No repeats across cards.

H2 Group Tasks (2)
Create TWO activities of 140‚Äì180 words each grounded in lecture specifics.
Each task must include ONE quote + timestamp from QUOTES that has not been used in Flashcards and is not reused between tasks.
For each task include:
‚Ä¢ Activity type
‚Ä¢ Learning objective
‚Ä¢ Facilitation steps
‚Ä¢ One specific lecture cue with [mm:ss] or [h:mm:ss]
‚Ä¢ Pedagogical intent
‚Ä¢ Time estimate
‚Ä¢ Assessment note
Tasks must be distinct from each other.

H2 Authentic Practice Task (1)
Create ONE scenario of 170‚Äì220 words grounded in the lecture. Include ONE new quote + timestamp from QUOTES not used earlier.
Add a 3√ó3 rubric table with criteria tied to lecture specifics and three levels: Developing, Competent, Excellent.

H2 Appendix A: Quotes Used
List every quote used in the document, grouped by section.
Show the exact quoted text in quotation marks plus the timestamp. Do not add any new quotes here.

H2 Appendix B: Flashcards Table
Provide a Word table with headers: ID, Question, Answer, Connection, Difficulty, Related IDs, Source.
Fill rows FC01‚ÄìFC12 using the exact Flashcard content.

UNIQUENESS AND QUALITY CHECKS (hard rules)
Before output:
‚Ä¢ No quote text or timestamp is reused anywhere in the document, apart from being listed again in Appendix A.
‚Ä¢ Related IDs never repeat within a card and never include the card's own ID.
‚Ä¢ Flashcards cover at least three distinct topics and do not exceed three cards on any single topic.
‚Ä¢ Group tasks are distinct from each other and from the Authentic Practice Task.
‚Ä¢ No placeholder text such as "Question 1", "Sample quote", "Concept N", or generic answer patterns.
‚Ä¢ All timestamps match ^(\d{1,2}:)?[0-5]\d:[0-5]\d$ ([mm:ss] or [h:mm:ss]).
‚Ä¢ Remove any stray quotation marks after timestamps.

VALIDATION
1) Every quoted fragment exists in Captions or Slides.
2) Each Flashcard "Source" matches the timestamp quoted in its Answer.
3) Use UK spelling throughout.

OUTPUT
Produce the .docx file only.`;
}

function promptExtensionSupportV13Pptx(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_extension_support.pptx (PowerPoint).
Use UK English. Use only the Panopto Watch page. No external sources. Work silently.

SOURCE PREP
1) Confirm Panopto Watch page.
2) Open Captions/Transcript and Contents/Slides. Expand all sections.
3) Scroll transcript to the last line; wait until no new lines appear.
4) Click slide thumbnails so all slide text loads.
5) Extract on-screen text from Captions, Contents and Slides with timestamps ([mm:ss] or [h:mm:ss]).
‚Üí If combined text after de-duplication < 500 words, output exactly:
"INSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll transcript fully, then retry."

COLLECT
Build QUOTES with ‚â• 36 UNIQUE fragments, each 5‚Äì20 words, each with a DISTINCT timestamp.
Trim long fragments to 5‚Äì20 words. Reject ASR filler/garble; prefer the matching Slides/Contents wording when captions are messy.

TITLE
Extract the real title from og:title or [data-role="session-title"] or .session-title or document.title.
Use it as H1 and to build [REAL_TITLE_SLUG].

FORMAT
Use Word styles: H1 for title, H2 for sections, H3 for subheads. Use real tables where requested.

H2 Flashcards (12)
Create TWELVE flashcards covering at least THREE distinct topics. Do not use any one topic more than THREE times.
Each card fields:
‚Ä¢ ID: FC01‚ÄìFC12
‚Ä¢ Question: lecture-specific (ban generic "What is X?")
‚Ä¢ Answer: 1‚Äì3 sentences using lecture wording + include ONE direct quote (from QUOTES) + timestamp
‚Ä¢ Connection: why this matters for study/practice
‚Ä¢ Difficulty: Foundation / Intermediate / Advanced
‚Ä¢ Related IDs: 1‚Äì3 other IDs (no self-reference; no duplicates)
‚Ä¢ Source: the same timestamp used in the Answer
Use TWELVE different quotes and timestamps. No repeats.

H2 Group Tasks (2)
Create TWO activities, 140‚Äì180 words each, grounded in lecture specifics.
Each task includes ONE new quote + timestamp (not used in Flashcards) and provides:
‚Ä¢ Activity type ‚Ä¢ Learning objective ‚Ä¢ 3‚Äì5 facilitation steps
‚Ä¢ One specific lecture cue with timestamp ‚Ä¢ Pedagogical intent
‚Ä¢ Time estimate ‚Ä¢ Assessment note
Tasks must be distinct from each other.

H2 Authentic Practice Task (1)
Create ONE scenario, 170‚Äì220 words, grounded in the lecture.
Include ONE new quote + timestamp not used earlier.
Add a 3√ó3 rubric table with criteria tied to lecture specifics and three levels: Developing, Competent, Excellent.

H2 Appendix A ‚Äî Quotes Used
List ONLY the quotes actually used above, grouped by section.
Format each as: "quoted text" [timestamp]. Do not add new quotes here.

H2 Appendix B ‚Äî Flashcards Table
Provide a Word table with headers: ID, Question, Answer, Connection, Difficulty, Related IDs, Source.
Fill rows FC01‚ÄìFC12 using the exact Flashcard content.

UNIQUENESS & QUALITY CHECKS (hard rules)
Before output:
‚Ä¢ No quote text or timestamp is reused anywhere except in Appendix A.
‚Ä¢ Related IDs never repeat within a card and never include the card's own ID.
‚Ä¢ Flashcards cover ‚â• 3 topics and do not exceed three cards per single topic.
‚Ä¢ Group tasks are distinct from each other and from the Authentic task.
‚Ä¢ No placeholders like "Question 1", "Sample quote", "Concept N".
‚Ä¢ All timestamps match ^(\d{1,2}:)?[0-5]\d:[0-5]\d$ (accept [mm:ss] or [h:mm:ss]).
‚Ä¢ Remove any stray quotation marks after timestamps.

VALIDATION (hard fail if not met)
If ANY required section is missing, output exactly:
"MISSING_SECTIONS ‚Äî Regenerate with Flashcards 12, Group Tasks 2, Authentic Task 1 + rubric, Appendix A, Appendix B."
Otherwise confirm:
1) Every quoted fragment exists in Captions or Slides and is 5‚Äì20 words.
2) Each Flashcard "Source" matches the timestamp quoted in its Answer.
3) UK spelling throughout; timestamps normalised to [mm:ss] (<1h) or [h:mm:ss] (‚â•1h).

OUTPUT
Produce the .pptx file only.`;
}

function promptExtensionSupportV13(){
  return state.studyFormat === 'powerpoint' ? promptExtensionSupportV13Pptx() : promptExtensionSupportV13Word();
}

// Registry for tool cards
const STUDY_TOOLS = [
  {
    id:'core',
    icon:'üìö',
    name:'Core Concepts',
    points:[
      'Surface the key thresholds and big ideas',
      'Summarise 12+ core concepts with timestamps',
      'Map relationships in a concept map',
      'Evidence every section with ‚â•24 snippets'
    ],
    builder: promptCoreConceptsV13
  },
  {
    id:'knowledge',
    icon:'üõ†Ô∏è',
    name:'Knowledge Tools',
    points:[
      'Build a 28-term glossary with authentic examples',
      'Model 3 worked examples plus 2 mini cases',
      'Explain slips, fixes, and Bloom intent',
      'Bundle an evidence appendix for QA'
    ],
    builder: promptKnowledgeToolsV13
  },
  {
    id:'practice',
    icon:'üß†',
    name:'Practice & Testing',
    points:[
      'Create 10 interleaved problems with feedback',
      'Add a 10 item self check quiz with rationales',
      'Flag misconceptions and Bloom focus per item',
      'Include a mini rubric for rapid marking'
    ],
    builder: promptPracticeTestingV13
  },
  {
    id:'reflect',
    icon:'üîÅ',
    name:'Reflection & Planning',
    points:[
      'Prompt 6‚Äì8 metacognitive check-ins',
      'Serve 8 timestamped rewatch tasks',
      'Lay out a 14-day plan with time estimates',
      'Tie actions to outcomes and thinking levels'
    ],
    builder: promptReflectionPlanningV13
  },
  {
    id:'support',
    icon:'üåê',
    name:'Extension & Support',
    points:[
      'Generate 10 flashcards with quotes and timestamps',
      'Design 2 distinct group tasks with objectives',
      'Create 1 authentic task with a 3√ó3 rubric',
      'Include Quotes Used + Flashcards Table appendices'
    ],
    builder: promptExtensionSupportV13
  },
];

const TOOL_STYLE_PALETTE = [
  { accent: '#F97316', badge: 'rgba(249,115,22,0.12)', chip: 'rgba(249,115,22,0.08)', chipBorder: 'rgba(249,115,22,0.25)', accentHover: '#ea580c' },
  { accent: '#8B5CF6', badge: 'rgba(139,92,246,0.12)', chip: 'rgba(139,92,246,0.08)', chipBorder: 'rgba(139,92,246,0.25)', accentHover: '#7c3aed' },
  { accent: '#0EA5E9', badge: 'rgba(14,165,233,0.12)', chip: 'rgba(14,165,233,0.08)', chipBorder: 'rgba(14,165,233,0.25)', accentHover: '#0284c7' },
  { accent: '#F973AB', badge: 'rgba(249,115,171,0.12)', chip: 'rgba(249,115,171,0.08)', chipBorder: 'rgba(249,115,171,0.25)', accentHover: '#ec4899' },
  { accent: '#0FA968', badge: 'rgba(15,169,104,0.12)', chip: 'rgba(15,169,104,0.08)', chipBorder: 'rgba(15,169,104,0.25)', accentHover: '#0c8e58' }
];

let currentStudyPrompt = '';
let currentNotesTemplate = null;
let currentNotesPrompt = '';

function mountStudyToolCards(){
  const grid = document.getElementById('studyToolsGrid');
  if(!grid) return;
  
  // Check if format card already exists to prevent duplicate event listeners
  const existingFormatCard = grid.querySelector('.output-format-card');
  if (existingFormatCard) {
    // Just update the active state without recreating
    existingFormatCard.querySelectorAll('.format-option').forEach(btn => {
      const format = btn.getAttribute('data-format');
      if (format === state.studyFormat) {
        btn.classList.add('active');
        btn.setAttribute('aria-checked', 'true');
      } else {
        btn.classList.remove('active');
        btn.setAttribute('aria-checked', 'false');
      }
    });
  } else {
    // Create format card only if it doesn't exist
    grid.innerHTML = '';
    
    // Add Output Format card as the first card
    const formatCard = document.createElement('div');
    formatCard.className = 'preset-card tool-card output-format-card';
    formatCard.innerHTML = `
      <h3 id="format-title">üìÑ Output Format</h3>
      <p>Choose the output format for your study guide documents.</p>
      <div class="output-format-options" role="radiogroup" aria-labelledby="format-title">
        <button class="format-option ${state.studyFormat === 'word' ? 'active' : ''}" 
                data-format="word" 
                role="radio" 
                aria-checked="${state.studyFormat === 'word'}"
                aria-label="Select Word document format">
          üìù Word (.docx)
        </button>
        <button class="format-option ${state.studyFormat === 'powerpoint' ? 'active' : ''}" 
                data-format="powerpoint" 
                role="radio" 
                aria-checked="${state.studyFormat === 'powerpoint'}"
                aria-label="Select PowerPoint presentation format">
          üìä PowerPoint (.pptx)
        </button>
      </div>
    `;
    grid.appendChild(formatCard);
    
    // Add format toggle functionality
    formatCard.querySelectorAll('.format-option').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log('Format button clicked:', btn.getAttribute('data-format'));
        
        const format = btn.getAttribute('data-format');
        state.studyFormat = format;
        console.log('State updated to:', state.studyFormat);
        
        // Update visual state
        formatCard.querySelectorAll('.format-option').forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-checked', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-checked', 'true');
        
        console.log('Visual state updated');
      });
    });
  }
  
  // Add study tool cards only if they don't exist
  const existingToolCards = grid.querySelectorAll('.tool-card:not(.output-format-card)');
  if (existingToolCards.length === 0) {
    STUDY_TOOLS.forEach((tool, index)=>{
      const card = document.createElement('div');
      card.className = 'preset-card tool-card';
      const style = TOOL_STYLE_PALETTE[index % TOOL_STYLE_PALETTE.length] || TOOL_STYLE_PALETTE[0];
      card.style.setProperty('--tool-accent', style.accent);
      card.style.setProperty('--tool-accent-hover', style.accentHover || style.accent);
      card.style.setProperty('--tool-badge-bg', style.badge);
      card.style.setProperty('--tool-chip-bg', style.chip);
      card.style.setProperty('--tool-chip-border', style.chipBorder);
      const points = (tool.points || []).map(point => `<li>${point}</li>`).join('');
      card.innerHTML = `
        <div class="tool-badge">${tool.icon} ${tool.name}</div>
        <ul class="tool-points">${points}</ul>
        <div class="tool-actions">
          <button class="btn-primary" data-tool="${tool.id}">üìã Copy Prompt</button>
        </div>`;
      grid.appendChild(card);
    });

    grid.querySelectorAll('button[data-tool]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-tool');
        const tool = STUDY_TOOLS.find(t=>t.id===id);
        if(!tool) return;
        const prompt = tool.builder();
        copyTextToClipboard(prompt);
      });
    });
  }
}

function showToast(){
  const t = $('toast');
  if(!t) return;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1800);
}

function copyTextToClipboard(text){
  if (!text) return;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showToast();
    }).catch(err => {
      alert('Failed to copy to clipboard: ' + err.message);
    });
    return;
  }
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.top = '0';
  ta.style.left = '0';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try {
    document.execCommand('copy');
    showToast();
  } catch (e) {
    alert('Failed to copy: ' + e.message);
  }
  document.body.removeChild(ta);
}

const NOTES_TEMPLATES = [
  {
    id: 'summary',
    icon: 'üìù',
    name: 'Structured Summary',
    points: [
      'Surface the key arguments and evidence in the notes',
      'Group related concepts with timestamp or heading cues',
      'Highlight misconceptions, clarifications, and next steps',
      'Compile an evidence appendix for quality assurance'
    ],
    build: (notes, meta) => `SYSTEM
Return ONE file only: ${meta.slug}_notes_summary.docx (Word A4). Do NOT ask questions. Do NOT use external sources.

NOTES SAFEGUARD
‚Ä¢ Use only the supplied notes. If cleaned text < 400 words, return "INSUFFICIENT_NOTES ‚Äî add more detail and retry."
‚Ä¢ Auto-run collect ‚Üí analyse ‚Üí write ‚Üí validate (no user confirmation).
‚Ä¢ Use UK English, WCAG-AA contrast, Queen's red (#E0001B).

OUTPUT STRUCTURE
1) Title page ‚Äî use "${meta.title}" + module, date, and a 90‚Äì120 word "How to use this guide".
2) Key outcomes ‚Äî 4‚Äì6 outcome statements linked directly to the notes.
3) Section summaries ‚Äî 5‚Äì8 sections: heading, what it covers, why it matters, evidence snippet.
4) Concept connectors ‚Äî bullets for links, misconceptions, follow-up actions.
5) Appendix A ‚Äî ‚â•18 quoted evidence snippets (5‚Äì20 words + source/heading).

NOTES (verbatim ‚Äî analyse only this text):
${notes}
`
  },
  {
    id: 'revision',
    icon: 'üéØ',
    name: 'Revision Deck',
    points: [
      'Build 30 flashcards with answers and difficulty tags',
      'Add a 10-question self-check quiz with rationales',
      'Surface common slips and suggestions for next study moves',
      'Keep everything grounded in timestamped note evidence'
    ],
    build: (notes, meta) => `SYSTEM
Return ONE file only: ${meta.slug}_notes_revision.docx (Word A4). Do NOT ask questions. Do NOT use external sources.

NOTES SAFEGUARD
‚Ä¢ Use only the supplied notes. If cleaned text < 400 words, return "INSUFFICIENT_NOTES ‚Äî add more detail and retry."
‚Ä¢ Auto-run collect ‚Üí analyse ‚Üí write ‚Üí validate.
‚Ä¢ Use UK English, WCAG-AA, Queen's red accents.

OUTPUT STRUCTURE
1) Orientation ‚Äî ‚â§120 words on how to revise with this pack.
2) Flashcards ‚Äî table of 30 cards: ID, Question, Answer, Connection to notes, Difficulty (Fdn/Int/Adv), Source [heading/time].
3) Quick quiz ‚Äî 10 items (MC/SA mix) with answer, 20‚Äì30 word rationale, likely misconception, source.
4) Study tips ‚Äî 6 bullet recommendations linked to upcoming assessments.
5) Appendix A ‚Äî ‚â•18 quoted evidence snippets (5‚Äì20 words + source/heading).

NOTES (verbatim ‚Äî analyse only this text):
${notes}
`
  },
  {
    id: 'workshop',
    icon: 'üó∫Ô∏è',
    name: 'Workshop Plan',
    points: [
      'Draft a ready-to-run session plan from the notes',
      'Sequence activities with timings and participation modes',
      'Provide reflection prompts and follow-up support routes',
      'Evidence every section with note references'
    ],
    build: (notes, meta) => `SYSTEM
Return ONE file only: ${meta.slug}_notes_plan.docx (Word A4). Do NOT ask questions. Do NOT use external sources.

NOTES SAFEGUARD
‚Ä¢ Use only the supplied notes. If cleaned text < 400 words, return "INSUFFICIENT_NOTES ‚Äî add more detail and retry."
‚Ä¢ Auto-run collect ‚Üí analyse ‚Üí write ‚Üí validate.
‚Ä¢ Use UK English, WCAG-AA, inclusive tone.

OUTPUT STRUCTURE
1) Session overview ‚Äî two short paragraphs covering purpose, context, and success metrics drawn from the notes.
2) Workshop blueprint ‚Äî table with columns: Phase, Duration, Objectives, Activity steps, Evidence references, Participation mode.
3) Reflection prompts ‚Äî 6 prompts spanning analyse/evaluate/create linked to the notes.
4) Support & follow-up ‚Äî bullet list of help routes, resources, accessibility adjustments.
5) Appendix A ‚Äî ‚â•18 quoted evidence snippets (5‚Äì20 words + source/heading).

NOTES (verbatim ‚Äî analyse only this text):
${notes}
`
  }
];

function deriveNotesMeta(raw) {
  const lines = (raw || '').split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  let title = lines.length ? lines[0].replace(/^#+\s*/, '') : 'Notes Pack';
  if (title.length < 4 && lines.length > 1) title = lines[1];
  const cleanTitle = title || 'Notes Pack';
  const slug = slugify(cleanTitle);
  return { title: cleanTitle, slug: slug || 'Notes_Pack' };
}

function getNotesInput() {
  return ($('notesInput')?.value || '').trim();
}

function buildNotesOutput(template, rawNotes) {
  const notes = (rawNotes || '').trim();
  if (!notes) {
    return { error: 'Please paste your notes first.' };
  }
  const meta = deriveNotesMeta(notes);
  const prompt = template.build(notes, meta);
  return { prompt, label: template.name };
}

function mountNotesToolCards(){
  const grid = document.getElementById('notesToolsGrid');
  if(!grid) return;
  grid.innerHTML = '';
  NOTES_TEMPLATES.forEach((tool, index)=>{
    const card = document.createElement('div');
    card.className = 'preset-card tool-card';
    const style = TOOL_STYLE_PALETTE[(index + 2) % TOOL_STYLE_PALETTE.length];
    card.style.setProperty('--tool-accent', style.accent);
    card.style.setProperty('--tool-accent-hover', style.accentHover || style.accent);
    card.style.setProperty('--tool-badge-bg', style.badge);
    card.style.setProperty('--tool-chip-bg', style.chip);
    card.style.setProperty('--tool-chip-border', style.chipBorder);
    const points = (tool.points || []).map(point => `<li>${point}</li>`).join('');
    card.innerHTML = `
      <div class="tool-badge">${tool.icon} ${tool.name}</div>
      <ul class="tool-points">${points}</ul>
      <div class="tool-actions">
        <button class="btn-primary" data-tool="${tool.id}">üìã Copy Prompt</button>
      </div>`;
    grid.appendChild(card);
  });

  if (state.workflow === 'notes') {
    // No preview panel; nothing to initialise here
  } else {
    setCharStatus((currentNotesPrompt || '').length);
  }

  grid.querySelectorAll('button[data-tool]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-tool');
      const template = NOTES_TEMPLATES.find(t=>t.id===id);
      const result = buildNotesOutput(template, getNotesInput());
      if (result.error) { alert(result.error); return; }
      if (result.prompt.length > 8000) {
        alert('This prompt is over 8000 characters. Trim your notes and try again.');
        return;
      }
      currentNotesPrompt = result.prompt;
      copyTextToClipboard(result.prompt);
    });
  });

  if (state.workflow === 'notes') {
    // No preview panel to reset
  }
}

// Render preview
function render() {
  if (state.workflow === 'study') {
    setCharStatus(0);
    if ($('previewPlaceholder')) $('previewPlaceholder').classList.remove('hidden');
    if ($('previewText')) $('previewText').classList.add('hidden');
    return;
  }

  if (state.workflow === 'notes') {
    setCharStatus(currentNotesPrompt ? currentNotesPrompt.length : 0);
    return;
  }

  let prompt = '';
  if (state.workflow === 'quiz') prompt = buildQuizPrompt();

  setCharStatus(prompt.length);
  
  if (prompt) {
    if ($('previewPlaceholder')) $('previewPlaceholder').classList.add('hidden');
    if ($('previewText')) {
      $('previewText').classList.remove('hidden');
      $('previewText').textContent = prompt;
    }
  } else {
    if ($('previewPlaceholder')) $('previewPlaceholder').classList.remove('hidden');
    if ($('previewText')) $('previewText').classList.add('hidden');
  }
}

// Copy to clipboard
function copyPrompt() {
  if (state.workflow === 'study') {
    if (!currentStudyPrompt) {
      alert('Select a tool and preview or copy its prompt first.');
      return;
    }
    if (currentStudyPrompt.length > 8000) {
      alert('This prompt is over 8000 characters. Trim inputs and preview again.');
      return;
    }
    copyTextToClipboard(currentStudyPrompt);
    return;
  }

  if (state.workflow === 'notes') {
    if (!currentNotesPrompt) {
      alert('Paste your notes, choose a tool, then preview before copying.');
      return;
    }
    if (currentNotesPrompt.length > 8000) {
      alert('This prompt is over 8000 characters. Trim your notes and preview again.');
      return;
    }
    copyTextToClipboard(currentNotesPrompt);
    return;
  }

  let prompt = '';
  if (state.workflow === 'quiz') prompt = buildQuizPrompt();

  if (!prompt || prompt.trim() === '') {
    console.error('No prompt generated!');
    alert('No prompt to copy yet. Please ensure you have selected your options.');
    return;
  }

  copyTextToClipboard(prompt);
}

// Init question type chips
function initQuestionTypes() {
  const container = $('questionTypes');
  container.innerHTML = '';
  QUESTION_TYPES.forEach(type => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (state.questionTypes.includes(type.id) ? ' active' : '');
    chip.textContent = type.label;
    chip.onclick = () => {
      if (state.questionTypes.includes(type.id)) {
        state.questionTypes = state.questionTypes.filter(t => t !== type.id);
      } else {
        state.questionTypes.push(type.id);
      }
      chip.classList.toggle('active');
      render();
    };
    container.appendChild(chip);
  });
}

// Update character count status and progress bar
function setCharStatus(charLength) {
  const charCountEl = $('charCount');
  const statusBadgeEl = $('statusBadge');
  const statusTextEl = $('statusText');
  const progressBarEl = $('progressBar');
  
  if (charCountEl) charCountEl.textContent = charLength;
  
  if (progressBarEl) {
    const percent = Math.min((charLength / 8000) * 100, 100);
    progressBarEl.style.width = percent + '%';
  }
  
  if (statusBadgeEl && statusTextEl) {
    if (charLength === 0) {
      statusBadgeEl.className = 'status-badge';
      statusTextEl.textContent = 'Ready';
    } else if (charLength < 6000) {
      statusBadgeEl.className = 'status-badge success';
      statusTextEl.textContent = 'Optimal';
    } else if (charLength < 8000) {
      statusBadgeEl.className = 'status-badge warning';
      statusTextEl.textContent = 'Good';
    } else {
      statusBadgeEl.className = 'status-badge error';
      statusTextEl.textContent = 'Too Long';
    }
  }
}

// Init
function init() {
  // Update pedagogy brief on load (quiz)
  const p = PEDAGOGY[state.pedagogy];
  if (p) $('pedBrief').textContent = p.brief;
  
  // Help button - navigate to Getting Started page
  if ($('helpToggle')) {
    $('helpToggle').onclick = () => {
      $$('.workflow-btn').forEach(b => b.classList.remove('active'));
      const helpBtn = document.querySelector('[data-tab="help"]');
      if (helpBtn) {
        helpBtn.classList.add('active');
        state.workflow = 'help';
        $$('.workflow-content').forEach(w => w.classList.add('hidden'));
        document.querySelector('.help-workflow').classList.remove('hidden');
        
        // Hide preview section and update hero banner
        const previewSection = $('previewSection');
        if (previewSection) previewSection.style.display = 'none';
        
        const hero = heroContent.help;
        if (hero) {
          const heroBanner = $('heroBanner');
          heroBanner.className = 'hero-banner ' + hero.class;
          $('heroBadgeText').textContent = hero.badge;
          $('heroTitle').textContent = hero.title;
          $('heroSubtitle').textContent = hero.subtitle;
        }
        // Ensure FAQ gets initialized when entering help
        setTimeout(() => {
          if (typeof setupFaqAccordion === 'function') setupFaqAccordion();
        }, 0);
      }
    };
  }
  
  // Dismiss handlers
  if ($('dismissAbout')) {
    $('dismissAbout').onclick = () => {
      $('about').classList.remove('show');
    };
  }
  
  if ($('hidePreflight')) {
    $('hidePreflight').onclick = () => {
      $('preflight').classList.remove('show');
    };
  }
  
  if ($('hideCanvasHow')) {
    $('hideCanvasHow').onclick = () => {
      $('canvasHow').classList.remove('show');
    };
  }
  
  initQuestionTypes();
  render();
  
  // Show Getting Started by default
  window.switchWorkflow('help');
  
  // Pedagogy selector
  $('pedagogy').addEventListener('change', () => {
    state.pedagogy = $('pedagogy').value;
    const p = PEDAGOGY[state.pedagogy];
    $('pedBrief').textContent = p?.brief || '';
    render();
  });
  
  // Advanced toggles
  $('advancedToggle').onclick = () => {
    $('advancedContent').classList.toggle('open');
    $('advancedToggle').querySelector('.advanced-toggle').classList.toggle('open');
  };
  
  // Form inputs - Quiz
  if ($('quizTitle')) {
    $('quizTitle').oninput = e => { state.quizTitle = e.target.value; render(); };
  }
  const quizLangEl = $('quizLang');
  if (quizLangEl) {
    quizLangEl.onchange = e => { state.quizLang = e.target.value; render(); };
  }
  const quizCountEl = $('quizCount');
  if (quizCountEl) {
    quizCountEl.oninput = e => { state.quizCount = +e.target.value; render(); };
  }
  const quizFeedbackEl = $('quizFeedback');
  if (quizFeedbackEl) {
    quizFeedbackEl.onchange = e => { state.quizFeedback = e.target.value; render(); };
  }
  
  // Format selector is now handled in mountStudyToolCards()
  
  // Form inputs - From Notes (using inline handlers, no duplicates needed)
  if ($('notesInput')) {
    $('notesInput').oninput = e => {
      state.notesInput = e.target.value;
      if (state.workflow === 'notes') {
        refreshNotesPreview();
        if (!currentNotesTemplate) setCharStatus(0);
      }
    };
  }
  
  // Copy buttons
  if ($('generateQuiz')) {
    console.log('Wiring generateQuiz button');
  $('generateQuiz').onclick = copyPrompt;
  }
  if ($('generateNotes')) {
    console.log('Wiring generateNotes button');
  $('generateNotes').onclick = copyPrompt;
  }
  if ($('copyTop')) {
    console.log('Wiring copyTop button');
    $('copyTop').onclick = copyPrompt;
  }
  
  // FAQ Accordion - robust setup with measured heights
  function setupFaqAccordion() {
    const items = document.querySelectorAll('.faq-item');
    if (!items || items.length === 0) return;
    items.forEach(item => {
      const question = item.querySelector('.faq-question');
      const answer = item.querySelector('.faq-answer');
      if (!question || !answer) return;

      // Ensure collapsed state baseline
      item.classList.remove('open');
      answer.style.maxHeight = '0px';
      question.setAttribute('role', 'button');
      question.setAttribute('tabindex', '0');
      question.setAttribute('aria-expanded', 'false');

      const toggle = () => {
        // Close others first
        document.querySelectorAll('.faq-item.open').forEach(other => {
          if (other !== item) {
            other.classList.remove('open');
            const otherAns = other.querySelector('.faq-answer');
            const otherQ = other.querySelector('.faq-question');
            if (otherAns) otherAns.style.maxHeight = '0px';
            if (otherQ) otherQ.setAttribute('aria-expanded', 'false');
          }
        });

        // Toggle this one
        const isOpen = item.classList.toggle('open');
        question.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        if (isOpen) {
          // Measure content height
          const inner = answer.querySelector('.faq-answer-text');
          const h = inner ? (inner.scrollHeight + 32) : 300; // padding guard
          answer.style.maxHeight = h + 'px';
        } else {
          answer.style.maxHeight = '0px';
        }
      };

      question.onclick = toggle;
      question.onkeydown = (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          toggle();
        }
      };
    });
  }

  // Initial setup
  setupFaqAccordion();
}

init();
</script>

</body>
</html>


