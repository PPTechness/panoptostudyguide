<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panopto Canvas Prompt Builder</title>
<link rel="icon" type="image/png" href="favicon.png" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  
  * { margin:0; padding:0; box-sizing:border-box; }
  
  :root {
    --qub: #E0001B;
    --qub-red: #E0001B;
    --primary: #E0001B;
    --primary-hover: #b00016;
    --primary-gradient: linear-gradient(135deg, #E0001B 0%, #ff4757 100%);
    --success: #34c759;
    --success-gradient: linear-gradient(135deg, #34c759 0%, #00d9ff 100%);
    --warning: #ff9500;
    --danger: #ff3b30;
    --bg: #fafafa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f0f2f5;
    --text: #0a0a0a;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;
    --border: #e5e7eb;
    --shadow: 0 4px 20px rgba(0,0,0,0.06);
    --shadow-md: 0 8px 30px rgba(0,0,0,0.08);
    --shadow-lg: 0 20px 60px rgba(0,0,0,0.12);
    --shadow-xl: 0 30px 80px rgba(0,0,0,0.15);
    --radius: 16px;
    --radius-lg: 24px;
    --radius-xl: 32px;
    --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-qub: linear-gradient(135deg, #E0001B 0%, #ff4757 50%, #ff6b81 100%);
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }
  
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    position: relative;
    overflow-x: hidden;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(224,0,27,0.03) 0%, transparent 70%);
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }
  
  body::after {
    content: '';
    position: fixed;
    bottom: -50%;
    left: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(102,126,234,0.03) 0%, transparent 70%);
    animation: float 25s ease-in-out infinite reverse;
    pointer-events: none;
    z-index: 0;
  }
  
  /* Header */
  header {
    background: rgba(255,255,255,0.8);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    backdrop-filter: blur(30px) saturate(180%);
    border-bottom: 1px solid rgba(224,0,27,0.1);
    padding: 1.25rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: fadeInUp 0.6s ease-out;
  }
  
  header:hover {
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
  }
  
  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    z-index: 1;
  }
  
  .brand {
    display: flex;
    align-items: center;
    gap: 14px;
    position: relative;
    z-index: 1;
  }
  
  .brand img {
    height: 32px;
    transition: transform 0.3s ease;
    filter: drop-shadow(0 2px 8px rgba(224,0,27,0.15));
  }
  
  .brand img:hover {
    transform: scale(1.05);
  }
  
  .brand h1 {
    font-size: 1.35rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .logo {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    font-size: 1.35rem;
    font-weight: 700;
  }
  
  .logo-icon {
    width: 42px;
    height: 42px;
    background: var(--gradient-qub);
    background-size: 200% 200%;
    animation: gradientShift 8s ease infinite;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    box-shadow: 0 8px 24px rgba(224,0,27,0.25);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
  }
  
  .logo-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
  }
  
  .logo-icon:hover {
    transform: rotate(-5deg) scale(1.1);
    box-shadow: 0 12px 32px rgba(224,0,27,0.35);
  }
  
  /* Navigation Menu */
  .workflow-selector {
    display: flex;
    gap: 2rem;
    align-items: center;
  }
  
  .workflow-btn {
    padding: 0.625rem 0;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    letter-spacing: -0.01em;
  }
  
  .workflow-btn::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--gradient-qub);
    border-radius: 999px;
    transform: scaleX(0);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .workflow-btn:hover:not(.active) {
    color: var(--text);
  }
  
  .workflow-btn.active {
    color: var(--primary);
    font-weight: 700;
  }
  
  .workflow-btn.active::after {
    transform: scaleX(1);
  }
  
  /* Main Container */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 4rem 2rem;
    position: relative;
    z-index: 1;
  }
  
  /* Hero Banner */
  .hero-banner {
    position: relative;
    width: 100%;
    height: 400px;
    background: linear-gradient(135deg, rgba(224,0,27,0.85) 0%, rgba(147,51,234,0.85) 50%, rgba(59,130,246,0.85) 100%), 
                url('QUB-gallery-image-lanyon-building.jpg') center/cover;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: white;
    overflow: hidden;
    margin-bottom: 4rem;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .hero-banner.quiz-hero {
    background: linear-gradient(135deg, rgba(224,0,27,0.85) 0%, rgba(147,51,234,0.85) 50%, rgba(59,130,246,0.85) 100%), 
                url('QUB-gallery-image-lanyon-building.jpg') center/cover;
  }
  
  .hero-banner.study-hero {
    background: linear-gradient(135deg, rgba(16,185,129,0.85) 0%, rgba(59,130,246,0.85) 100%), 
                url('_S6A0583a.jpg') center/cover;
  }
  
  .hero-banner.notes-hero {
    background: linear-gradient(135deg, rgba(245,158,11,0.85) 0%, rgba(239,68,68,0.85) 100%), 
                url('1cdd84d4-b0ce-4901-9d10-6b47a02ed554.jpg') center/cover;
  }
  
  .hero-banner.help-hero {
    background: linear-gradient(135deg, rgba(124,58,237,0.85) 0%, rgba(236,72,153,0.85) 100%), 
                url('QUB-gallery-image-lanyon-building.jpg') center/cover;
  }
  
  .hero-banner::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.15) 0%, transparent 50%);
    animation: float 20s ease-in-out infinite;
  }
  
  .hero-content {
    position: relative;
    z-index: 1;
    max-width: 1100px; /* allow wider single-line headings on desktop */
    padding: 0 2rem;
    animation: fadeInUp 0.8s ease-out 0.2s both;
  }
  
  .hero-title {
    font-size: clamp(2.25rem, 5.5vw, 4.5rem);
    font-weight: 800;
    line-height: 1.05;
    margin: 0 0 1.5rem;
    letter-spacing: -0.03em;
    text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    text-wrap: balance; /* nicer multi-line wrapping */
  }
  
  .hero-subtitle {
    font-size: clamp(1rem, 1.25vw, 1.35rem);
    line-height: 1.6;
    margin: 0;
    opacity: 0.95;
    font-weight: 400;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    text-wrap: pretty; /* avoid orphan words */
  }

  @media (max-width: 1024px) {
    .hero-content { max-width: 900px; }
  }
  @media (max-width: 768px) {
    .hero-content { max-width: 700px; }
  }
  
  .hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1.25rem;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 999px;
    font-size: 0.9375rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255,255,255,0.3);
    text-wrap: balance;
  }
  
  /* Hero Section */
  .hero {
    max-width: 1000px;
    margin: 0 auto 4rem;
    text-align: center;
    display: none;
  }
  
  .hero h2 {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1.1;
    margin: 0 0 1.5rem;
    letter-spacing: -0.03em;
    background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
  }
  
  .hero h2::after {
    content: '';
    position: absolute;
    bottom: -12px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 5px;
    background: var(--gradient-qub);
    border-radius: 999px;
    opacity: 0.6;
  }
  
  .hero p {
    font-size: 1.25rem;
    color: var(--text-secondary);
    max-width: 680px;
    margin: 0 auto;
    line-height: 1.7;
    font-weight: 400;
  }
  
  .hero-sub {
    max-width: 920px;
    margin: 12px auto 0;
    color: var(--text-tertiary);
  }
  
  .info {
    max-width: 920px;
    margin: 2rem auto;
    padding: 2rem;
    border: 1px solid rgba(224,0,27,0.1);
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
    display: none;
  }
  
  .info.show {
    display: block;
    animation: fadeInUp 0.4s ease-out both;
  }
  
  .info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-qub);
  }
  
  /* Help Button */
  .help-toggle {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.75rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #d946ef 100%);
    color: white;
    border: none;
    border-radius: 999px;
    font-size: 1.0625rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(124,58,237,0.3);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .help-toggle:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 12px 32px rgba(124,58,237,0.5);
    background: linear-gradient(135deg, #6d28d9 0%, #9333ea 50%, #c026d3 100%);
  }
  
  .help-toggle-icon {
    font-size: 1.5rem;
    line-height: 1;
  }
  
  /* Quick Start Section */
  .quick-start {
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    padding: 3rem;
    margin-bottom: 3rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    animation: fadeInUp 0.8s ease-out 0.3s both;
  }
  
  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  
  .preset-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
  }
  
  .preset-card {
    background: white;
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  
  .preset-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gradient-qub);
    opacity: 0;
    transition: opacity 0.4s;
    z-index: 0;
  }
  
  .preset-card:hover {
    border-color: var(--primary);
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-xl);
  }
  
  .preset-card:hover::before {
    opacity: 0.03;
  }
  
  .preset-card.active {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(224,0,27,0.05) 0%, rgba(224,0,27,0.02) 100%);
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }
  
  .preset-icon {
    font-size: 3rem;
    margin-bottom: 0.75rem;
    position: relative;
    z-index: 1;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .preset-card:hover .preset-icon {
    transform: scale(1.2) rotate(-5deg);
  }
  
  .preset-name {
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
    position: relative;
    z-index: 1;
    letter-spacing: -0.01em;
  }
  
  .preset-desc {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.6;
    position: relative;
    z-index: 1;
  }

  .tool-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: rgba(224,0,27,0.08);
    border: 1px solid rgba(224,0,27,0.2);
    font-weight: 600;
    font-size: 0.8125rem;
    color: #E0001B;
    margin-bottom: 0.75rem;
  }
  
  .tool-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  
  .btn-ghost {
    background: transparent;
    border: 2px solid var(--border);
  }
  
  .btn-ghost:hover {
    border-color: var(--primary);
    color: var(--primary);
  }
  
  /* Primary Action */
  .primary-action {
    text-align: center;
    margin: 3rem 0;
  }
  
  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.125rem 2.5rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #d946ef 100%);
    background-size: 200% 200%;
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 1.125rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 8px 24px rgba(124,58,237,0.3);
    position: relative;
    overflow: hidden;
    letter-spacing: -0.01em;
  }
  
  .btn-primary::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
  }
  
  .btn-primary:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 16px 40px rgba(124,58,237,0.45);
    background: linear-gradient(135deg, #6d28d9 0%, #9333ea 50%, #c026d3 100%);
    background-position: 100% 50%;
  }
  
  .btn-primary:active {
    transform: translateY(-2px) scale(0.98);
  }
  
  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  .btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.875rem 1.75rem;
    background: white;
    color: var(--text);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: -0.01em;
  }
  
  .btn-secondary:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }
  
  .btn-secondary:active {
    transform: translateY(-1px);
  }
  
  /* Advanced Options (Collapsible) */
  .advanced-options {
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    overflow: hidden;
    animation: fadeInUp 0.8s ease-out 0.5s both;
  }
  
  .advanced-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 2rem;
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
    transition: all 0.3s;
  }
  
  .advanced-header:hover {
    background: linear-gradient(135deg, rgba(224,0,27,0.02) 0%, transparent 100%);
  }
  
  .advanced-title {
    font-weight: 700;
    font-size: 1.25rem;
    letter-spacing: -0.02em;
  }
  
  .advanced-toggle {
    color: var(--text-secondary);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    font-size: 1.25rem;
  }
  
  .advanced-toggle.open {
    transform: rotate(180deg);
  }
  
  .advanced-content {
    display: none;
    padding: 0 2rem 2rem;
    border-top: 1px solid var(--border);
  }
  
  .advanced-content.open {
    display: block;
    animation: fadeInUp 0.4s ease-out;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .form-label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.01em;
  }
  
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    padding: 0.875rem 1rem;
    border: 2px solid var(--border);
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    background: white;
  }
  
  input:hover,
  select:hover,
  textarea:hover {
    border-color: var(--text-tertiary);
  }
  
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(224,0,27,0.08);
    transform: translateY(-2px);
  }
  
  textarea {
    resize: vertical;
    min-height: 120px;
  }
  
  .chip-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.75rem;
  }
  
  .chip {
    padding: 0.625rem 1.125rem;
    background: white;
    border: 2px solid var(--border);
    border-radius: 999px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: -0.01em;
    position: relative;
    overflow: hidden;
  }
  
  .chip::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gradient-qub);
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 0;
  }
  
  .chip:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }
  
  .chip:hover::before {
    opacity: 0.05;
  }
  
  .chip.active {
    background: var(--gradient-qub);
    color: white !important;
    border-color: transparent;
    box-shadow: 0 6px 20px rgba(224,0,27,0.25);
    transform: translateY(-2px);
    position: relative;
    z-index: 2;
  }
  
  .chip.active::before {
    opacity: 1;
    z-index: -1;
  }
  
  .chip > * {
    position: relative;
    z-index: 3;
    color: inherit;
  }
  
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  /* Preview Section */
  .preview-section {
    background: white;
    border-radius: var(--radius-xl);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
    animation: fadeInUp 0.8s ease-out 0.6s both;
    position: relative;
    overflow: hidden;
  }
  
  .preview-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: var(--gradient-qub);
  }
  
  .preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-top: 0.5rem;
  }
  
  .preview-stats {
    display: flex;
    align-items: center;
    gap: 2rem;
    font-size: 0.9375rem;
    color: var(--text-secondary);
  }
  
  .stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .stat-value {
    font-weight: 700;
    color: var(--text);
    font-size: 1.125rem;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--success-gradient);
    color: white;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(52,199,89,0.25);
    letter-spacing: -0.01em;
  }
  
  .status-badge.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #ffa726 100%);
    box-shadow: 0 4px 12px rgba(255,149,0,0.25);
  }
  
  .status-badge.danger {
    background: linear-gradient(135deg, var(--danger) 0%, #ff6b6b 100%);
    box-shadow: 0 4px 12px rgba(255,59,48,0.25);
  }
  
  .preview-box {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    max-height: 500px;
    overflow-y: auto;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
    position: relative;
  }
  
  .preview-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--gradient-qub);
    opacity: 0.3;
  }
  
  .preview-text {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;
    font-size: 0.9375rem;
    line-height: 1.7;
    white-space: pre-wrap;
    color: var(--text);
    font-weight: 500;
  }
  
  .preview-placeholder {
    text-align: center;
    padding: 4rem 1rem;
    color: var(--text-secondary);
  }
  
  .preview-placeholder-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.3;
    animation: float 3s ease-in-out infinite;
  }
  
  /* Progress Bar */
  .progress-bar {
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 999px;
    margin: 1.5rem 0;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
  }
  
  .progress-fill {
    height: 100%;
    background: var(--success-gradient);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 999px;
    box-shadow: 0 0 12px rgba(52,199,89,0.4);
  }
  
  .progress-fill.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #ffa726 100%);
    box-shadow: 0 0 12px rgba(255,149,0,0.4);
  }
  
  .progress-fill.danger {
    background: var(--danger);
  }
  
  /* Toast */
  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%);
    color: white;
    padding: 1.25rem 2rem;
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    transform: translateY(150%) scale(0.9);
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
    z-index: 10000;
    opacity: 0;
    font-weight: 600;
    letter-spacing: -0.01em;
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
  }
  
  .toast.show {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  
  .toast::before {
    content: '‚úì';
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--success-gradient);
    border-radius: 50%;
    font-size: 16px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(52,199,89,0.4);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .hero h2 {
      font-size: 2.5rem;
    }
    
    .preset-cards {
      grid-template-columns: 1fr;
    }
    
    .workflow-selector {
      flex-direction: column;
      width: 100%;
    }
    
    .header-content {
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .toast {
      left: 1rem;
      right: 1rem;
      bottom: 1rem;
    }
  }
  
  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }
  
  ::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: 999px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--border) 0%, var(--text-tertiary) 100%);
    border-radius: 999px;
    border: 3px solid var(--bg-tertiary);
    transition: background 0.3s;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--text-tertiary) 0%, var(--text-secondary) 100%);
  }
  
  /* Hidden */
  .hidden {
    display: none !important;
  }
  
  /* Utility classes */
  .w-100 {
    width: 100%;
  }
  
  .min-h-200 {
    min-height: 200px;
  }
  
  .mt-1half {
    margin-top: 1.5rem;
  }
  
  /* Radio group styles */
  .radio-group {
    display: flex;
    gap: 1.25rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .radio-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: color 0.2s;
  }
  
  .radio-group label:hover {
    color: var(--primary);
  }
  
  .radio-group input[type="radio"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary);
    cursor: pointer;
  }
  
  /* Muted text */
  .muted {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-top: 0.75rem;
  }
  
  /* Help text */
  .help {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
    margin-top: 0.5rem;
  }
  
  /* Helper message */
  .helper-message {
    background: linear-gradient(135deg, rgba(224,0,27,0.05) 0%, rgba(224,0,27,0.02) 100%);
    border-left: 4px solid var(--primary);
    padding: 1.25rem 1.5rem;
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    box-shadow: 0 4px 12px rgba(224,0,27,0.08);
  }
  
  .helper-message-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
    color: var(--primary);
  }
  
  .helper-message-text {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: var(--text);
  }
  
  .helper-message-text strong {
    font-weight: 700;
    color: var(--text);
  }
  
  /* Preview actions row */
  .preview-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  
  /* Utility classes additions */
  .centered {
    margin-left: auto;
    margin-right: auto;
  }
  
  .align-center {
    text-align: center;
  }
  
  .help {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  
  .kb {
    font-size: 0.8125rem;
    line-height: 1.45;
  }
  
  .tooltip {
    border-bottom: 1px dotted #8aa;
    cursor: help;
  }
  
  .row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  fieldset {
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1.75rem 2rem;
    margin-bottom: 2rem;
    background: white;
    box-shadow: var(--shadow);
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  fieldset:hover {
    border-color: var(--text-tertiary);
    box-shadow: var(--shadow-md);
  }
  
  legend {
    font-weight: 700;
    padding: 0 0.75rem;
    color: var(--text);
    font-size: 1.125rem;
    letter-spacing: -0.01em;
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    color: var(--text);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    letter-spacing: -0.01em;
  }
  
  .btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  /* FAQ Section */
  .faq-section {
    max-width: 1200px;
    margin: 6rem auto 4rem;
    padding: 0 2rem;
    animation: fadeInUp 0.8s ease-out 0.7s both;
  }
  
  .gradient-title {
    font-size: 3.5rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 3rem;
    letter-spacing: -0.03em;
    line-height: 1.1;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 25%, #d946ef 50%, #ec4899 75%, #f43f5e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    background-size: 200% auto;
    animation: gradientShift 8s ease infinite;
  }
  
  .faq-title {
    font-size: 3.5rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 3rem;
    letter-spacing: -0.03em;
    line-height: 1.1;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 25%, #d946ef 50%, #ec4899 75%, #f43f5e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    background-size: 200% auto;
    animation: gradientShift 8s ease infinite;
  }
  
  .faq-items {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  
  .faq-item {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .faq-item:hover {
    box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    transform: translateY(-4px);
  }
  
  .faq-question {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.75rem 2rem;
    cursor: pointer;
    background: white;
    transition: all 0.3s;
    -webkit-user-select: none;
    user-select: none;
    gap: 1.5rem;
  }
  
  .faq-question:hover {
    background: linear-gradient(135deg, rgba(224,0,27,0.02) 0%, transparent 100%);
  }
  
  .faq-question-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.01em;
    line-height: 1.5;
    flex: 1;
  }
  
  .faq-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    font-size: 1.25rem;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .faq-item.open .faq-icon {
    transform: rotate(180deg);
    background: var(--gradient-qub);
    color: white;
    box-shadow: 0 4px 12px rgba(224,0,27,0.25);
  }
  
  .faq-answer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), padding 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0 2rem;
  }
  
  .faq-item.open .faq-answer {
    max-height: 1000px;
    padding: 0 2rem 2rem;
  }
  
  .faq-answer-text {
    font-size: 1rem;
    line-height: 1.75;
    color: var(--text-secondary);
    padding-top: 0.5rem;
    border-top: 2px solid var(--bg-tertiary);
  }
  
  .faq-answer-text strong {
    color: var(--text);
    font-weight: 600;
  }
  
  .faq-answer-text ul {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }
  
  .faq-answer-text li {
    margin-bottom: 0.5rem;
  }
</style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="brand">
      <img src="qub-logo.png" alt="Queen's University Belfast" />
      <h1>Prompt Builder</h1>
    </div>
    
    <div class="workflow-selector">
      <button class="workflow-btn active" data-tab="quiz" onclick="switchWorkflow('quiz')">Canvas Quiz</button>
      <button class="workflow-btn" data-tab="study" onclick="switchWorkflow('study')">Study Guide</button>
      <button class="workflow-btn" data-tab="notes" onclick="switchWorkflow('notes')">From Notes</button>
      <button class="workflow-btn" data-tab="help" onclick="switchWorkflow('help')">Getting Started</button>
    </div>
  </div>
</header>

<!-- Hero Banner -->
<div class="hero-banner quiz-hero" id="heroBanner">
  <div class="hero-content">
    <div class="hero-badge">
      <span>‚ú®</span>
      <span id="heroBadgeText">Powered by AI & Queen's Beyond Blended Pedagogy</span>
    </div>
    <h1 class="hero-title" id="heroTitle">Transform Your Lectures into Learning Resources</h1>
    <p class="hero-subtitle" id="heroSubtitle">Generate Canvas quizzes and study guides from your Panopto lectures in seconds‚Äîaligned with Queen's teaching excellence standards</p>
  </div>
</div>

<main>
  <!-- Help Info Boxes (Hidden by default) -->
  <div class="info" id="about">
    <div class="section-title">
      <strong>About this tool</strong>
      <button class="btn" id="dismissAbout" title="Hide this message">‚úï</button>
    </div>
    <p class="kb">Choose a pedagogy approach, customise your settings, then paste the prompt into the Copilot sidebar with your Panopto lecture open. Copilot reads your captions/slides and produces a Canvas-ready QTI zip and a lecturer PDF, using only your materials.</p>
  </div>
  
  <!-- Quiz Workflow -->
  <div class="workflow-content quiz-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Canvas Quiz Maker</h2>
    
    <div class="info" id="preflight">
      <div class="section-title">
        <strong>‚ö° Panopto Preflight (1 minute)</strong>
        <button class="btn" id="hidePreflight" title="Hide this checklist">‚úï</button>
        </div>
      <ol class="kb" style="margin-top: 0.75rem; padding-left: 1.5rem;">
        <li style="margin-bottom: 0.5rem;">Open the full Panopto <em>Watch</em> page (not the small Canvas embed).</li>
        <li style="margin-bottom: 0.5rem;">Open <em>Captions</em> and <em>Contents/Slides</em> panels.</li>
        <li style="margin-bottom: 0.5rem;">Scroll the transcript to the bottom once (loads all captions).</li>
        <li>Open Copilot and enable <em>Use page content</em>/<em>Allow this page</em>.</li>
      </ol>
    </div>
    
    <!-- Customise Options (Now at Top) -->
    <div class="advanced-options" style="margin-bottom: 2rem;">
      <div class="advanced-header" id="advancedToggle">
        <span class="advanced-title">Customise Options</span>
        <span class="advanced-toggle open">‚ñº</span>
      </div>
      <div class="advanced-content open" id="advancedContent">
        
        <div class="form-grid">
          
          <div class="form-group">
            <label class="form-label" for="quizLang">Language</label>
            <select id="quizLang" title="Output language and terminology style. Default: English (UK).">
              <option value="en-GB" selected>English (UK)</option>
              <option value="ga-IE">Irish</option>
              <option value="cy-GB">Welsh</option>
              <option value="fr-FR">French</option>
              <option value="es-ES">Spanish</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="quizCount">Questions per type</label>
            <input type="number" id="quizCount" min="1" max="12" value="3" title="How many items to generate for each selected question type.">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="quizFeedback">Feedback level</label>
            <select id="quizFeedback" title="What students will see after answering.">
              <option value="off">Off ‚Äî no explanations</option>
              <option value="brief" selected>Brief ‚Äî 1-sentence rationale for the correct answer</option>
              <option value="detailed">Detailed ‚Äî explain the correct answer AND why each distractor is less accurate, with study tips</option>
            </select>
            <p class="help">This feedback appears to students when they review the Canvas quiz. It helps address misconceptions and supports revision.</p>
          </div>
        </div>
        
        <div class="form-group mt-1half">
          <label class="form-label">Pedagogy Preset</label>
          <select id="pedagogy" title="Sets tone and question style across disciplines.">
            <option>Concept Check (Retrieval)</option>
            <option>Worked Examples (Scaffolded)</option>
            <option>Case/Scenario-Based</option>
            <option>Debate / Critical Analysis</option>
            <option>Metacognitive Reflection</option>
            <option>Accessibility-First (UDL)</option>
          </select>
          <p class="help" id="pedBrief"></p>
        </div>
        
        <div class="form-group mt-1half">
          <label class="form-label">Question Types</label>
          <div class="chip-group" id="questionTypes"></div>
          <p class="help">Multiple Choice is a good default to check core understanding. You can add other Canvas-compatible types:
            <span class="tooltip" title="Multiple Answers: choose all that apply, scored with partial credit.">MA</span>,
            <span class="tooltip" title="True/False: two options; the prompt enforces valid structure in QTI.">TF</span>,
            <span class="tooltip" title="Short Answer: exact strings (or variants) are accepted.">SA</span>,
            <span class="tooltip" title="Essay: unscored text response; used as a fallback if a question can't be validated.">Essay</span>,
            <span class="tooltip" title="Numerical: exact value or tolerance range.">Numerical</span>,
            <span class="tooltip" title="Matching: valid pairs; if not possible, we auto-rewrite to MC/Essay.">Matching</span>.
          </p>
        </div>
        
    </div>
  </div>
  
    <!-- Primary Action -->
    <div class="primary-action">
      <button class="btn-primary" id="generateQuiz" onclick="copyPrompt();">
        üìã Copy Prompt to Clipboard
      </button>
    </div>
    
    <!-- Canvas How-To (Quiz Only) -->
    <div class="info" id="canvasHow">
      <div class="section-title">
        <strong>Using this in Canvas (New or Classic Quizzes)</strong>
        <button class="btn" id="hideCanvasHow" title="Hide instructions">‚úï</button>
        </div>
      <ol class="kb" style="margin-top: 1rem; padding-left: 1.5rem;">
        <li style="margin-bottom: 0.5rem;">Complete the Panopto preflight steps above (open Watch page, captions/slides panels, scroll transcript).</li>
        <li style="margin-bottom: 0.5rem;">Copy the prompt (button above) and paste it into Copilot sidebar. It will produce:
          <ul style="margin-top: 0.25rem; padding-left: 1.5rem;"><li>A QTI <code>.zip</code> for Canvas</li><li>A lecturer PDF</li></ul>
        </li>
        <li style="margin-bottom: 0.5rem;"><strong>Import to Canvas:</strong> In your course, go to <strong>Settings ‚Üí Import Course Content ‚Üí Content Type: QTI .zip file</strong>. Choose the downloaded ZIP and click <strong>Import</strong>.</li>
        <li style="margin-bottom: 0.5rem;">After import, check <strong>Quizzes</strong> (or <strong>Assignments</strong> for New Quizzes). If you only see an item bank, the importer auto-rewrote items‚Äîopen the bank and build a quiz from it.</li>
        <li>Review points, feedback, and availability dates; then publish.</li>
      </ol>
      <p class="help" style="margin-top: 0.75rem;"><strong>Note:</strong> If Copilot returns "INSUFFICIENT_PAGE_CONTENT", go back and ensure captions/contents panels are fully expanded and loaded.</p>
      </div>
    </div>
    
  <!-- Study Guide Workflow -->
  <div class="workflow-content study-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Study Guide Builder</h2>
    
    <!-- Study Guide Options -->
    <div class="advanced-options" style="margin-bottom: 2rem;">
      <div class="advanced-header" id="studyAdvancedToggle">
        <span class="advanced-title">Customise Study Guide</span>
        <span class="advanced-toggle open">‚ñº</span>
      </div>
      <div class="advanced-content open" id="studyAdvancedContent">
        
        <div class="form-group">
          <label class="form-label">Pedagogy Preset</label>
          <select id="studyPedagogy" title="Sets tone and structure across disciplines." onchange="state.studyPedagogy = this.value; document.getElementById('studyPedBrief').textContent = PEDAGOGY[this.value].brief; render();">
            <option>Concept Check (Retrieval)</option>
            <option>Worked Examples (Scaffolded)</option>
            <option>Case/Scenario-Based</option>
            <option>Debate / Critical Analysis</option>
            <option>Metacognitive Reflection</option>
            <option>Accessibility-First (UDL)</option>
          </select>
          <p class="help" id="studyPedBrief"></p>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Output Format</label>
            <div class="radio-group" style="gap:14px;">
              <label><input type="radio" name="sgFormat" value="pdf" onchange="state.sgFormat = this.value; render();"> PDF (A4)</label>
              <label><input type="radio" name="sgFormat" value="docx" checked onchange="state.sgFormat = this.value; render();"> Word (.docx)</label>
              <label><input type="radio" name="sgFormat" value="pptx" onchange="state.sgFormat = this.value; render();"> PPTX (16:9)</label>
            </div>
            <p class="help">Choose Word for editable study guides you can customise before distributing to students.</p>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="studyDepth">Depth</label>
            <select id="studyDepth" onchange="state.studyDepth = this.value; render();">
              <option value="quick">Quick (10‚Äì12 pages) ‚Äî 20‚Äì30 flashcards, 6‚Äì8 problems, concise explanations</option>
              <option value="standard" selected>Standard (18‚Äì25 pages) ‚Äî 25‚Äì40 flashcards, 10‚Äì15 problems, fuller detail</option>
              <option value="deep">Deep (30‚Äì40 pages) ‚Äî 35‚Äì50 flashcards, 12‚Äì18 problems, extensive explanations</option>
            </select>
            <p class="help">Depth controls thoroughness and quantity. Use Components below to choose which sections to include.</p>
          </div>
        </div>
        
        <div class="form-group mt-1half">
          <label class="form-label">Components (untick to exclude)</label>
          <div class="chip-group" id="studyComponents"></div>
          <p class="help">All ticked components will be included regardless of depth. Depth only affects detail level and quantity.</p>
        </div>
        
      </div>
        </div>

    <!-- Five Study Tools (Glasmorphic Cards) -->
    <div class="quick-start" id="studyToolsDeck" style="margin-top:1.5rem;">
      <div class="section-title">
        <span>Study Guide Tools</span>
        <span class="help">Pick a tool and copy its pre-built prompt to Copilot</span>
      </div>
      <div class="preset-cards" id="studyToolsGrid">
        <!-- Cards populated by JS -->
      </div>
    </div>
        
    <!-- Primary Action -->
    <div class="primary-action">
      <button class="btn-primary" id="generateStudy" onclick="copyPrompt();">
        üìã Copy Prompt to Clipboard
      </button>
      <p class="help" style="margin-top: 0.5rem;">Paste into Copilot with your Panopto Watch page (captions & contents open).</p>
    </div>
  </div>
  
  <!-- From Notes Workflow -->
  <div class="workflow-content notes-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Build From Your Notes</h2>
    
    <!-- Notes Input -->
    <div class="quick-start">
      <div class="section-title">Paste your notes</div>
      <textarea id="notesInput" placeholder="Paste your lecture notes here (plain text, headings, bullets)..." class="w-100 min-h-200"></textarea>
      <p class="help">Minimum 400 words recommended. Include headings and structure where possible.</p>
    </div>
    
    <!-- Notes Options -->
    <div class="advanced-options" style="margin-bottom: 2rem;">
      <div class="advanced-header" id="notesAdvancedToggle">
        <span class="advanced-title">Customise Output</span>
        <span class="advanced-toggle open">‚ñº</span>
        </div>
      <div class="advanced-content open" id="notesAdvancedContent">
        
        <div class="form-group">
          <label class="form-label">Pedagogy Preset</label>
          <select id="notesPedagogy" title="Sets tone and structure." onchange="state.notesPedagogy = this.value; document.getElementById('notesPedBrief').textContent = PEDAGOGY[this.value].brief; render();">
            <option>Concept Check (Retrieval)</option>
            <option>Worked Examples (Scaffolded)</option>
            <option>Case/Scenario-Based</option>
            <option>Debate / Critical Analysis</option>
            <option>Metacognitive Reflection</option>
            <option>Accessibility-First (UDL)</option>
          </select>
          <p class="help" id="notesPedBrief"></p>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Output Format</label>
            <div class="radio-group" style="gap:14px;">
              <label><input type="radio" name="notesFormat" value="pdf" onchange="state.notesFormat = this.value; render();"> PDF (A4)</label>
              <label><input type="radio" name="notesFormat" value="docx" checked onchange="state.notesFormat = this.value; render();"> Word (.docx)</label>
              <label><input type="radio" name="notesFormat" value="pptx" onchange="state.notesFormat = this.value; render();"> PPTX (16:9)</label>
        </div>
            <p class="help">Choose Word to edit and customise the study materials before sharing.</p>
          </div>
        </div>
        
      </div>
    </div>
    
    <!-- Primary Action -->
    <div class="primary-action">
      <button class="btn-primary" id="generateNotes" onclick="copyPrompt();">
        üìã Copy Prompt to Clipboard
      </button>
      <p class="help" style="margin-top: 0.5rem;">Paste into Copilot (no Panopto page needed for this workflow).</p>
    </div>
  </div>
  
  <!-- Preview Section (Shared) -->
  <div class="preview-section centered" id="previewSection">
    <div class="preview-header">
      <div class="section-title">Your Copilot Prompt</div>
      <div class="preview-stats">
        <div class="stat">
          <span>üìä</span>
          <span><span class="stat-value" id="charCount">0</span> chars (aim &lt; 8000)</span>
        </div>
        <span class="status-badge" id="statusBadge">
          <span>‚úì</span>
          <span id="statusText">Ready</span>
        </span>
      </div>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar"></div>
    </div>
    
    <div class="preview-actions" style="margin: 1rem 0; justify-content: space-between;">
      <span class="help">Paste into Copilot with your Panopto Watch page open. Ensure preflight steps are done.</span>
      <button class="btn-primary" id="copyTop" title="Copy the prompt" onclick="copyPrompt();">üìã Copy Prompt</button>
    </div>
    
    <div class="preview-box">
      <div class="preview-placeholder" id="previewPlaceholder">
        <div class="preview-placeholder-icon">üëÜ</div>
        <p>Customise your options above and your prompt will appear here</p>
      </div>
      <pre class="preview-text hidden" id="previewText"></pre>
    </div>
  </div>
  
  <!-- Help/Getting Started Workflow -->
  <div class="workflow-content help-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 0;">Getting Started with Prompt Builder</h2>
    
    <div class="quick-start" style="margin-bottom: 4rem; padding: 3rem;">
      <h3 style="font-size: 1.75rem; margin-bottom: 1.5rem; color: var(--text);">Quick Start Guide</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(147,51,234,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #3b82f6; box-shadow: 0 4px 20px rgba(59,130,246,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üé•</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Open Your Panopto Video</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Navigate to your Panopto Watch page (not the Canvas embed). Ensure captions and slides panels are open and scroll through the transcript once.</p>
        </div>
        
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(168,85,247,0.1) 0%, rgba(236,72,153,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #a855f7; box-shadow: 0 4px 20px rgba(168,85,247,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚öôÔ∏è</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Customise Your Settings</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Choose your pedagogy preset, question types, feedback level, and other options. The prompt updates automatically as you make changes.</p>
        </div>
        
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(236,72,153,0.1) 0%, rgba(244,63,94,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #ec4899; box-shadow: 0 4px 20px rgba(236,72,153,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚ú®</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Copy & Paste to Copilot</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Click "Copy Prompt" and paste it into Microsoft Copilot's sidebar. Copilot will read your Panopto page and generate your quiz or study guide!</p>
        </div>
      </div>
    </div>
    
    <h2 class="faq-title">Frequently Asked Questions</h2>
    
    <div class="faq-items">
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">How do I use the Prompt Builder with Panopto?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p><strong>Step-by-step (about 2 minutes):</strong></p>
            <ol>
              <li>Open your Panopto <em>Watch</em> page in a browser tab (avoid the small Canvas embed).</li>
              <li>Open the <strong>Captions/Transcript</strong> panel and the <strong>Contents/Slides</strong> panel. Scroll through the transcript once so all captions load.</li>
              <li>Open <strong>Microsoft Copilot</strong> in the sidebar and allow it to ‚ÄúUse page content‚Äù.</li>
              <li>In Prompt Builder, choose your <strong>Pedagogy preset</strong>, keep <strong>Multiple Choice</strong> as default (or add more types), and set the <strong>Feedback level</strong>.</li>
              <li>Click <strong>Copy Prompt</strong> and paste it into Copilot. It will read <em>only</em> your Panopto page (captions + slides) and generate the requested files.</li>
            </ol>
            <p class="help">Tip: If Copilot returns <code>INSUFFICIENT_PAGE_CONTENT</code>, reload the Panopto page, open both panels, scroll to the bottom of the transcript, and try again.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">What outputs does the Prompt Builder create?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <ul>
              <li><strong>Canvas Quiz package (QTI .zip):</strong> Standards‚Äëcompliant file that imports into Canvas (New or Classic Quizzes). Includes question stems, options, scoring, and optional per‚Äëchoice feedback.</li>
              <li><strong>Lecturer PDF (quiz version):</strong> One page per question with the answer key and concise teaching notes to help during delivery.</li>
              <li><strong>Study Guide / Notes Pack:</strong> A pedagogy‚Äëfirst resource (PDF, Word, or PPTX) containing an executive summary, learning outcomes, key concepts, worked examples or cases, a problem set with solutions, 20‚Äì40 flashcards, reflection prompts and (optionally) a two‚Äëweek study planner.</li>
            </ul>
            <p class="help">All outputs are created from your lecture materials only‚Äîno external sources are introduced.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">What are pedagogy presets and how do I choose one?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p>Presets shape the <strong>tone, structure and feedback style</strong> of what is generated, aligned with Queen‚Äôs <em>Beyond Blended</em> approach:</p>
            <ul>
              <li><strong>Concept Check (Retrieval):</strong> Short, focused questions that probe essential ideas and common misconceptions.</li>
              <li><strong>Worked Examples (Scaffolded):</strong> Step‚Äëby‚Äëstep reasoning with ‚Äúwhy this step‚Äù notes and common slips.</li>
              <li><strong>Case/Scenario‚ÄëBased:</strong> Realistic vignettes that ask students to apply ideas; one answer is most defensible from the lecture.</li>
              <li><strong>Debate / Critical Analysis:</strong> Contrast positions and justify the preferred option using evidence from slides/captions.</li>
              <li><strong>Metacognitive Reflection:</strong> Prompts that surface process, limits and next steps (great for short‚Äëanswer / essay).</li>
              <li><strong>Accessibility‚ÄëFirst (UDL):</strong> Plain UK English, clear structure, and inclusive phrasing; avoids jargon and culture‚Äëbound idioms.</li>
            </ul>
            <p class="help">Choose the preset that matches your intended learning outcome. You can still edit the prompt details before copying.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">How do I import the quiz into Canvas?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <ol>
              <li>In your Canvas course go to <strong>Settings ‚Üí Import Course Content</strong>.</li>
              <li>Set <strong>Content Type</strong> to <strong>QTI .zip file</strong>, choose the downloaded file (e.g., <code>Lecture_5_‚Ä¶_quiz_qti.zip</code>) and click <strong>Import</strong>.</li>
              <li>After processing, check <strong>Quizzes</strong>. For New Quizzes, the item also appears in <strong>Assignments</strong>.</li>
              <li>If you only see an <strong>Item Bank</strong>, open it and build a quiz from those questions‚ÄîCanvas sometimes does this automatically.</li>
              <li>Open the quiz to review points, availability, and <strong>Student Feedback</strong> settings; then <strong>Publish</strong>.</li>
            </ol>
            <p class="help">Troubleshooting: If Canvas shows ‚ÄúNo question type used‚Ä¶‚Äù, the QTI was malformed. Regenerate using this tool‚Äôs latest prompt and ensure only Canvas‚Äësupported types are selected.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">Can I customize the generated content?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p><strong>Yes.</strong> The app lets you tailor:</p>
            <ul>
              <li><strong>Question types & counts:</strong> Start with Multiple Choice, then add others as needed.</li>
              <li><strong>Feedback level:</strong> Off, Brief, or Detailed‚Äîcontrols what students see after answering.</li>
              <li><strong>Pedagogy preset:</strong> Sets style, depth and feedback tone.</li>
              <li><strong>Study Guide components:</strong> Toggle concept map, glossary, worked examples, cases, problem set, flashcards, reflections and planner.</li>
              <li><strong>Output format:</strong> PDF/Word/PPTX for study guides; QTI + PDF for quizzes.</li>
            </ul>
            <p class="help">Everything generated is editable: you can revise wording in the PDF/Word/PPTX and change quiz settings in Canvas.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">Is my content secure and private?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p>This tool runs entirely in your browser and only creates a <em>prompt</em>. Your materials are not uploaded to our servers. When you paste the prompt into Microsoft Copilot, your data is handled under Microsoft‚Äôs terms and your institutional account settings.</p>
            <ul>
              <li>The prompt instructs Copilot to use <strong>only</strong> your Panopto captions/slides or notes and to avoid external sources.</li>
              <li>No student data is processed.</li>
              <li>Generated files are saved locally by you.</li>
            </ul>
            <p class="help"><strong>Disclaimer:</strong> We aim for accuracy and accessibility, but AI outputs can contain errors or omissions. Always review before sharing with students. If you spot an issue, regenerate or edit the output.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <footer style="max-width:1400px;margin:3rem auto 2rem;padding:1.5rem 2rem;border-top:2px solid var(--border);text-align:center;color:var(--text-secondary);">
    <p style="margin-bottom:0.5rem;"><strong>Teaching & Training Unit ‚Äì D&IS, Queen‚Äôs University Belfast</strong></p>
    <p style="margin-bottom:0.5rem;">Patrick Phillips ‚Ä¢ Support & enquiries: <a href="mailto:p.phillips@qub.ac.uk" style="color:inherit; text-decoration:underline;">p.phillips@qub.ac.uk</a></p>
    <p style="font-size:0.875rem;">We strive to create high‚Äëquality resources aligned with Queen‚Äôs pedagogy. However, AI‚Äëgenerated content may contain inaccuracies. Always review outputs for accuracy, inclusivity and accessibility before use.</p>
  </footer>
</main>

<!-- Help Button -->
<button class="help-toggle" id="helpToggle">
  <span class="help-toggle-icon">?</span>
  <span>Need Help?</span>
</button>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <span>‚úì</span>
  <span>Prompt copied to clipboard!</span>
</div>

<script>
function exposePanoptoTranscriptForCopilot() {
  try {
    // Gather candidate text fragments
    const nodes = document.querySelectorAll('.transcript * , .caption, .caption-text, [class*="transcript"] span, [class*="caption"] span');
    const texts = Array.from(nodes).map(n => (n.innerText || '').trim()).filter(Boolean);
    const full = texts.join(' ').replace(/\s+/g, ' ').trim();
    // Only expose if sufficiently long and not already present
    if (full.length > 300 && !document.getElementById('copilot-visible-transcript')) {
      const helper = document.createElement('div');
      helper.id = 'copilot-visible-transcript';
      helper.textContent = full;
      helper.style.cssText = 'position:fixed;left:-99999px;top:-99999px;white-space:pre-wrap;visibility:visible;height:auto;width:1px;';
      document.body.appendChild(helper);
    }
  } catch(e) {
    console.warn('Transcript expose failed:', e);
  }
}
</script>
<script>
// Make Panopto transcript text visible to Copilot's DOM reader (no UI impact)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', exposePanoptoTranscriptForCopilot);
} else {
  exposePanoptoTranscriptForCopilot();
}
// Pedagogy presets (QUB-aligned)
const PEDAGOGY = {
  "Concept Check (Retrieval)": {
    brief: "Quick checks of core ideas. Tight stems, one clearly best answer, and distractors based on likely misunderstandings.",
    inject: [
      "Use retrieval-practice style questions that check essential concepts from the lecture.",
      "Distractors must reflect plausible misunderstandings taken from the lecture wording only.",
      "Brief feedback explains the correct idea and points to a timestamp if detectable."
    ]
  },
  "Worked Examples (Scaffolded)": {
    brief: "Step-by-step problem solving with hints that fade. Great for methods and processes.",
    inject: [
      "Prefer worked-example prompts with ordered steps.",
      "Add a short 'why this step' note; in detailed feedback include 'common slip' guidance."
    ]
  },
  "Case/Scenario-Based": {
    brief: "Apply the lecture ideas to realistic situations; one answer is most defensible from the material.",
    inject: [
      "Frame items as short scenarios derived strictly from lecture captions/slides.",
      "Provide one best answer; others can be reasonable but less supported."
    ]
  },
  "Debate / Critical Analysis": {
    brief: "Compare viewpoints; justify the preferred answer with evidence from the lecture.",
    inject: [
      "Pose contrastive options; mark the one most defensible by the lecture evidence.",
      "Feedback references the relevant slide/timestamp where possible."
    ]
  },
  "Metacognitive Reflection": {
    brief: "Students reflect on process, limits, and next steps. Good as SA/Essay.",
    inject: [
      "Include prompts that ask students to explain approach and next steps tied to outcomes.",
      "Prefer short-answer or essay for depth where MC is weak."
    ]
  },
  "Accessibility-First (UDL)": {
    brief: "Plain UK English, inclusive phrasing, and multiple means of representation.",
    inject: [
      "Ensure each item stands alone without images; suggest alt text when PDF is generated.",
      "Avoid idioms and culturally specific references."
    ]
  }
};

// State
let state = {
  workflow: 'quiz',
  pedagogy: 'Concept Check (Retrieval)',
  quizTitle: '',
  quizLang: 'en-GB',
  quizCount: 3,
  quizFeedback: 'brief',
  questionTypes: ['multiple_choice_question'],
  
  // Study Guide
  studyPedagogy: 'Concept Check (Retrieval)',
  sgFormat: 'docx',
  studyDepth: 'standard',
  studyComponents: {
    conceptMap: true,
    glossary: true,
    worked: true,
    problems: true,
    cases: true,
    selfcheck: true,
    reflect: true,
    planner: true
  },
  
  // From Notes
  notesPedagogy: 'Concept Check (Retrieval)',
  notesFormat: 'docx',
  notesInput: ''
};

const STUDY_COMPONENTS = [
  { id: 'conceptMap', label: 'Concept Map' },
  { id: 'glossary', label: 'Glossary' },
  { id: 'worked', label: 'Worked Examples' },
  { id: 'problems', label: 'Problem Set' },
  { id: 'cases', label: 'Case Vignettes' },
  { id: 'selfcheck', label: 'Self-Check Quiz' },
  { id: 'reflect', label: 'Reflection Prompts' },
  { id: 'planner', label: 'Study Planner' }
];

/* ---------- Study Components Chips (dynamic, reacts to UI) ---------- */
function mountStudyComponents() {
  const host = document.getElementById('studyComponents');
  if (!host) return;
  host.innerHTML = '';

  STUDY_COMPONENTS.forEach(comp => {
    // Determine active state from global 'state.studyComponents'
    const active = !!(state.studyComponents && state.studyComponents[comp.id]);

    const btn = document.createElement('button');
    btn.type = 'button';
    btn.className = 'chip' + (active ? ' active' : '');
    btn.setAttribute('data-id', comp.id);
    btn.setAttribute('aria-pressed', active ? 'true' : 'false');
    btn.textContent = comp.label;

    btn.addEventListener('click', () => {
      // Toggle state
      state.studyComponents[comp.id] = !state.studyComponents[comp.id];
      // Reflect UI
      btn.classList.toggle('active');
      btn.setAttribute('aria-pressed', btn.classList.contains('active') ? 'true' : 'false');
      // Re-render prompt preview
      if (typeof render === 'function') render();
    });

    host.appendChild(btn);
  });
}

// Rebuild chips if the preset changes (in case state resets elsewhere)
function refreshStudyComponentsFromState() {
  // Ensure all keys exist (defensive)
  STUDY_COMPONENTS.forEach(comp => {
    if (typeof state.studyComponents[comp.id] === 'undefined') {
      state.studyComponents[comp.id] = true;
    }
  });
  mountStudyComponents();
}

const QUESTION_TYPES = [
  { id: 'multiple_choice_question', label: 'Multiple Choice' },
  { id: 'multiple_answers_question', label: 'Multiple Answers' },
  { id: 'true_false_question', label: 'True/False' },
  { id: 'short_answer_question', label: 'Short Answer' },
  { id: 'essay_question', label: 'Essay' },
  { id: 'numerical_question', label: 'Numerical' },
  { id: 'matching_question', label: 'Matching' }
];

/* ---------- Initialisation: mount chips once DOM is ready ---------- */
document.addEventListener('DOMContentLoaded', () => {
  try {
    refreshStudyComponentsFromState();
  } catch (e) {
    console.warn('Study components init failed:', e);
  }
  try {
    mountStudyToolCards();
  } catch (e) {
    console.warn('Study tools deck failed:', e);
  }
});

// DOM helpers
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);

// Detect Panopto title (enhanced)
function detectPanoptoTitle() {
  const og = document.querySelector('meta[property="og:title"]')?.content?.trim();
  const data = document.querySelector('[data-role="session-title"], .session-title, .video-title')?.textContent?.trim();
  const doc = document.title?.trim();
  return og || data || doc || '';
}

const panoptoTitle = detectPanoptoTitle();

function slugify(s) {
  const a = (s || '').normalize('NFKD').replace(/[^\x00-\x7F]/g, '');
  return (a.replace(/[^A-Za-z0-9]+/g, '_').replace(/_+/g, '_').replace(/^_+|_+$/g, '') || 'Lecture_Quiz');
}

// Panopto source block (compact)
const PANOPTO_BLOCK = `SOURCE: Read THIS Panopto page DOM: (1) Full captions/transcript, (2) Slides/contents, (3) Notes panel.

TITLE EXTRACTION (MANDATORY): Extract real video title from: <meta property="og:title">, [data-role="session-title"], h1, or document.title. Use ACTUAL title (e.g., "Week 5: Cell Division") NOT "Lecture Quiz" or placeholders. Use in filenames and file content.

FAIL-CLOSED: If <300 words after dedupe, return: "INSUFFICIENT_PAGE_CONTENT ‚Äî Open captions+slides panels, scroll transcript, then retry." No files.`;

// Prompt builders
function buildQuizPrompt() {
  const title = panoptoTitle || 'Lecture Quiz';
  const slug = slugify(title);
  const types = state.questionTypes.join(', ');
  const target = state.questionTypes.length * state.quizCount;
  const ped = PEDAGOGY[state.pedagogy] || PEDAGOGY["Concept Check (Retrieval)"];
  const pedBlock = ped.inject.map(l => `‚Ä¢ ${l}`).join('\n');
  
  let tfNum = '';
  if (state.questionTypes.includes('true_false_question')) tfNum += '\nTF: <response_lid> with 2 labels: True/False.';
  if (state.questionTypes.includes('numerical_question')) tfNum += '\nNUM: <response_num> + tolerance.';
  
  return `SYSTEM: Return EXACTLY 2 files: (1) ${slug}_quiz_qti.zip, (2) ${slug}_quiz.pdf
Use ONLY THIS Panopto page. Language=${state.quizLang}. Do NOT ask questions.
${PANOPTO_BLOCK}
PEDAGOGY: ${pedBlock}

HE STANDARDS: Clear stems testing outcomes (not trivia); plausible distractors from lecture; meaningful feedback explaining WHY with timestamps; mix Bloom levels; university-level precision.

Q TYPES: ${types} | ${state.quizCount} per type | TARGET=${target} exactly | Rewrite invalid as essay${tfNum}

QTI ZIP ‚Äî ${slug}_quiz_qti.zip:
imsmanifest.xml:
<?xml version="1.0" encoding="UTF-8"?>
<manifest identifier="man1" xmlns="http://www.imsglobal.org/xsd/imscp_v1p1">
  <resources><resource identifier="res1" type="imsqti_xmlv1p2" href="assessment.xml"><file href="assessment.xml"/></resource></resources>
</manifest>

assessment.xml:
<?xml version="1.0" encoding="UTF-8"?>
<questestinterop xmlns="http://www.imsglobal.org/xsd/ims_qtiasiv1p2">
  <assessment ident="asmt1" title="[ACTUAL_VIDEO_TITLE]"><section ident="root_section"><!-- ${target} items --></section></assessment>
</questestinterop>

MC ITEM:
<item ident="q1" title="Q1">
<itemmetadata><qtimetadata>
<qtimetadatafield><fieldlabel>question_type</fieldlabel><fieldentry>multiple_choice_question</fieldentry></qtimetadatafield>
<qtimetadatafield><fieldlabel>points_possible</fieldlabel><fieldentry>1</fieldentry></qtimetadatafield>
</qtimetadata></itemmetadata>
<presentation><material><mattext texttype="text/html">STEM</mattext></material>
<response_lid ident="response1" rcardinality="Single"><render_choice shuffle="Yes">
<response_label ident="A"><material><mattext texttype="text/html">OPT_A</mattext></material></response_label>
<response_label ident="B"><material><mattext texttype="text/html">OPT_B</mattext></material></response_label>
<response_label ident="C"><material><mattext texttype="text/html">OPT_C</mattext></material></response_label>
<response_label ident="D"><material><mattext texttype="text/html">OPT_D</mattext></material></response_label>
</render_choice></response_lid></presentation>
<resprocessing><outcomes><decvar varname="SCORE" vartype="Decimal" minvalue="0" maxvalue="100"/></outcomes>
<respcondition continue="No"><conditionvar><varequal respident="response1">CORRECT</varequal></conditionvar>
<setvar varname="SCORE" action="Set">100</setvar>${state.quizFeedback !== 'off' ? '<displayfeedback feedbacktype="Response" linkrefid="fb"/>' : ''}</respcondition></resprocessing>${state.quizFeedback !== 'off' ? '<itemfeedback ident="fb"><material><mattext texttype="text/html">WHY correct [mm:ss]</mattext></material></itemfeedback>' : ''}
</item>

GUARDS: UTF-8; escape XML chars; mattext‚â§1200; exactly ${target} items; all have metadata

PDF: A4. Title=[ACTUAL_VIDEO_TITLE], TOC, then 1Q/page: number, stem, options, answer${state.quizFeedback !== 'off' ? ', feedback+timestamp' : ''}

VALIDATE: (1) ‚â•300w or "INSUFFICIENT_PAGE_CONTENT", (2) Real title extracted, (3) ${target} items, (4) Valid XML, (5) All metadata, (6) HE quality (clear/defensible/plausible/meaningful), (7) Mixed Bloom, (8) Expert-approvable

OUTPUT: [ACTUAL_TITLE_SLUG]_quiz_qti.zip + [ACTUAL_TITLE_SLUG]_quiz.pdf using REAL title from og:title/[data-role="session-title"]/h1/document.title‚ÄîNOT "Lecture_Quiz" placeholder.`;
}

function buildStudyPrompt() {
  const panoptoTitle = detectPanoptoTitle();
  const title = panoptoTitle || 'Study Pack';
  const slug = slugify(title);
  const depth = state.studyDepth;
  const ped = PEDAGOGY[state.studyPedagogy] || PEDAGOGY["Concept Check (Retrieval)"];
  const c = state.studyComponents || {};
  const pedBlock = ped.inject.map(l => `‚Ä¢ ${l}`).join('\n');

  const depthNotes = {
    quick: {
      planner: 'Keep tasks tight (30‚Äì45 minute focus blocks) but still cover every evidence-backed activity.',
      rubric: 'Highlight rapid review loops and formative feedback hooks for compressed timelines.'
    },
    standard: {
      planner: 'Balance depth with pacing (45‚Äì60 minute sessions) so learners iterate through retrieval, application, and reflection.',
      rubric: 'Emphasise deliberate practice, spaced retrieval, and collaborative checkpoints.'
    },
    deep: {
      planner: 'Expect 60‚Äì80 minute sessions with extension readings or peer-led synthesis built in.',
      rubric: 'Surface opportunities for advanced synthesis, peer teaching, and disciplinary scholarship links.'
    }
  };
  const depthMeta = depthNotes[depth] || depthNotes.standard;

  const include = {
    conceptMap: !!c.conceptMap,
    glossary: !!c.glossary,
    worked: !!c.worked,
    problems: !!c.problems,
    cases: !!c.cases,
    selfcheck: !!c.selfcheck,
    reflect: !!c.reflect,
    planner: !!c.planner
  };

  const makePusher = () => { let n = 0; return (line) => { n += 1; return `${n}) ${line}`; }; };

  // Batch 1 ‚Äî Foundations (always)
  const push1 = makePusher();
  const batch1 = [];
  batch1.push(push1('Title page ‚Äî REAL LECTURE TITLE, module/course, date; 90‚Äì130 word ‚ÄúHow to use this guide‚Äù.'));
  batch1.push(push1('Learning outcomes ‚Äî 5 outcomes (10‚Äì18 words), ‚â•3 distinct Bloom verbs; 80‚Äì120 word ‚Äúalignment note‚Äù.'));
  batch1.push(push1('Threshold concepts ‚Äî 3‚Äì5 ideas; EACH 70‚Äì90 words incl. ‚Äúwhat changes in your thinking‚Äù + [mm:ss].'));
  batch1.push(push1('Key concepts ‚Äî ‚â•10 concepts; EACH 45‚Äì65 words incl. ‚Äúwhy it matters‚Äù + one [mm:ss].'));
  if (include.conceptMap) batch1.push(push1('Concept map ‚Äî 150‚Äì220 word narrative + list (10‚Äì14 nodes; 10‚Äì14 edges). Justify ‚â•4 edges with [mm:ss].'));

  // Batch 2 ‚Äî Practice (conditional)
  const push2 = makePusher();
  const batch2 = [];
  if (include.glossary) batch2.push(push2('Glossary ‚Äî ‚â•24 terms; EACH 22‚Äì35 words with a corpus-based example and [mm:ss]. Two-column table.'));
  if (include.worked && include.cases) {
    batch2.push(push2('Worked examples AND mini cases ‚Äî total 5 items (‚âà3 worked + 2 cases). EACH 150‚Äì200 words with: Steps (ordered) or Scenario; Why this step/teaching point; Common slip; ‚ÄúCheck you can‚Ä¶‚Äù; [mm:ss].'));
  } else if (include.worked) {
    batch2.push(push2('Worked examples ‚Äî 5 items; EACH 150‚Äì200 words with: Steps (ordered); Why this step; Common slip; ‚ÄúCheck you can‚Ä¶‚Äù; [mm:ss].'));
  } else if (include.cases) {
    batch2.push(push2('Mini cases ‚Äî 5 vignettes; EACH 150‚Äì200 words with: Scenario; Questions; Teaching points; Common slip; ‚ÄúCheck you can‚Ä¶‚Äù; [mm:ss].'));
  }
  if (include.problems) batch2.push(push2('Problem set (interleaved) ‚Äî 16 items: Recall (6), Application (6), Extension/Transfer (4). EACH item: Prompt; Hint (15‚Äì30 words); Full solution (50‚Äì90 words); ‚ÄúWhy this is correct‚Äù (25‚Äì50 words); [mm:ss].'));
  if (include.selfcheck) batch2.push(push2('Self-check quiz ‚Äî 14 items (MC/SA). Answer key for EACH item: Correct answer; 15‚Äì30 word rationale; 1 likely misconception; [mm:ss].'));

  // Batch 3 ‚Äî Extension (conditional; flashcards always included here)
  const push3 = makePusher();
  const batch3 = [];
  if (include.reflect) batch3.push(push3('Self-explanation / reflection prompts ‚Äî 6‚Äì8 prompts linked to outcomes; include [mm:ss].'));
  if (include.planner) batch3.push(push3(`Two-week study planner ‚Äî 14 rows (Day 1‚Äì14). 1‚Äì2 specific tasks/day (e.g., FC-01‚Äì10; Problems 1‚Äì4; rewatch [12:33‚Äì18:10]); include time estimate columns. ${depthMeta.planner}`));
  batch3.push(push3('Flashcards ‚Äî 45 cards. For EACH: ID, Q (retrieval), A (precise), 1-sentence explanation (connection), Difficulty (Fdn/Int/Adv), Related IDs, Source [mm:ss]. Include **Appendix B ‚Äî Flashcards CSV** with all fields.'));
  batch3.push(push3('Group tasks (seminar-ready) ‚Äî 3 activities (think-pair-share; jigsaw; mini-debate) tailored to THIS topic; 120‚Äì180 words each with outcomes link and [mm:ss].'));
  batch3.push(push3(`Authentic practice task ‚Äî 1 realistic ungraded task (150‚Äì220 words) with criteria (mini rubric: 3 rows √ó 3 levels) and feedback timing/method. ${depthMeta.rubric}`));

  // Batch 4 ‚Äî Support (always)
  const push4 = makePusher();
  const batch4 = [];
  batch4.push(push4('UDL & accessibility audit ‚Äî ‚â•7 checkpoints USED with concrete alternatives from THIS content; include two ‚Äúif you can‚Äôt access X, do Y‚Äù lines.'));
  batch4.push(push4('Where to get help ‚Äî short signposting paragraph (Queen‚Äôs links may be placeholders); inclusive phrasing.'));
  batch4.push(push4('Appendix A ‚Äî Evidence snippets ‚Äî ‚â•24 unique quoted fragments (5‚Äì20 words) with [mm:ss], grouped by section.'));
  batch4.push(push4('Appendix B ‚Äî Flashcards CSV ‚Äî full table of all flashcards.'));

  const floors = [];
  floors.push('Threshold ‚â•3; Key concepts ‚â•10;');
  if (include.glossary) floors.push('Glossary ‚â•24;');
  if (include.worked || include.cases) floors.push('Examples/Cases =5;');
  if (include.problems) floors.push('Problems =16;');
  if (include.selfcheck) floors.push('Self-check =14;');
  floors.push('Flashcards =45; Rewatch =8;');
  if (include.planner) floors.push('Planner has 14 rows;');
  floors.push('Group tasks =3; UDL checkpoints ‚â•7;');

  const batches = [];
  batches.push({ id: 1, key: 'foundations', sections: batch1, suffix: 'part1_foundations', title: 'Foundations' });
  if (batch2.length) batches.push({ id: 2, key: 'practice', sections: batch2, suffix: 'part2_practice', title: 'Practice' });
  if (batch3.length) batches.push({ id: 3, key: 'extension', sections: batch3, suffix: 'part3_extension', title: 'Extension' });
  batches.push({ id: 4, key: 'support', sections: batch4, suffix: 'part4_support', title: 'Support & Appendices' });

  const batchPrompts = batches.map(b => {
    const filestr = `[REAL_TITLE_SLUG]_study_${b.suffix}.docx`;
    const structure = `STRUCTURE for this batch (build ONLY these sections; full prose; embed [mm:ss] evidence in each):
${b.sections.join('\n')}`;
    const validate = `VALIDATE before returning this batch (FAIL-CLOSED):
1) Corpus ‚â•500 words; REAL title in H1 + filename match; NO placeholders.
2) Evidence: ‚â•1 timestamp in EVERY section in this batch${b.key === 'support' ? ' + ‚â•24 in Appendix A' : ''}.
3) Floors relevant to this batch are met (global floors: ${floors.join(' ')}).
4) Clear UK English; visually scannable with headings/tables.
5) Output EXACTLY ONE .docx named ${filestr}.`;
    return `BATCH ${b.id} ‚Äî ${b.title}
Return ONE file only: ${filestr} (Word A4). Do NOT ask questions. Do NOT use external sources. Do NOT include planning/coverage/validation text in the output.

PANOPTO SOURCE (NON-NEGOTIABLE)
‚Ä¢ This is a Panopto Watch page. Use ONLY: (a) full captions/transcript (deduped, time-ordered), (b) visible slides/contents text.
‚Ä¢ Extract REAL lecture title from <meta property="og:title"> OR [data-role="session-title"] OR .session-title OR document.title. Use the ACTUAL title in the document and filename.
‚Ä¢ If combined corpus (captions+slides) < 500 words after dedupe ‚Üí STOP and return EXACTLY:
  ‚ÄúINSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll transcript fully, then retry.‚Äù

TITLE & FILENAME ENFORCEMENT (HARD FAIL)
‚Ä¢ Extract ACTUAL title from the page DOM. Create [REAL_TITLE_SLUG] by ASCII-normalising, replacing non-alphanumerics with underscores, collapsing repeats, trimming.
‚Ä¢ The first H1 MUST equal the ACTUAL title. Add a subtitle line: ‚Äú${b.title}‚Äù.
‚Ä¢ The output filename MUST be ‚Äú${filestr}‚Äù. If mismatch, STOP and return the INSUFFICIENT message.

ANTI-PLACEHOLDER / EVIDENCE RULES (HARD FAIL)
‚Ä¢ No placeholders or boilerplate.
‚Ä¢ Every section in THIS BATCH must include ‚â•1 quoted evidence snippet (5‚Äì20 words) with a [mm:ss] timestamp from THIS lecture.

QUEEN‚ÄôS PEDAGOGY CONTRACT (APPLY THROUGHOUT)
${pedBlock}
‚Ä¢ Outcomes alignment (where applicable) and mapping to this batch‚Äôs sections.
‚Ä¢ Beyond Blended pillars; participation mix; UDL ‚â•7 across the full study set (note which are realised in this batch).
‚Ä¢ Assessment & feedback elements relevant to this batch.
‚Ä¢ Style: UK English; student-facing clarity; WCAG-AA contrast; Queen‚Äôs red (#E0001B) accents.

WORKFLOW GUARDRAILS (INTERNAL ‚Äî DO NOT OUTPUT)
1) PLAN ‚Äî silently enumerate sections in this batch and item/word floors.
2) SOURCE ‚Äî deduped corpus from captions+slides; harvest timestamps.
3) DRAFT ‚Äî write and expand until floors met using ONLY lecture evidence.
4) VALIDATE ‚Äî compute counts; if any fail, revise and re-check.
5) NO STREAMING until VALIDATE passes for this batch.

${structure}

FORMAT & LAYOUT
‚Ä¢ Word A4. One major section per page; do NOT split a single problem across pages.
‚Ä¢ Use consistent headings; tables for Glossary, Planner, Flashcards CSV, and Rubric.

${validate}`;
  });

  const overall = `SYSTEM
You will generate MULTIPLE files, one batch at a time, to allow deep reasoning and complete coverage. Follow each BATCH block below in order. After finishing one batch and validating it, move on to the next. Do NOT merge files. Use the Panopto on-screen title for all filenames.`;

  const fullPrompt = [overall, ...batchPrompts].join('\n\n' + '-'.repeat(80) + '\n\n');
  return fullPrompt;
}

// -------- Study Tool Prompts (v13 with scroll/expand + Bloom intent) --------

function promptCoreConceptsV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_core_concepts.docx (Word A4).
Use only the Panopto Watch page. No external sources.

SOURCE PREPARATION
1. Confirm this is a Panopto ‚ÄúWatch‚Äù page.
2. Virtually scroll through and fully expand:
   ‚Äì ‚ÄúCaptions‚Äù / ‚ÄúTranscript‚Äù tab ‚Üí bottom
   ‚Äì ‚ÄúContents‚Äù / ‚ÄúSlides‚Äù tabs ‚Üí expand all
3. Wait until no new lines appear.
4. Extract and dedupe all caption + slide text (preserve [mm:ss]).
If corpus < 500 words ‚Üí
‚ÄúINSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll fully, then retry.‚Äù

TITLE & FILENAME
Extract REAL title from <meta property="og:title"> or [data-role="session-title"] or .session-title or document.title.
Use that title for H1 and filename [REAL_TITLE_SLUG]_study_core_concepts.docx.

TASK
Run all phases (collect ‚Üí analyse ‚Üí write ‚Üí validate ‚Üí output) automatically.
Do NOT pause or ask questions.

PURPOSE
Produce a timestamp-based conceptual study guide that explains key ideas and how they connect, using clear language and evidence.

STRUCTURE
1. Title page ‚Äî REAL title, module, date + 120-word ‚ÄúHow to use this guide‚Äù.
2. Learning outcomes ‚Äî 5 outcomes (10‚Äì18 words, ‚â• 3 Bloom levels) + 120-word alignment note.
3. Threshold concepts ‚Äî 3‚Äì5 ideas (80‚Äì110 words + [mm:ss]).
4. Key concepts ‚Äî ‚â• 12 concepts (55‚Äì75 words + [mm:ss]).
5. Concept map ‚Äî ‚âà 200 words (10‚Äì14 nodes/edges, ‚â• 6 timestamp links).
6. Appendix A ‚Äî ‚â• 24 quoted fragments (5‚Äì20 words + [mm:ss]).

BLOOM GUIDANCE (Student-friendly)
‚Ä¢ Remember = recall a definition or law
‚Ä¢ Understand = explain the idea in your own words
‚Ä¢ Apply = use the principle to solve a new problem
‚Ä¢ Analyse = break down parts and relationships
‚Ä¢ Evaluate = judge the best approach or solution
‚Ä¢ Create = design or combine ideas into something new

PEDAGOGY
Link concepts to outcomes; embed Beyond Blended pillars; apply ‚â•7 UDL checkpoints; UK English; QUB red #E0001B; WCAG-AA.

VALIDATION
Corpus ‚â• 500 words; ‚â• 3 thresholds; ‚â• 12 key concepts; ‚â• 24 timestamps; no placeholders; one .docx output.`;
}

function promptKnowledgeToolsV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_knowledge_tools.docx (Word A4).

SOURCE PREPARATION ‚Äî same scroll/expand steps as Prompt 1; fail if < 500 words.

PURPOSE
Turn lecture content into usable terminology and reasoning patterns that model expert thinking.

STRUCTURE
1. Glossary ‚Äî ‚â• 28 terms (25‚Äì35 words + authentic example + [mm:ss]).
2. Worked examples ‚Äî 3 (180‚Äì220 words): Context; Steps; Why; Common slip; ‚ÄúCheck you can‚Ä¶‚Äù + [mm:ss] and a short intent note (e.g., apply/analyse).
3. Mini cases ‚Äî 2 (180‚Äì220 words) with decision-making analysis + [mm:ss].
4. Appendix A ‚Äî ‚â• 24 timestamped quotes.

PEDAGOGY
Link each term/example to outcomes; Bloom Apply/Analyse via intent phrasing; ‚â•7 UDL checkpoints; Beyond Blended alignment; UK English.

VALIDATION
Glossary ‚â• 28; Examples = 3; Cases = 2; ‚â• 24 timestamps; no duplicates; one .docx output.`;
}

function promptPracticeTestingV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_practice_testing.docx (Word A4).

SOURCE PREPARATION ‚Äî scroll and expand captions & slides; fail if < 500 words.

TASK
Auto-run (collect ‚Üí topic-seed ‚Üí draft ‚Üí validate ‚Üí output). Do not ask for confirmation.

PURPOSE
Build a practice and testing section that develops retrieval and reasoning with clear feedback and Bloom-intent explanations.

STRUCTURE
1. Intro ‚Äî 100-word ‚ÄúHow to use this section‚Äù explaining that each task targets a different thinking skill.
2. Problem set ‚Äî 16 unique items (6 Recall, 6 Apply/Analyse, 4 Evaluate/Create).
   Each: Prompt ‚â§25 words; Hint 20‚Äì35; Solution 60‚Äì110 + [mm:ss];
   Why Correct 40‚Äì60; Common Misconception ‚â§25; short cognitive intent phrase.
3. Self-check quiz ‚Äî 14 MC/SA items on different topics; each with answer, 20‚Äì35 word rationale, misconception, [mm:ss], and cognitive intent note.
4. Mini-rubric excerpt (3 criteria √ó 3 levels).
5. Appendix A ‚Äî ‚â• 24 timestamped quotes.

PEDAGOGY
Use ‚â•5 distinct lecture topics; Balance Bloom levels; Beyond Blended (Pace, Flex, Support); ‚â•7 UDL checkpoints; UK English.

VALIDATION
16 unique problems (‚â•5 topics); 14 quiz items; ‚â•24 timestamps; no duplicates; one .docx output.`;
}

function promptReflectionPlanningV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_reflection_planning.docx (Word A4).

SOURCE PREPARATION ‚Äî scroll & expand captions/slides fully; fail if < 500 words.

PURPOSE
Develop self-reflection and study planning skills based on timestamped lecture evidence and awareness of thinking levels.

STRUCTURE
1. Reflection prompts ‚Äî 6‚Äì8 questions (each with a brief intent phrase like ‚ÄúThis helps you evaluate ‚Ä¶‚Äù + [mm:ss]).
2. Rewatch guide ‚Äî 8 clip intervals [mm:ss‚Äìmm:ss] with ‚Äúwatch for‚Ä¶‚Äù and an active task + intent note.
3. Two-week planner ‚Äî 14 rows with task, time estimate, and thinking skill column.
4. Appendix A ‚Äî ‚â• 24 timestamped quotes.

PEDAGOGY
Link to outcomes; Beyond Blended (Pace & Flex); ‚â•7 UDL checkpoints; inclusive UK English.

VALIDATION
‚â•6 reflections; 8 rewatch segments; 14-day planner; ‚â•24 timestamps; one .docx output.`;
}

function promptExtensionSupportV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_extension_support.docx (Word A4).

SOURCE PREPARATION ‚Äî scroll and expand captions/slides to bottom; fail if < 500 words.

PURPOSE
Provide long-term retrieval, collaboration, and inclusive learning support based on lecture evidence.

STRUCTURE
1. Flashcards ‚Äî 45 items across ‚â•6 topics; each = ID; Question; Answer; 1-sentence connection; Difficulty (Fdn/Int/Adv + brief intent phrase); Related IDs; [mm:ss].
   Include Appendix B ‚Äî CSV table (all fields).
2. Group tasks ‚Äî 3 activities (think-pair-share, jigsaw, mini-debate) 140‚Äì180 words + [mm:ss] and intent descriptions.
3. Authentic practice task ‚Äî 1 task (170‚Äì220 words + 3√ó3 rubric & feedback plan).
4. UDL & Accessibility audit ‚Äî ‚â•9 checkpoints with practical alternatives.
5. Where to get help ‚Äî inclusive signposting (QUB links ok).
6. Appendix A ‚Äî ‚â•24 timestamped quotes.

PEDAGOGY
Spaced retrieval + social learning; map items to outcomes; Beyond Blended (Flex, Support); ‚â•9 UDL checkpoints; UK English.

VALIDATION
45 flashcards (all fields complete); 3 group tasks; UDL ‚â•9; ‚â•24 timestamps; no placeholders; one .docx output.`;
}

// Registry for tool cards
const STUDY_TOOLS = [
  { id:'core', icon:'üìö', name:'Core Concepts', desc:'Foundational understanding, thresholds, key concepts, concept map, evidence appendix.', builder: promptCoreConceptsV13 },
  { id:'knowledge', icon:'üõ†Ô∏è', name:'Knowledge Tools', desc:'Glossary + worked examples and mini cases with timestamped evidence.', builder: promptKnowledgeToolsV13 },
  { id:'practice', icon:'üß†', name:'Practice & Testing', desc:'Interleaved problems + self-check quiz with feedback and misconceptions.', builder: promptPracticeTestingV13 },
  { id:'reflect', icon:'üîÅ', name:'Reflection & Planning', desc:'Metacognitive prompts, rewatch guide, and a two-week study planner.', builder: promptReflectionPlanningV13 },
  { id:'support', icon:'üåê', name:'Extension & Support', desc:'Flashcards, group tasks, UDL audit, and help routes.', builder: promptExtensionSupportV13 },
];

function mountStudyToolCards(){
  const grid = document.getElementById('studyToolsGrid');
  if(!grid) return;
  grid.innerHTML = '';
  STUDY_TOOLS.forEach(tool=>{
    const card = document.createElement('div');
    card.className = 'preset-card';
    card.innerHTML = `
      <div class="tool-badge">${tool.icon} ${tool.name}</div>
      <div class="preset-desc" style="margin:.25rem 0 0;">${tool.desc}</div>
      <div class="tool-actions">
        <button class="btn-primary" data-tool="${tool.id}">üìã Copy Prompt</button>
        <button class="btn btn-ghost" data-preview="${tool.id}">üëÅ Preview</button>
      </div>`;
    grid.appendChild(card);
  });

  grid.querySelectorAll('button[data-tool]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-tool');
      const tool = STUDY_TOOLS.find(t=>t.id===id);
      if(!tool) return;
      const prompt = tool.builder();
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(prompt).then(()=>{
          showToast();
          setPreview(prompt);
        }).catch(()=>{
          setPreview(prompt);
        });
      } else {
        setPreview(prompt);
      }
    });
  });
  grid.querySelectorAll('button[data-preview]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-preview');
      const tool = STUDY_TOOLS.find(t=>t.id===id);
      if(!tool) return;
      const prompt = tool.builder();
      setPreview(prompt);
    });
  });
}

function setPreview(text){
  const placeholder = $('previewPlaceholder');
  const pre = $('previewText');
  if(placeholder) placeholder.classList.add('hidden');
  if(pre){
    pre.textContent = text;
    pre.classList.remove('hidden');
  }
  if($('charCount')) $('charCount').textContent = (text||'').length.toString();

  const progress = $('progressBar');
  const statusBadge = $('statusBadge');
  const statusText = $('statusText');
  const len = (text || '').length;
  const pct = Math.min(100, (len / 8000) * 100);
  if(progress){
    progress.style.width = pct + '%';
    progress.classList.remove('danger', 'warning');
    if (len >= 8000) {
      progress.classList.add('danger');
    } else if (len > 7500) {
      progress.classList.add('warning');
    }
  }
  if(statusBadge && statusText){
    statusBadge.className = 'status-badge';
    statusText.textContent = 'Ready';
    if (len >= 8000) {
      statusBadge.className = 'status-badge danger';
      statusText.textContent = 'Too long';
    } else if (len > 7500) {
      statusBadge.className = 'status-badge warning';
      statusText.textContent = 'Near limit';
    }
  }
}

function showToast(){
  const t = $('toast');
  if(!t) return;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1800);
}

function buildNotesPrompt() {
  const slug = 'Lecture_Notes_Pack';
  const format = state.notesFormat;
  const ped = PEDAGOGY[state.notesPedagogy] || PEDAGOGY["Concept Check (Retrieval)"];
  const pedBlock = ped.inject.map(l => `‚Ä¢ ${l}`).join('\n');
  const ext = format === 'pptx' ? 'pptx' : (format === 'docx' ? 'docx' : 'pdf');
  const fmt = format === 'pptx' ? 'PPTX 16:9' : (format === 'docx' ? 'Word A4' : 'PDF A4');

  return `SYSTEM
Return ONE file only: \${slug}.\${ext}. Do NOT ask questions. Do NOT use external sources. Do NOT include planning/coverage/validation text in the output.

SOURCE (NOTES ONLY)
‚Ä¢ Parse the pasted notes: headings, bullets, tables; dedupe; keep author wording.
‚Ä¢ TITLE: Extract from the first H1/line of the notes (or ‚ÄúNotes Pack‚Äù if absent). Use in the document and filename.
‚Ä¢ If usable note text < 400 words after cleaning ‚Üí STOP and return EXACTLY:
  ‚ÄúINSUFFICIENT_PAGE_CONTENT ‚Äî Add more notes (‚â•400 words with headings) and retry.‚Äù

QUEEN‚ÄôS PEDAGOGY CONTRACT
\${pedBlock}
‚Ä¢ Outcomes alignment, Beyond Blended pillars, participation mix, UDL (‚â•6 checkpoints), assessment & feedback, engagement & support, tools & fallbacks, QA trace, UK English & WCAG‚ÄëAA.

WORKFLOW GUARDRAILS (INTERNAL ‚Äî DO NOT OUTPUT)
1) PLAN ‚Äî silently enumerate ALL required sections and floors below.
2) DRAFT ‚Äî generate each section to meet floors; expand thin sections using ONLY the provided notes.
3) VALIDATE ‚Äî compute section word counts and item counts; if any fail, revise and re‚Äëcheck. Only then render the final file.
4) NO STREAMING until VALIDATE passes. Do NOT include plan/coverage/validation text in the output.

STRUCTURE & FLOORS (build ALL sections; add [section anchors] for easy navigation)
1) Title + ‚ÄúHow to use this pack‚Äù (‚â§120 words)
2) Learning outcomes ‚Äî 4‚Äì6 outcomes + alignment note
3) Key concepts ‚Äî 6‚Äì12 concepts (2‚Äì3 sentences each)
4) Concept map ‚Äî short narrative + list of nodes/links
5) Glossary ‚Äî 15‚Äì30 terms with examples from the notes
6) Worked examples / cases ‚Äî 4‚Äì6 items with steps/why/slips OR scenario/questions/teaching points
7) Problem set ‚Äî 8‚Äì12 items with hint + full solution + rationale
8) Self‚Äëcheck quiz ‚Äî 10‚Äì14 items; concise rationale in answer key
9) Flashcards ‚Äî 25‚Äì45 cards with: ID, Q, A, Explanation (connection), Difficulty, Related IDs; include a CSV appendix
10) Reflection prompts ‚Äî 5‚Äì7 metacognitive questions
11) Independent study (‚â§180 words) ‚Äî safe practice; help routes (QUB placeholders)
12) Accessibility & alternatives ‚Äî list UDL checkpoints and specific alternatives

FORMAT RULES
‚Ä¢ Use \${fmt}. Headings and section order must match above; UK English; Queen‚Äôs red (#E0001B) accents; WCAG AA.

VALIDATE BEFORE RETURNING
1) Notes ‚â•400 words; 2) Title extracted; 3) ALL sections present; 4) ‚â•6 UDL checkpoints; 5) Problem set has hint+solution+rationale; 6) Flashcards have all fields; 7) Self‚Äëcheck has rationales; 8) Student‚Äëfacing clarity.`;
}

// Render preview
function render() {
  let prompt = '';
  if (state.workflow === 'quiz') prompt = buildQuizPrompt();
  if (state.workflow === 'study') prompt = buildStudyPrompt();
  if (state.workflow === 'notes') prompt = buildNotesPrompt();
  const len = prompt.length;
  $('charCount').textContent = len;
  
  // Update progress bar and status
  const pct = Math.min(100, (len / 8000) * 100);
  $('progressBar').style.width = pct + '%';
  
  if (len >= 8000) {
    $('progressBar').classList.add('danger');
    $('progressBar').classList.remove('warning');
    $('statusBadge').className = 'status-badge danger';
    $('statusText').textContent = 'Too long';
  } else if (len > 7500) {
    $('progressBar').classList.add('warning');
    $('progressBar').classList.remove('danger');
    $('statusBadge').className = 'status-badge warning';
    $('statusText').textContent = 'Near limit';
  } else {
    $('progressBar').classList.remove('danger', 'warning');
    $('statusBadge').className = 'status-badge';
    $('statusText').textContent = 'Ready';
  }
  
  // Show preview
  if (prompt) {
    $('previewPlaceholder').classList.add('hidden');
    $('previewText').classList.remove('hidden');
    $('previewText').textContent = prompt;
  } else {
    $('previewPlaceholder').classList.remove('hidden');
    $('previewText').classList.add('hidden');
  }
}

// Copy to clipboard
function copyPrompt() {
  // Rebuild the prompt right now to ensure it's fresh
  let prompt = '';
  if (state.workflow === 'quiz') prompt = buildQuizPrompt();
  if (state.workflow === 'study') prompt = buildStudyPrompt();
  if (state.workflow === 'notes') prompt = buildNotesPrompt();
  
  if (!prompt || prompt.trim() === '') {
    console.error('No prompt generated!');
    alert('No prompt to copy yet. Please ensure you have selected your options.');
    return;
  }
  
  // Try to copy
  console.log('Attempting to copy...');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    console.log('Using navigator.clipboard API');
    navigator.clipboard.writeText(prompt).then(() => {
      console.log('Copy successful!');
      // Show toast
      $('toast').classList.add('show');
      setTimeout(() => $('toast').classList.remove('show'), 2000);
    }).catch(err => {
      console.error('Clipboard API failed:', err);
      alert('Failed to copy to clipboard: ' + err.message);
    });
  } else {
    console.log('Using fallback copy method');
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = prompt;
    ta.style.position = 'fixed';
    ta.style.top = '0';
    ta.style.left = '0';
    ta.style.opacity = '0';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try { 
      const success = document.execCommand('copy');
      console.log('execCommand copy result:', success);
      if (success) {
        // Show toast
        $('toast').classList.add('show');
        setTimeout(() => $('toast').classList.remove('show'), 2000);
      } else {
        alert('Copy failed. Please try manually selecting and copying the text below.');
      }
    } catch(e) {
      console.error('execCommand failed:', e);
      alert('Failed to copy: ' + e.message);
    }
    document.body.removeChild(ta);
  }
}

// Init question type chips
function initQuestionTypes() {
  const container = $('questionTypes');
  container.innerHTML = '';
  QUESTION_TYPES.forEach(type => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (state.questionTypes.includes(type.id) ? ' active' : '');
    chip.textContent = type.label;
    chip.onclick = () => {
      if (state.questionTypes.includes(type.id)) {
        state.questionTypes = state.questionTypes.filter(t => t !== type.id);
      } else {
        state.questionTypes.push(type.id);
      }
      chip.classList.toggle('active');
      render();
    };
    container.appendChild(chip);
  });
}

// Init study components chips
function initStudyComponents() {
  const container = $('studyComponents');
  if (!container) {
    console.warn('studyComponents container not found');
    return;
  }
  console.log('Initializing study components, current state:', state.studyComponents);
  container.innerHTML = '';
  STUDY_COMPONENTS.forEach(comp => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (state.studyComponents[comp.id] ? ' active' : '');
    chip.textContent = comp.label;
    chip.onclick = () => {
      console.log('Component clicked:', comp.id, 'was:', state.studyComponents[comp.id]);
      state.studyComponents[comp.id] = !state.studyComponents[comp.id];
      chip.classList.toggle('active');
      console.log('Component now:', state.studyComponents[comp.id]);
  render();
    };
    container.appendChild(chip);
  });
}

// Init
function init() {
  // Update pedagogy brief on load (quiz)
  const p = PEDAGOGY[state.pedagogy];
  if (p) $('pedBrief').textContent = p.brief;
  
  // Update pedagogy brief on load (study guide)
  const sp = PEDAGOGY[state.studyPedagogy];
  if (sp && $('studyPedBrief')) $('studyPedBrief').textContent = sp.brief;
  
  // Update pedagogy brief on load (notes)
  const np = PEDAGOGY[state.notesPedagogy];
  if (np && $('notesPedBrief')) $('notesPedBrief').textContent = np.brief;
  
  // Hero content for each page
  const heroContent = {
    quiz: {
      badge: 'Canvas Quiz Builder',
      title: 'Create Perfect Quizzes in Seconds',
      subtitle: 'Transform your Panopto lectures into Canvas-ready quizzes with AI‚Äîaligned with Queen\'s Beyond Blended pedagogy',
      class: 'quiz-hero'
    },
    study: {
      badge: 'Study Guide Generator',
      title: 'Build Comprehensive Study Resources',
      subtitle: 'Generate rich, pedagogy-first study guides with flashcards, problems, and reflections from your lectures',
      class: 'study-hero'
    },
    notes: {
      badge: 'Notes to Resources',
      title: 'Transform Notes into Study Packs',
      subtitle: 'Convert your lecture notes into structured, student-ready study materials with expert guidance',
      class: 'notes-hero'
    },
    help: {
      badge: 'Getting Started',
      title: 'Welcome to Prompt Builder',
      subtitle: 'Learn how to create amazing educational resources in minutes with AI-powered tools',
      class: 'help-hero'
    }
  };
  
  // Help button - navigate to Getting Started page
  if ($('helpToggle')) {
    $('helpToggle').onclick = () => {
      $$('.workflow-btn').forEach(b => b.classList.remove('active'));
      const helpBtn = document.querySelector('[data-tab="help"]');
      if (helpBtn) {
        helpBtn.classList.add('active');
        state.workflow = 'help';
        $$('.workflow-content').forEach(w => w.classList.add('hidden'));
        document.querySelector('.help-workflow').classList.remove('hidden');
        
        // Hide preview section and update hero banner
        const previewSection = $('previewSection');
        if (previewSection) previewSection.style.display = 'none';
        
        const hero = heroContent.help;
        if (hero) {
          const heroBanner = $('heroBanner');
          heroBanner.className = 'hero-banner ' + hero.class;
          $('heroBadgeText').textContent = hero.badge;
          $('heroTitle').textContent = hero.title;
          $('heroSubtitle').textContent = hero.subtitle;
        }
        // Ensure FAQ gets initialized when entering help
        setTimeout(() => {
          if (typeof setupFaqAccordion === 'function') setupFaqAccordion();
        }, 0);
      }
    };
  }
  
  // Dismiss handlers
  if ($('dismissAbout')) {
    $('dismissAbout').onclick = () => {
      $('about').classList.remove('show');
    };
  }
  
  if ($('hidePreflight')) {
    $('hidePreflight').onclick = () => {
      $('preflight').classList.remove('show');
    };
  }
  
  if ($('hideCanvasHow')) {
    $('hideCanvasHow').onclick = () => {
      $('canvasHow').classList.remove('show');
    };
  }
  
  initQuestionTypes();
  initStudyComponents();
  render();
  
  // Show the quiz workflow by default on page load
  const defaultWorkflow = document.querySelector('.quiz-workflow');
  if (defaultWorkflow) {
    defaultWorkflow.classList.remove('hidden');
  }
  // Ensure the Quiz tab is visually active on load
  const quizBtn = document.querySelector('[data-tab="quiz"]');
  if (quizBtn) quizBtn.classList.add('active');
  
  // Attach progressive enhancement handlers in case inline onClick is stripped
  $$('.workflow-btn').forEach(btn => {
    btn.addEventListener('click', () => switchWorkflow(btn.dataset.tab));
  });

  // Last-resort: delegate clicks anywhere in the document to catch edge cases
  document.addEventListener('click', (ev) => {
    const btn = ev.target && ev.target.closest && ev.target.closest('.workflow-btn');
    if (btn && btn.dataset && btn.dataset.tab) {
      ev.preventDefault();
      switchWorkflow(btn.dataset.tab);
    }
  }, true);

  // Expose switchWorkflow for inline onclick
  window.switchWorkflow = function(tab) {
    if (!tab) return;
    // Update active state
    $$('.workflow-btn').forEach(b => b.classList.remove('active'));
    const activeBtn = document.querySelector('[data-tab="' + tab + '"]');
    if (activeBtn) activeBtn.classList.add('active');
    state.workflow = tab;

    // Toggle content visibility
    $$('.workflow-content').forEach(w => w.classList.add('hidden'));
    const target = document.querySelector('.' + tab + '-workflow');
    if (target) target.classList.remove('hidden');

    // Update hero banner
    const hero = heroContent[state.workflow];
    if (hero) {
      const heroBanner = $('heroBanner');
      heroBanner.className = 'hero-banner ' + hero.class;
      $('heroBadgeText').textContent = hero.badge;
      $('heroTitle').textContent = hero.title;
      $('heroSubtitle').textContent = hero.subtitle;
    }

    if (state.workflow === 'study') {
      setTimeout(() => {
        try {
          mountStudyToolCards();
        } catch (e) {
          console.warn('Study tools deck failed:', e);
        }
      }, 0);
    }

    // Show/hide preview section
    const previewSection = $('previewSection');
    if (previewSection) previewSection.style.display = (state.workflow === 'help') ? 'none' : 'block';

    // Re-setup FAQ when switching to help page
    if (state.workflow === 'help') {
      setTimeout(() => {
        if (typeof setupFaqAccordion === 'function') setupFaqAccordion();
      }, 0);
    } else {
      render();
    }
  };
  
  // Pedagogy selector
  $('pedagogy').addEventListener('change', () => {
    state.pedagogy = $('pedagogy').value;
    const p = PEDAGOGY[state.pedagogy];
    $('pedBrief').textContent = p?.brief || '';
    render();
  });
  
  // Preset cards - Study
  $$('.study-workflow .preset-card').forEach(card => {
    if (card.closest('#studyToolsDeck')) return;
    card.onclick = () => {
      $$('.study-workflow .preset-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      state.format = card.dataset.format;
      render();
    };
  });
  
  // Preset cards - Notes
  $$('.notes-workflow .preset-card').forEach(card => {
    card.onclick = () => {
      $$('.notes-workflow .preset-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      state.notesOutput = card.dataset.notesOutput;
      render();
    };
  });
  
  // Advanced toggles
  $('advancedToggle').onclick = () => {
    $('advancedContent').classList.toggle('open');
    $('advancedToggle').querySelector('.advanced-toggle').classList.toggle('open');
  };
  
  if ($('studyAdvancedToggle')) {
  $('studyAdvancedToggle').onclick = () => {
    $('studyAdvancedContent').classList.toggle('open');
    $('studyAdvancedToggle').querySelector('.advanced-toggle').classList.toggle('open');
  };
  }
  
  if ($('notesAdvancedToggle')) {
    $('notesAdvancedToggle').onclick = () => {
      $('notesAdvancedContent').classList.toggle('open');
      $('notesAdvancedToggle').querySelector('.advanced-toggle').classList.toggle('open');
    };
  }
  
  // Form inputs - Quiz
  if ($('quizTitle')) {
    $('quizTitle').oninput = e => { state.quizTitle = e.target.value; render(); };
  }
  const quizLangEl = $('quizLang');
  if (quizLangEl) {
    quizLangEl.onchange = e => { state.quizLang = e.target.value; render(); };
  }
  const quizCountEl = $('quizCount');
  if (quizCountEl) {
    quizCountEl.oninput = e => { state.quizCount = +e.target.value; render(); };
  }
  const quizFeedbackEl = $('quizFeedback');
  if (quizFeedbackEl) {
    quizFeedbackEl.onchange = e => { state.quizFeedback = e.target.value; render(); };
  }
  
  // Form inputs - Study Guide (using inline handlers, no duplicates needed)
  
  // Form inputs - From Notes (using inline handlers, no duplicates needed)
  if ($('notesInput')) {
    $('notesInput').oninput = e => { state.notesInput = e.target.value; render(); };
  }
  
  // Copy buttons
  if ($('generateQuiz')) {
    console.log('Wiring generateQuiz button');
  $('generateQuiz').onclick = copyPrompt;
  }
  if ($('generateStudy')) {
    console.log('Wiring generateStudy button');
  $('generateStudy').onclick = copyPrompt;
  }
  if ($('generateNotes')) {
    console.log('Wiring generateNotes button');
  $('generateNotes').onclick = copyPrompt;
  }
  if ($('copyTop')) {
    console.log('Wiring copyTop button');
    $('copyTop').onclick = copyPrompt;
  }
  
  // FAQ Accordion - robust setup with measured heights
  function setupFaqAccordion() {
    const items = document.querySelectorAll('.faq-item');
    if (!items || items.length === 0) return;
    items.forEach(item => {
      const question = item.querySelector('.faq-question');
      const answer = item.querySelector('.faq-answer');
      if (!question || !answer) return;

      // Ensure collapsed state baseline
      item.classList.remove('open');
      answer.style.maxHeight = '0px';
      question.setAttribute('role', 'button');
      question.setAttribute('tabindex', '0');
      question.setAttribute('aria-expanded', 'false');

      const toggle = () => {
        // Close others first
        document.querySelectorAll('.faq-item.open').forEach(other => {
          if (other !== item) {
            other.classList.remove('open');
            const otherAns = other.querySelector('.faq-answer');
            const otherQ = other.querySelector('.faq-question');
            if (otherAns) otherAns.style.maxHeight = '0px';
            if (otherQ) otherQ.setAttribute('aria-expanded', 'false');
          }
        });

        // Toggle this one
        const isOpen = item.classList.toggle('open');
        question.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        if (isOpen) {
          // Measure content height
          const inner = answer.querySelector('.faq-answer-text');
          const h = inner ? (inner.scrollHeight + 32) : 300; // padding guard
          answer.style.maxHeight = h + 'px';
        } else {
          answer.style.maxHeight = '0px';
        }
      };

      question.onclick = toggle;
      question.onkeydown = (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          toggle();
        }
      };
    });
  }

  // Initial setup
  setupFaqAccordion();
}

init();
</script>

</body>
</html>
