<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Panopto Canvas Prompt Builder</title>
<link rel="icon" type="image/png" href="favicon.png" />
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
  
  * { margin:0; padding:0; box-sizing:border-box; }
  
  :root {
    --qub: #E0001B;
    --qub-red: #E0001B;
    --primary: #E0001B;
    --primary-hover: #b00016;
    --primary-gradient: linear-gradient(135deg, #E0001B 0%, #ff4757 100%);
    --success: #34c759;
    --success-gradient: linear-gradient(135deg, #34c759 0%, #00d9ff 100%);
    --warning: #ff9500;
    --danger: #ff3b30;
    --bg: #fafafa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #f0f2f5;
    --text: #0a0a0a;
    --text-secondary: #6b7280;
    --text-tertiary: #9ca3af;
    --border: #e5e7eb;
    --shadow: 0 4px 20px rgba(0,0,0,0.06);
    --shadow-md: 0 8px 30px rgba(0,0,0,0.08);
    --shadow-lg: 0 20px 60px rgba(0,0,0,0.12);
    --shadow-xl: 0 30px 80px rgba(0,0,0,0.15);
    --radius: 16px;
    --radius-lg: 24px;
    --radius-xl: 32px;
    --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --gradient-qub: linear-gradient(135deg, #E0001B 0%, #ff4757 50%, #ff6b81 100%);
  }
  
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-20px); }
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }
  
  @keyframes gradientShift {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    position: relative;
    overflow-x: hidden;
  }
  
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    right: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(224,0,27,0.03) 0%, transparent 70%);
    animation: float 20s ease-in-out infinite;
    pointer-events: none;
    z-index: 0;
  }
  
  body::after {
    content: '';
    position: fixed;
    bottom: -50%;
    left: -50%;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle, rgba(102,126,234,0.03) 0%, transparent 70%);
    animation: float 25s ease-in-out infinite reverse;
    pointer-events: none;
    z-index: 0;
  }
  
  /* Header */
  header {
    background: rgba(255,255,255,0.8);
    -webkit-backdrop-filter: blur(30px) saturate(180%);
    backdrop-filter: blur(30px) saturate(180%);
    border-bottom: 1px solid rgba(224,0,27,0.1);
    padding: 1.25rem 2rem;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: fadeInUp 0.6s ease-out;
  }
  
  header:hover {
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.08);
  }
  
  .header-content {
    max-width: 1400px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: relative;
    z-index: 1;
  }
  
  .brand {
    display: flex;
    align-items: center;
    gap: 14px;
    position: relative;
    z-index: 1;
  }
  
  .brand img {
    height: 32px;
    transition: transform 0.3s ease;
    filter: drop-shadow(0 2px 8px rgba(224,0,27,0.15));
  }
  
  .brand img:hover {
    transform: scale(1.05);
  }
  
  .brand h1 {
    font-size: 1.35rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }
  
  .logo {
    display: flex;
    align-items: center;
    gap: 0.875rem;
    font-size: 1.35rem;
    font-weight: 700;
  }
  
  .logo-icon {
    width: 42px;
    height: 42px;
    background: var(--gradient-qub);
    background-size: 200% 200%;
    animation: gradientShift 8s ease infinite;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    box-shadow: 0 8px 24px rgba(224,0,27,0.25);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    position: relative;
    overflow: hidden;
  }
  
  .logo-icon::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
  }
  
  .logo-icon:hover {
    transform: rotate(-5deg) scale(1.1);
    box-shadow: 0 12px 32px rgba(224,0,27,0.35);
  }
  
  /* Navigation Menu */
  .workflow-selector {
    display: flex;
    gap: 2rem;
    align-items: center;
  }
  
  .workflow-btn {
    padding: 0.625rem 0;
    border: none;
    background: transparent;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-secondary);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    letter-spacing: -0.01em;
  }
  
  .workflow-btn::after {
    content: '';
    position: absolute;
    bottom: -3px;
    left: 0;
    width: 100%;
    height: 3px;
    background: var(--gradient-qub);
    border-radius: 999px;
    transform: scaleX(0);
    transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .workflow-btn:hover:not(.active) {
    color: var(--text);
  }
  
  .workflow-btn.active {
    color: var(--primary);
    font-weight: 700;
  }
  
  .workflow-btn.active::after {
    transform: scaleX(1);
  }
  
  /* Main Container */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 4rem 2rem;
    position: relative;
    z-index: 1;
  }
  
  /* Hero Banner */
  .hero-banner {
    position: relative;
    width: 100%;
    height: 400px;
    background: linear-gradient(135deg, rgba(224,0,27,0.85) 0%, rgba(147,51,234,0.85) 50%, rgba(59,130,246,0.85) 100%), 
                url('QUB-gallery-image-lanyon-building.jpg') center/cover;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: white;
    overflow: hidden;
    margin-bottom: 4rem;
    transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .hero-banner.quiz-hero {
    background: linear-gradient(135deg, rgba(224,0,27,0.85) 0%, rgba(147,51,234,0.85) 50%, rgba(59,130,246,0.85) 100%), 
                url('QUB-gallery-image-lanyon-building.jpg') center/cover;
  }
  
  .hero-banner.study-hero {
    background: linear-gradient(135deg, rgba(16,185,129,0.85) 0%, rgba(59,130,246,0.85) 100%), 
                url('_S6A0583a.jpg') center/cover;
  }
  
  .hero-banner.notes-hero {
    background: linear-gradient(135deg, rgba(245,158,11,0.85) 0%, rgba(239,68,68,0.85) 100%), 
                url('1cdd84d4-b0ce-4901-9d10-6b47a02ed554.jpg') center/cover;
  }
  
  .hero-banner.help-hero {
    background: linear-gradient(135deg, rgba(124,58,237,0.85) 0%, rgba(236,72,153,0.85) 100%), 
                url('QUB-gallery-image-lanyon-building.jpg') center/cover;
  }
  
  .hero-banner::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(circle at 30% 50%, rgba(255,255,255,0.15) 0%, transparent 50%);
    animation: float 20s ease-in-out infinite;
  }
  
  .hero-content {
    position: relative;
    z-index: 1;
    max-width: 1100px; /* allow wider single-line headings on desktop */
    padding: 0 2rem;
    animation: fadeInUp 0.8s ease-out 0.2s both;
  }
  
  .hero-title {
    font-size: clamp(2.25rem, 5.5vw, 4.5rem);
    font-weight: 800;
    line-height: 1.05;
    margin: 0 0 1.5rem;
    letter-spacing: -0.03em;
    text-shadow: 0 4px 20px rgba(0,0,0,0.3);
    text-wrap: balance; /* nicer multi-line wrapping */
  }
  
  .hero-subtitle {
    font-size: clamp(1rem, 1.25vw, 1.35rem);
    line-height: 1.6;
    margin: 0;
    opacity: 0.95;
    font-weight: 400;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
    text-wrap: pretty; /* avoid orphan words */
  }

  @media (max-width: 1024px) {
    .hero-content { max-width: 900px; }
  }
  @media (max-width: 768px) {
    .hero-content { max-width: 700px; }
  }
  
  .hero-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1.25rem;
    background: rgba(255,255,255,0.2);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 999px;
    font-size: 0.9375rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255,255,255,0.3);
    text-wrap: balance;
  }
  
  /* Hero Section */
  .hero {
    max-width: 1000px;
    margin: 0 auto 4rem;
    text-align: center;
    display: none;
  }
  
  .hero h2 {
    font-size: 3.5rem;
    font-weight: 800;
    line-height: 1.1;
    margin: 0 0 1.5rem;
    letter-spacing: -0.03em;
    background: linear-gradient(135deg, var(--text) 0%, var(--text-secondary) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    position: relative;
  }
  
  .hero h2::after {
    content: '';
    position: absolute;
    bottom: -12px;
    left: 50%;
    transform: translateX(-50%);
    width: 80px;
    height: 5px;
    background: var(--gradient-qub);
    border-radius: 999px;
    opacity: 0.6;
  }
  
  .hero p {
    font-size: 1.25rem;
    color: var(--text-secondary);
    max-width: 680px;
    margin: 0 auto;
    line-height: 1.7;
    font-weight: 400;
  }
  
  .hero-sub {
    max-width: 920px;
    margin: 12px auto 0;
    color: var(--text-tertiary);
  }
  
  .info {
    max-width: 920px;
    margin: 2rem auto;
    padding: 2rem;
    border: 1px solid rgba(224,0,27,0.1);
    border-radius: var(--radius-lg);
    background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.7) 100%);
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
    box-shadow: var(--shadow-md);
    position: relative;
    overflow: hidden;
    display: none;
  }
  
  .info.show {
    display: block;
    animation: fadeInUp 0.4s ease-out both;
  }
  
  .info::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--gradient-qub);
  }
  
  /* Help Button */
  .help-toggle {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    z-index: 999;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.75rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #d946ef 100%);
    color: white;
    border: none;
    border-radius: 999px;
    font-size: 1.0625rem;
    font-weight: 600;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(124,58,237,0.3);
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .help-toggle:hover {
    transform: translateY(-4px) scale(1.05);
    box-shadow: 0 12px 32px rgba(124,58,237,0.5);
    background: linear-gradient(135deg, #6d28d9 0%, #9333ea 50%, #c026d3 100%);
  }
  
  .help-toggle-icon {
    font-size: 1.5rem;
    line-height: 1;
  }
  
  /* Quick Start Section */
  .quick-start {
    background: var(--bg-secondary);
    border-radius: var(--radius-xl);
    padding: 3rem;
    margin-bottom: 3rem;
    box-shadow: var(--shadow-md);
    border: 1px solid var(--border);
    animation: fadeInUp 0.8s ease-out 0.3s both;
  }
  
  .section-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }
  
  .preset-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 1.25rem;
    margin-bottom: 2rem;
  }
  
  .preset-card {
    background: white;
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  
  .preset-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gradient-qub);
    opacity: 0;
    transition: opacity 0.4s;
    z-index: 0;
  }
  
  .preset-card:hover {
    border-color: var(--primary);
    transform: translateY(-8px) scale(1.02);
    box-shadow: var(--shadow-xl);
  }
  
  .preset-card:hover::before {
    opacity: 0.03;
  }
  
  .preset-card.active {
    border-color: var(--primary);
    background: linear-gradient(135deg, rgba(224,0,27,0.05) 0%, rgba(224,0,27,0.02) 100%);
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
  }
  
  .preset-icon {
    font-size: 3rem;
    margin-bottom: 0.75rem;
    position: relative;
    z-index: 1;
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .preset-card:hover .preset-icon {
    transform: scale(1.2) rotate(-5deg);
  }
  
  .preset-name {
    font-weight: 700;
    margin-bottom: 0.5rem;
    font-size: 1.125rem;
    position: relative;
    z-index: 1;
    letter-spacing: -0.01em;
  }
  
  .preset-desc {
    font-size: 0.9375rem;
    color: var(--text-secondary);
    line-height: 1.6;
    position: relative;
    z-index: 1;
  }

  .tool-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    background: rgba(224,0,27,0.08);
    border: 1px solid rgba(224,0,27,0.2);
    font-weight: 600;
    font-size: 0.8125rem;
    color: #E0001B;
    margin-bottom: 0.75rem;
  }
  
  .tool-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  
  .btn-ghost {
    background: transparent;
    border: 2px solid var(--border);
  }
  
  .btn-ghost:hover {
    border-color: var(--primary);
    color: var(--primary);
  }

  .study-tools-grid {
    display: grid;
    grid-template-columns: repeat(5, minmax(220px, 1fr));
    gap: 1.5rem;
  }

  @media (max-width: 1300px) {
    .study-tools-grid {
      grid-auto-flow: column;
      grid-auto-columns: minmax(220px, 260px);
      overflow-x: auto;
      padding-bottom: 0.5rem;
    }
  }

  .tool-card {
    min-height: 260px;
    padding: 2rem 1.75rem;
    background: #ffffff;
    color: var(--text);
    border-radius: var(--radius-xl);
    border: 6px solid var(--tool-accent, var(--primary));
    box-shadow: var(--shadow-lg);
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  .tool-card:hover {
    transform: none;
    box-shadow: 0 18px 45px rgba(17,24,39,0.12);
    border-color: var(--tool-accent, var(--primary));
  }

  .tool-card .tool-badge {
    background: var(--tool-badge-bg, rgba(224,0,27,0.12));
    border-color: var(--tool-accent, var(--primary));
    color: var(--tool-accent, var(--primary));
  }

  .tool-points {
    list-style: none;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    color: var(--text);
    font-size: 0.95rem;
    line-height: 1.45;
    flex: 1 1 auto;
  }

  .tool-points li {
    background: var(--tool-chip-bg, rgba(15,23,42,0.05));
    border: 1px solid var(--tool-chip-border, rgba(15,23,42,0.12));
    border-radius: 12px;
    padding: 0.6rem 0.85rem;
  }

  .tool-card .tool-actions {
    display: flex;
    flex-direction: column;
    gap: 0.7rem;
    width: 100%;
  }

  .tool-card .btn-primary {
    width: 100%;
    justify-content: center;
    background: var(--tool-accent, var(--primary));
    color: #ffffff;
    border: none;
    box-shadow: none;
    font-weight: 700;
  }

  .tool-card .btn-primary:hover {
    background: var(--tool-accent-hover, var(--primary-hover));
  }

  .tool-card .btn-ghost {
    width: 100%;
    justify-content: center;
    background: #ffffff;
    border: 2px solid var(--tool-accent, var(--primary));
    color: var(--tool-accent, var(--primary));
    font-weight: 600;
  }

  .tool-card .btn-ghost:hover {
    background: var(--tool-accent, var(--primary));
    color: #ffffff;
  }

  .tool-card .btn-primary,
  .tool-card .btn-ghost {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.45rem;
    font-size: 1rem;
    white-space: nowrap;
  }

  .study-preview-panel {
    margin-top: 2rem;
    background: rgba(255,255,255,0.95);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    padding: 2rem;
  }

  .study-preview-panel.hidden {
    display: none;
  }

  .study-preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1rem;
  }

  .study-preview-title {
    font-size: 1.25rem;
    font-weight: 700;
    letter-spacing: -0.01em;
  }

  .study-preview-meta {
    font-size: 0.9rem;
    color: var(--text-secondary);
  }

  .study-preview-body {
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    background: #f9fafb;
    padding: 1.5rem;
    max-height: 420px;
    overflow-y: auto;
  }

  .study-preview-placeholder {
    color: var(--text-secondary);
    font-style: italic;
    text-align: center;
    padding: 2rem 1rem;
  }

  .study-preview-text {
    font-family: 'SFMono-Regular', Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 0.925rem;
    line-height: 1.6;
    white-space: pre-wrap;
    color: var(--text);
  }
  
  /* Primary Action */
  .primary-action {
    text-align: center;
    margin: 3rem 0;
  }
  
  .btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1.125rem 2.5rem;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #d946ef 100%);
    background-size: 200% 200%;
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 1.125rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 8px 24px rgba(124,58,237,0.3);
    position: relative;
    overflow: hidden;
    letter-spacing: -0.01em;
  }
  
  .btn-primary::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
    transform: rotate(45deg);
    animation: shimmer 3s infinite;
  }
  
  .btn-primary:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 16px 40px rgba(124,58,237,0.45);
    background: linear-gradient(135deg, #6d28d9 0%, #9333ea 50%, #c026d3 100%);
    background-position: 100% 50%;
  }
  
  .btn-primary:active {
    transform: translateY(-2px) scale(0.98);
  }
  
  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }
  
  .btn-secondary {
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    padding: 0.875rem 1.75rem;
    background: white;
    color: var(--text);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: -0.01em;
  }
  
  .btn-secondary:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }
  
  .btn-secondary:active {
    transform: translateY(-1px);
  }
  
  /* Advanced Options (Collapsible) */
  .advanced-options {
    background: white;
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    margin-bottom: 2rem;
    box-shadow: var(--shadow);
    overflow: hidden;
    animation: fadeInUp 0.8s ease-out 0.5s both;
  }
  
  .advanced-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.5rem 2rem;
    cursor: pointer;
    -webkit-user-select: none;
    user-select: none;
    transition: all 0.3s;
  }
  
  .advanced-header:hover {
    background: linear-gradient(135deg, rgba(224,0,27,0.02) 0%, transparent 100%);
  }
  
  .advanced-title {
    font-weight: 700;
    font-size: 1.25rem;
    letter-spacing: -0.02em;
  }
  
  .advanced-toggle {
    color: var(--text-secondary);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    font-size: 1.25rem;
  }
  
  .advanced-toggle.open {
    transform: rotate(180deg);
  }
  
  .advanced-content {
    display: none;
    padding: 0 2rem 2rem;
    border-top: 1px solid var(--border);
  }
  
  .advanced-content.open {
    display: block;
    animation: fadeInUp 0.4s ease-out;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
  }
  
  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .form-label {
    font-size: 0.9375rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.01em;
  }
  
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    padding: 0.875rem 1rem;
    border: 2px solid var(--border);
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    font-family: inherit;
    background: white;
  }
  
  input:hover,
  select:hover,
  textarea:hover {
    border-color: var(--text-tertiary);
  }
  
  input:focus,
  select:focus,
  textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(224,0,27,0.08);
    transform: translateY(-2px);
  }
  
  textarea {
    resize: vertical;
    min-height: 120px;
  }
  
  .chip-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.75rem;
  }
  
  .chip {
    padding: 0.625rem 1.125rem;
    background: white;
    border: 2px solid var(--border);
    border-radius: 999px;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    letter-spacing: -0.01em;
    position: relative;
    overflow: hidden;
  }
  
  .chip::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--gradient-qub);
    opacity: 0;
    transition: opacity 0.3s;
    z-index: 0;
  }
  
  .chip:hover {
    border-color: var(--primary);
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }
  
  .chip:hover::before {
    opacity: 0.05;
  }
  
  .chip.active {
    background: var(--gradient-qub);
    color: white !important;
    border-color: transparent;
    box-shadow: 0 6px 20px rgba(224,0,27,0.25);
    transform: translateY(-2px);
    position: relative;
    z-index: 2;
  }
  
  .chip.active::before {
    opacity: 1;
    z-index: -1;
  }
  
  .chip > * {
    position: relative;
    z-index: 3;
    color: inherit;
  }
  
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  /* Preview Section */
  .preview-section {
    background: white;
    border-radius: var(--radius-xl);
    padding: 2rem;
    box-shadow: var(--shadow-lg);
    border: 1px solid var(--border);
    animation: fadeInUp 0.8s ease-out 0.6s both;
    position: relative;
    overflow: hidden;
  }
  
  .preview-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: var(--gradient-qub);
  }
  
  .preview-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
    padding-top: 0.5rem;
  }
  
  .preview-stats {
    display: flex;
    align-items: center;
    gap: 2rem;
    font-size: 0.9375rem;
    color: var(--text-secondary);
  }
  
  .stat {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .stat-value {
    font-weight: 700;
    color: var(--text);
    font-size: 1.125rem;
  }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--success-gradient);
    color: white;
    border-radius: 999px;
    font-size: 0.875rem;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(52,199,89,0.25);
    letter-spacing: -0.01em;
  }
  
  .status-badge.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #ffa726 100%);
    box-shadow: 0 4px 12px rgba(255,149,0,0.25);
  }
  
  .status-badge.danger {
    background: linear-gradient(135deg, var(--danger) 0%, #ff6b6b 100%);
    box-shadow: 0 4px 12px rgba(255,59,48,0.25);
  }
  
  .preview-box {
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    max-height: 500px;
    overflow-y: auto;
    box-shadow: inset 0 2px 8px rgba(0,0,0,0.04);
    position: relative;
  }
  
  .preview-box::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--gradient-qub);
    opacity: 0.3;
  }
  
  .preview-text {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', Consolas, monospace;
    font-size: 0.9375rem;
    line-height: 1.7;
    white-space: pre-wrap;
    color: var(--text);
    font-weight: 500;
  }
  
  .preview-placeholder {
    text-align: center;
    padding: 4rem 1rem;
    color: var(--text-secondary);
  }
  
  .preview-placeholder-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    opacity: 0.3;
    animation: float 3s ease-in-out infinite;
  }
  
  /* Progress Bar */
  .progress-bar {
    height: 6px;
    background: var(--bg-tertiary);
    border-radius: 999px;
    margin: 1.5rem 0;
    overflow: hidden;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
  }
  
  .progress-fill {
    height: 100%;
    background: var(--success-gradient);
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    border-radius: 999px;
    box-shadow: 0 0 12px rgba(52,199,89,0.4);
  }
  
  .progress-fill.warning {
    background: linear-gradient(135deg, var(--warning) 0%, #ffa726 100%);
    box-shadow: 0 0 12px rgba(255,149,0,0.4);
  }
  
  .progress-fill.danger {
    background: var(--danger);
  }
  
  /* Toast */
  .toast {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    background: linear-gradient(135deg, #1d1d1f 0%, #2d2d2f 100%);
    color: white;
    padding: 1.25rem 2rem;
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 0 0 1px rgba(255,255,255,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    transform: translateY(150%) scale(0.9);
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s;
    z-index: 10000;
    opacity: 0;
    font-weight: 600;
    letter-spacing: -0.01em;
    -webkit-backdrop-filter: blur(20px);
    backdrop-filter: blur(20px);
  }
  
  .toast.show {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
  
  .toast::before {
    content: '‚úì';
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    background: var(--success-gradient);
    border-radius: 50%;
    font-size: 16px;
    font-weight: 700;
    box-shadow: 0 4px 12px rgba(52,199,89,0.4);
  }
  
  /* Responsive */
  @media (max-width: 768px) {
    .hero h2 {
      font-size: 2.5rem;
    }
    
    .preset-cards {
      grid-template-columns: 1fr;
    }
    
    .workflow-selector {
      flex-direction: column;
      width: 100%;
    }
    
    .header-content {
      flex-direction: column;
      gap: 1.5rem;
    }
    
    .form-grid {
      grid-template-columns: 1fr;
    }
    
    .toast {
      left: 1rem;
      right: 1rem;
      bottom: 1rem;
    }
  }
  
  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 12px;
    height: 12px;
  }
  
  ::-webkit-scrollbar-track {
    background: var(--bg-tertiary);
    border-radius: 999px;
  }
  
  ::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, var(--border) 0%, var(--text-tertiary) 100%);
    border-radius: 999px;
    border: 3px solid var(--bg-tertiary);
    transition: background 0.3s;
  }
  
  ::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, var(--text-tertiary) 0%, var(--text-secondary) 100%);
  }
  
  /* Hidden */
  .hidden {
    display: none !important;
  }
  
  /* Utility classes */
  .w-100 {
    width: 100%;
  }
  
  .min-h-200 {
    min-height: 200px;
  }
  
  .mt-1half {
    margin-top: 1.5rem;
  }
  
  /* Radio group styles */
  .radio-group {
    display: flex;
    gap: 1.25rem;
    align-items: center;
    flex-wrap: wrap;
  }
  
  .radio-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.9375rem;
    font-weight: 500;
    transition: color 0.2s;
  }
  
  .radio-group label:hover {
    color: var(--primary);
  }
  
  .radio-group input[type="radio"] {
    width: 20px;
    height: 20px;
    accent-color: var(--primary);
    cursor: pointer;
  }
  
  /* Muted text */
  .muted {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.6;
    margin-top: 0.75rem;
  }
  
  /* Help text */
  .help {
    color: var(--text-secondary);
    font-size: 0.875rem;
    line-height: 1.6;
    margin-top: 0.5rem;
  }
  
  /* Helper message */
  .helper-message {
    background: linear-gradient(135deg, rgba(224,0,27,0.05) 0%, rgba(224,0,27,0.02) 100%);
    border-left: 4px solid var(--primary);
    padding: 1.25rem 1.5rem;
    border-radius: var(--radius);
    margin-bottom: 1.5rem;
    display: flex;
    align-items: flex-start;
    gap: 1rem;
    box-shadow: 0 4px 12px rgba(224,0,27,0.08);
  }
  
  .helper-message-icon {
    font-size: 1.5rem;
    flex-shrink: 0;
    color: var(--primary);
  }
  
  .helper-message-text {
    font-size: 0.9375rem;
    line-height: 1.7;
    color: var(--text);
  }
  
  .helper-message-text strong {
    font-weight: 700;
    color: var(--text);
  }
  
  /* Preview actions row */
  .preview-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
  }
  
  /* Utility classes additions */
  .centered {
    margin-left: auto;
    margin-right: auto;
  }
  
  .align-center {
    text-align: center;
  }
  
  .help {
    font-size: 0.8125rem;
    color: var(--text-secondary);
    line-height: 1.5;
  }
  
  .kb {
    font-size: 0.8125rem;
    line-height: 1.45;
  }
  
  .tooltip {
    border-bottom: 1px dotted #8aa;
    cursor: help;
  }
  
  .row {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }
  
  fieldset {
    border: 2px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 1.75rem 2rem;
    margin-bottom: 2rem;
    background: white;
    box-shadow: var(--shadow);
    position: relative;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  fieldset:hover {
    border-color: var(--text-tertiary);
    box-shadow: var(--shadow-md);
  }
  
  legend {
    font-weight: 700;
    padding: 0 0.75rem;
    color: var(--text);
    font-size: 1.125rem;
    letter-spacing: -0.01em;
  }
  
  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: white;
    color: var(--text);
    border: 2px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    letter-spacing: -0.01em;
  }
  
  .btn:hover {
    border-color: var(--primary);
    color: var(--primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }
  
  .btn:active {
    transform: translateY(0);
  }
  
  /* FAQ Section */
  .faq-section {
    max-width: 1200px;
    margin: 6rem auto 4rem;
    padding: 0 2rem;
    animation: fadeInUp 0.8s ease-out 0.7s both;
  }
  
  .gradient-title {
    font-size: 3.5rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 3rem;
    letter-spacing: -0.03em;
    line-height: 1.1;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 25%, #d946ef 50%, #ec4899 75%, #f43f5e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    background-size: 200% auto;
    animation: gradientShift 8s ease infinite;
  }
  
  .faq-title {
    font-size: 3.5rem;
    font-weight: 800;
    text-align: center;
    margin-bottom: 3rem;
    letter-spacing: -0.03em;
    line-height: 1.1;
    background: linear-gradient(135deg, #7c3aed 0%, #a855f7 25%, #d946ef 50%, #ec4899 75%, #f43f5e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    background-size: 200% auto;
    animation: gradientShift 8s ease infinite;
  }
  
  .faq-items {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }
  
  .faq-item {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    overflow: hidden;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .faq-item:hover {
    box-shadow: 0 12px 40px rgba(0,0,0,0.12);
    transform: translateY(-4px);
  }
  
  .faq-question {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.75rem 2rem;
    cursor: pointer;
    background: white;
    transition: all 0.3s;
    -webkit-user-select: none;
    user-select: none;
    gap: 1.5rem;
  }
  
  .faq-question:hover {
    background: linear-gradient(135deg, rgba(224,0,27,0.02) 0%, transparent 100%);
  }
  
  .faq-question-text {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text);
    letter-spacing: -0.01em;
    line-height: 1.5;
    flex: 1;
  }
  
  .faq-icon {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    background: var(--bg-tertiary);
    color: var(--text-secondary);
    font-size: 1.25rem;
    transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }
  
  .faq-item.open .faq-icon {
    transform: rotate(180deg);
    background: var(--gradient-qub);
    color: white;
    box-shadow: 0 4px 12px rgba(224,0,27,0.25);
  }
  
  .faq-answer {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s cubic-bezier(0.4, 0, 0.2, 1), padding 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0 2rem;
  }
  
  .faq-item.open .faq-answer {
    max-height: 1000px;
    padding: 0 2rem 2rem;
  }
  
  .faq-answer-text {
    font-size: 1rem;
    line-height: 1.75;
    color: var(--text-secondary);
    padding-top: 0.5rem;
    border-top: 2px solid var(--bg-tertiary);
  }
  
  .faq-answer-text strong {
    color: var(--text);
    font-weight: 600;
  }
  
  .faq-answer-text ul {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }
  
  .faq-answer-text li {
    margin-bottom: 0.5rem;
  }
</style>
</head>
<body>

<header>
  <div class="header-content">
    <div class="brand">
      <img src="qub-logo.png" alt="Queen's University Belfast" />
      <h1>Prompt Builder</h1>
    </div>
    
    <div class="workflow-selector">
      <button class="workflow-btn active" data-tab="help" onclick="switchWorkflow('help')">Getting Started</button>
      <button class="workflow-btn" data-tab="quiz" onclick="switchWorkflow('quiz')">Canvas Quiz</button>
      <button class="workflow-btn" data-tab="study" onclick="switchWorkflow('study')">Study Guide</button>
      <button class="workflow-btn" data-tab="notes" onclick="switchWorkflow('notes')">From Notes</button>
    </div>
  </div>
</header>

<!-- Hero Banner -->
<div class="hero-banner help-hero" id="heroBanner">
  <div class="hero-content">
    <div class="hero-badge">
      <span>üß≠</span>
      <span id="heroBadgeText">Getting Started</span>
    </div>
    <h1 class="hero-title" id="heroTitle">Welcome to Prompt Builder</h1>
    <p class="hero-subtitle" id="heroSubtitle">Your guide to generating QUB-aligned quizzes, study guides, and note-based resources in minutes</p>
  </div>
</div>

<main>
  <!-- Help Info Boxes (Hidden by default) -->
  <div class="info" id="about">
    <div class="section-title">
      <strong>About this tool</strong>
      <button class="btn" id="dismissAbout" title="Hide this message">‚úï</button>
    </div>
    <p class="kb">Choose a pedagogy approach, customise your settings, then paste the prompt into the Copilot sidebar with your Panopto lecture open. Copilot reads your captions/slides and produces a Canvas-ready QTI zip and a lecturer PDF, using only your materials.</p>
  </div>
  
  <!-- Quiz Workflow -->
  <div class="workflow-content quiz-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Canvas Quiz Maker</h2>
    
    <div class="info" id="preflight">
      <div class="section-title">
        <strong>‚ö° Panopto Preflight (1 minute)</strong>
        <button class="btn" id="hidePreflight" title="Hide this checklist">‚úï</button>
        </div>
      <ol class="kb" style="margin-top: 0.75rem; padding-left: 1.5rem;">
        <li style="margin-bottom: 0.5rem;">Open the full Panopto <em>Watch</em> page (not the small Canvas embed).</li>
        <li style="margin-bottom: 0.5rem;">Open <em>Captions</em> and <em>Contents/Slides</em> panels.</li>
        <li style="margin-bottom: 0.5rem;">Scroll the transcript to the bottom once (loads all captions).</li>
        <li>Open Copilot and enable <em>Use page content</em>/<em>Allow this page</em>.</li>
      </ol>
    </div>
    
    <!-- Customise Options (Now at Top) -->
    <div class="advanced-options" style="margin-bottom: 2rem;">
      <div class="advanced-header" id="advancedToggle">
        <span class="advanced-title">Customise Options</span>
        <span class="advanced-toggle open">‚ñº</span>
      </div>
      <div class="advanced-content open" id="advancedContent">
        
        <div class="form-grid">
          
          <div class="form-group">
            <label class="form-label" for="quizLang">Language</label>
            <select id="quizLang" title="Output language and terminology style. Default: English (UK).">
              <option value="en-GB" selected>English (UK)</option>
              <option value="ga-IE">Irish</option>
              <option value="cy-GB">Welsh</option>
              <option value="fr-FR">French</option>
              <option value="es-ES">Spanish</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="quizCount">Questions per type</label>
            <input type="number" id="quizCount" min="1" max="12" value="3" title="How many items to generate for each selected question type.">
          </div>
          
          <div class="form-group">
            <label class="form-label" for="quizFeedback">Feedback level</label>
            <select id="quizFeedback" title="What students will see after answering.">
              <option value="off">Off ‚Äî no explanations</option>
              <option value="brief" selected>Brief ‚Äî 1-sentence rationale for the correct answer</option>
              <option value="detailed">Detailed ‚Äî explain the correct answer AND why each distractor is less accurate, with study tips</option>
            </select>
            <p class="help">This feedback appears to students when they review the Canvas quiz. It helps address misconceptions and supports revision.</p>
          </div>
        </div>
        
        <div class="form-group mt-1half">
          <label class="form-label">Pedagogy Preset</label>
          <select id="pedagogy" title="Sets tone and question style across disciplines.">
            <option>Concept Check (Retrieval)</option>
            <option>Worked Examples (Scaffolded)</option>
            <option>Case/Scenario-Based</option>
            <option>Debate / Critical Analysis</option>
            <option>Metacognitive Reflection</option>
            <option>Accessibility-First (UDL)</option>
          </select>
          <p class="help" id="pedBrief"></p>
        </div>
        
        <div class="form-group mt-1half">
          <label class="form-label">Question Types</label>
          <div class="chip-group" id="questionTypes"></div>
          <p class="help">Multiple Choice is a good default to check core understanding. You can add other Canvas-compatible types:
            <span class="tooltip" title="Multiple Answers: choose all that apply, scored with partial credit.">MA</span>,
            <span class="tooltip" title="True/False: two options; the prompt enforces valid structure in QTI.">TF</span>,
            <span class="tooltip" title="Short Answer: exact strings (or variants) are accepted.">SA</span>,
            <span class="tooltip" title="Essay: unscored text response; used as a fallback if a question can't be validated.">Essay</span>,
            <span class="tooltip" title="Numerical: exact value or tolerance range.">Numerical</span>,
            <span class="tooltip" title="Matching: valid pairs; if not possible, we auto-rewrite to MC/Essay.">Matching</span>.
          </p>
        </div>
        
    </div>
  </div>
  
    <!-- Primary Action -->
    <div class="primary-action">
      <button class="btn-primary" id="generateQuiz" onclick="copyPrompt();">
        üìã Copy Prompt to Clipboard
      </button>
    </div>
    
    <!-- Canvas How-To (Quiz Only) -->
    <div class="info" id="canvasHow">
      <div class="section-title">
        <strong>Using this in Canvas (New or Classic Quizzes)</strong>
        <button class="btn" id="hideCanvasHow" title="Hide instructions">‚úï</button>
        </div>
      <ol class="kb" style="margin-top: 1rem; padding-left: 1.5rem;">
        <li style="margin-bottom: 0.5rem;">Complete the Panopto preflight steps above (open Watch page, captions/slides panels, scroll transcript).</li>
        <li style="margin-bottom: 0.5rem;">Copy the prompt (button above) and paste it into Copilot sidebar. It will produce:
          <ul style="margin-top: 0.25rem; padding-left: 1.5rem;"><li>A QTI <code>.zip</code> for Canvas</li><li>A lecturer PDF</li></ul>
        </li>
        <li style="margin-bottom: 0.5rem;"><strong>Import to Canvas:</strong> In your course, go to <strong>Settings ‚Üí Import Course Content ‚Üí Content Type: QTI .zip file</strong>. Choose the downloaded ZIP and click <strong>Import</strong>.</li>
        <li style="margin-bottom: 0.5rem;">After import, check <strong>Quizzes</strong> (or <strong>Assignments</strong> for New Quizzes). If you only see an item bank, the importer auto-rewrote items‚Äîopen the bank and build a quiz from it.</li>
        <li>Review points, feedback, and availability dates; then publish.</li>
      </ol>
      <p class="help" style="margin-top: 0.75rem;"><strong>Note:</strong> If Copilot returns "INSUFFICIENT_PAGE_CONTENT", go back and ensure captions/contents panels are fully expanded and loaded.</p>
      </div>
    </div>
  </div>
    
  <!-- Study Guide Workflow -->
  <div class="workflow-content study-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Study Guide Builder</h2>

    <!-- Study Guide Quick Intro (no customiser) -->
    <div class="helper-message" style="margin-top: -0.5rem; margin-bottom: 1.5rem;">
      <div class="helper-message-icon">üß≠</div>
      <div class="helper-message-text">
        <strong>Pick a Study Guide Tool below</strong> ‚Äî each card contains a complete, QUB‚Äëaligned prompt. Click <em>Copy Prompt</em>, paste into Copilot with your Panopto <em>Watch</em> page open, and it will auto‚Äëscroll captions &amp; slides, extract evidence, and generate a Word file. Use <em>Preview</em> to check the prompt first.
      </div>
    </div>

    <!-- Five Study Tools (Glasmorphic Cards) -->
    <div class="quick-start" id="studyToolsDeck" style="margin-top:1.5rem;">
      <div class="section-title">
        <span>Study Guide Tools</span>
        <span class="help">Pick a tool and copy its pre-built prompt to Copilot</span>
      </div>
      <div class="preset-cards study-tools-grid" id="studyToolsGrid">
        <!-- Cards populated by JS -->
      </div>
    </div>
    <div class="study-preview-panel hidden" id="studyPreviewPanel">
      <div class="study-preview-header">
        <span class="study-preview-title" id="studyPreviewTitle">Preview</span>
        <span class="study-preview-meta" id="studyPreviewMeta"></span>
      </div>
      <div class="study-preview-body">
        <div class="study-preview-placeholder" id="studyPreviewPlaceholder">Select ‚ÄúPreview‚Äù on a tool to view the full prompt here.</div>
        <pre class="study-preview-text hidden" id="studyPreviewText"></pre>
      </div>
    </div>
  </div>
  
  <!-- From Notes Workflow -->
  <div class="workflow-content notes-workflow hidden">
    <h2 class="gradient-title" style="margin-top: 2rem; margin-bottom: 3rem;">Build From Your Notes</h2>
    
    <!-- Notes Input -->
    <div class="quick-start">
      <div class="section-title">Paste your notes</div>
      <textarea id="notesInput" placeholder="Paste your lecture notes here (plain text, headings, bullets)..." class="w-100 min-h-200"></textarea>
      <p class="help">Aim for 400‚Äì2000 words. Keep headings and key ideas ‚Äî we‚Äôll combine your notes with the selected tool and ensure the prompt stays under 8000 characters.</p>
    </div>

    <div class="helper-message" style="margin-bottom: 1.5rem;">
      <div class="helper-message-icon">üóÇÔ∏è</div>
      <div class="helper-message-text">
        <strong>Select a Notes Tool</strong> ‚Äî each card wraps your pasted notes in a ready-to-copy prompt. Preview first to confirm the output and character count.
      </div>
    </div>

    <div class="quick-start" id="notesToolsDeck" style="margin-top:1rem;">
      <div class="section-title">
        <span>Notes Tools</span>
        <span class="help">Choose an output style, then copy or preview the prompt.</span>
      </div>
      <div class="preset-cards study-tools-grid" id="notesToolsGrid">
        <!-- Cards populated by JS -->
      </div>
    </div>

    <div class="study-preview-panel hidden" id="notesPreviewPanel">
      <div class="study-preview-header">
        <span class="study-preview-title" id="notesPreviewTitle">Preview</span>
        <span class="study-preview-meta" id="notesPreviewMeta"></span>
      </div>
      <div class="study-preview-body">
        <div class="study-preview-placeholder" id="notesPreviewPlaceholder">Paste notes and choose ‚ÄúPreview‚Äù to check the final prompt.</div>
        <pre class="study-preview-text hidden" id="notesPreviewText"></pre>
      </div>
    </div>
  </div>
  
  <!-- Preview Section (Shared) -->
  <div class="preview-section centered" id="previewSection" style="display:none;">
    <div class="preview-header">
      <div class="section-title">Your Copilot Prompt</div>
      <div class="preview-stats">
        <div class="stat">
          <span>üìä</span>
          <span><span class="stat-value" id="charCount">0</span> chars (aim &lt; 8000)</span>
        </div>
        <span class="status-badge" id="statusBadge">
          <span>‚úì</span>
          <span id="statusText">Ready</span>
        </span>
      </div>
    </div>
    
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar"></div>
    </div>
    
    <div class="preview-actions" style="margin: 1rem 0; justify-content: space-between;">
      <span class="help">Paste into Copilot with your Panopto Watch page open. Ensure preflight steps are done.</span>
      <button class="btn-primary" id="copyTop" title="Copy the prompt" onclick="copyPrompt();">üìã Copy Prompt</button>
    </div>
    
    <div class="preview-box">
      <div class="preview-placeholder" id="previewPlaceholder">
        <div class="preview-placeholder-icon">üëÜ</div>
        <p>Customise your options above and your prompt will appear here</p>
      </div>
      <pre class="preview-text hidden" id="previewText"></pre>
    </div>
  </div>
  
  <!-- Help/Getting Started Workflow -->
  <div class="workflow-content help-workflow">
    <h2 class="gradient-title" style="margin-top: 0;">Getting Started with Prompt Builder</h2>
    
    <div class="quick-start" style="margin-bottom: 4rem; padding: 3rem;">
      <h3 style="font-size: 1.75rem; margin-bottom: 1.5rem; color: var(--text);">Quick Start Guide</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(147,51,234,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #3b82f6; box-shadow: 0 4px 20px rgba(59,130,246,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">üé•</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #3b82f6 0%, #9333ea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Open Your Panopto Video</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Navigate to your Panopto Watch page (not the Canvas embed). Ensure captions and slides panels are open and scroll through the transcript once.</p>
        </div>
        
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(168,85,247,0.1) 0%, rgba(236,72,153,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #a855f7; box-shadow: 0 4px 20px rgba(168,85,247,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚öôÔ∏è</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #a855f7 0%, #ec4899 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Customise Your Settings</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Choose your pedagogy preset, question types, feedback level, and other options. The prompt updates automatically as you make changes.</p>
        </div>
        
        <div style="padding: 2.5rem; background: linear-gradient(135deg, rgba(236,72,153,0.1) 0%, rgba(244,63,94,0.05) 100%); border-radius: var(--radius-lg); border-left: 5px solid #ec4899; box-shadow: 0 4px 20px rgba(236,72,153,0.1); transition: all 0.3s ease;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">‚ú®</div>
          <h4 style="font-size: 1.4rem; font-weight: 700; margin-bottom: 0.75rem; background: linear-gradient(135deg, #ec4899 0%, #f43f5e 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Copy & Paste to Copilot</h4>
          <p style="color: var(--text-secondary); line-height: 1.6;">Click "Copy Prompt" and paste it into Microsoft Copilot's sidebar. Copilot will read your Panopto page and generate your quiz or study guide!</p>
        </div>
      </div>
    </div>
    
    <h2 class="faq-title">Frequently Asked Questions</h2>
    
    <div class="faq-items">
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">How do I use the Prompt Builder with Panopto?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p><strong>Step-by-step (about 2 minutes):</strong></p>
            <ol>
              <li>Open your Panopto <em>Watch</em> page in a browser tab (avoid the small Canvas embed).</li>
              <li>Open the <strong>Captions/Transcript</strong> panel and the <strong>Contents/Slides</strong> panel. Scroll through the transcript once so all captions load.</li>
              <li>Open <strong>Microsoft Copilot</strong> in the sidebar and allow it to ‚ÄúUse page content‚Äù.</li>
              <li>In Prompt Builder, choose your <strong>Pedagogy preset</strong>, keep <strong>Multiple Choice</strong> as default (or add more types), and set the <strong>Feedback level</strong>.</li>
              <li>Click <strong>Copy Prompt</strong> and paste it into Copilot. It will read <em>only</em> your Panopto page (captions + slides) and generate the requested files.</li>
            </ol>
            <p class="help">Tip: If Copilot returns <code>INSUFFICIENT_PAGE_CONTENT</code>, reload the Panopto page, open both panels, scroll to the bottom of the transcript, and try again.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">What outputs does the Prompt Builder create?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <ul>
              <li><strong>Canvas Quiz package (QTI .zip):</strong> Standards‚Äëcompliant file that imports into Canvas (New or Classic Quizzes). Includes question stems, options, scoring, and optional per‚Äëchoice feedback.</li>
              <li><strong>Lecturer PDF (quiz version):</strong> One page per question with the answer key and concise teaching notes to help during delivery.</li>
              <li><strong>Study Guide / Notes Pack:</strong> A pedagogy‚Äëfirst resource (PDF, Word, or PPTX) containing an executive summary, learning outcomes, key concepts, worked examples or cases, a problem set with solutions, 20‚Äì40 flashcards, reflection prompts and (optionally) a two‚Äëweek study planner.</li>
            </ul>
            <p class="help">All outputs are created from your lecture materials only‚Äîno external sources are introduced.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">What are pedagogy presets and how do I choose one?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p>Presets shape the <strong>tone, structure and feedback style</strong> of what is generated, aligned with Queen‚Äôs <em>Beyond Blended</em> approach:</p>
            <ul>
              <li><strong>Concept Check (Retrieval):</strong> Short, focused questions that probe essential ideas and common misconceptions.</li>
              <li><strong>Worked Examples (Scaffolded):</strong> Step‚Äëby‚Äëstep reasoning with ‚Äúwhy this step‚Äù notes and common slips.</li>
              <li><strong>Case/Scenario‚ÄëBased:</strong> Realistic vignettes that ask students to apply ideas; one answer is most defensible from the lecture.</li>
              <li><strong>Debate / Critical Analysis:</strong> Contrast positions and justify the preferred option using evidence from slides/captions.</li>
              <li><strong>Metacognitive Reflection:</strong> Prompts that surface process, limits and next steps (great for short‚Äëanswer / essay).</li>
              <li><strong>Accessibility‚ÄëFirst (UDL):</strong> Plain UK English, clear structure, and inclusive phrasing; avoids jargon and culture‚Äëbound idioms.</li>
            </ul>
            <p class="help">Choose the preset that matches your intended learning outcome. You can still edit the prompt details before copying.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">How do I import the quiz into Canvas?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <ol>
              <li>In your Canvas course go to <strong>Settings ‚Üí Import Course Content</strong>.</li>
              <li>Set <strong>Content Type</strong> to <strong>QTI .zip file</strong>, choose the downloaded file (e.g., <code>Lecture_5_‚Ä¶_quiz_qti.zip</code>) and click <strong>Import</strong>.</li>
              <li>After processing, check <strong>Quizzes</strong>. For New Quizzes, the item also appears in <strong>Assignments</strong>.</li>
              <li>If you only see an <strong>Item Bank</strong>, open it and build a quiz from those questions‚ÄîCanvas sometimes does this automatically.</li>
              <li>Open the quiz to review points, availability, and <strong>Student Feedback</strong> settings; then <strong>Publish</strong>.</li>
            </ol>
            <p class="help">Troubleshooting: If Canvas shows ‚ÄúNo question type used‚Ä¶‚Äù, the QTI was malformed. Regenerate using this tool‚Äôs latest prompt and ensure only Canvas‚Äësupported types are selected.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">Can I customize the generated content?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p><strong>Yes.</strong> The app lets you tailor:</p>
            <ul>
              <li><strong>Question types & counts:</strong> Start with Multiple Choice, then add others as needed.</li>
              <li><strong>Feedback level:</strong> Off, Brief, or Detailed‚Äîcontrols what students see after answering.</li>
              <li><strong>Pedagogy preset:</strong> Sets style, depth and feedback tone.</li>
              <li><strong>Study Guide components:</strong> Toggle concept map, glossary, worked examples, cases, problem set, flashcards, reflections and planner.</li>
              <li><strong>Output format:</strong> PDF/Word/PPTX for study guides; QTI + PDF for quizzes.</li>
            </ul>
            <p class="help">Everything generated is editable: you can revise wording in the PDF/Word/PPTX and change quiz settings in Canvas.</p>
          </div>
        </div>
      </div>
      <div class="faq-item">
        <div class="faq-question">
          <span class="faq-question-text">Is my content secure and private?</span>
          <div class="faq-icon">‚Ä∫</div>
        </div>
        <div class="faq-answer">
          <div class="faq-answer-text">
            <p>This tool runs entirely in your browser and only creates a <em>prompt</em>. Your materials are not uploaded to our servers. When you paste the prompt into Microsoft Copilot, your data is handled under Microsoft‚Äôs terms and your institutional account settings.</p>
            <ul>
              <li>The prompt instructs Copilot to use <strong>only</strong> your Panopto captions/slides or notes and to avoid external sources.</li>
              <li>No student data is processed.</li>
              <li>Generated files are saved locally by you.</li>
            </ul>
            <p class="help"><strong>Disclaimer:</strong> We aim for accuracy and accessibility, but AI outputs can contain errors or omissions. Always review before sharing with students. If you spot an issue, regenerate or edit the output.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <footer style="max-width:1400px;margin:3rem auto 2rem;padding:1.5rem 2rem;border-top:2px solid var(--border);text-align:center;color:var(--text-secondary);">
    <p style="margin-bottom:0.5rem;"><strong>Teaching & Training Unit ‚Äì D&IS, Queen‚Äôs University Belfast</strong></p>
    <p style="margin-bottom:0.5rem;">Patrick Phillips ‚Ä¢ Support & enquiries: <a href="mailto:p.phillips@qub.ac.uk" style="color:inherit; text-decoration:underline;">p.phillips@qub.ac.uk</a></p>
    <p style="font-size:0.875rem;">We strive to create high‚Äëquality resources aligned with Queen‚Äôs pedagogy. However, AI‚Äëgenerated content may contain inaccuracies. Always review outputs for accuracy, inclusivity and accessibility before use.</p>
  </footer>
</main>

<!-- Help Button -->
<button class="help-toggle" id="helpToggle">
  <span class="help-toggle-icon">?</span>
  <span>Need Help?</span>
</button>

<!-- Toast Notification -->
<div class="toast" id="toast">
  <span>‚úì</span>
  <span>Prompt copied to clipboard!</span>
</div>

<script>
function exposePanoptoTranscriptForCopilot() {
  try {
    // Gather candidate text fragments
    const nodes = document.querySelectorAll('.transcript * , .caption, .caption-text, [class*="transcript"] span, [class*="caption"] span');
    const texts = Array.from(nodes).map(n => (n.innerText || '').trim()).filter(Boolean);
    const full = texts.join(' ').replace(/\s+/g, ' ').trim();
    // Only expose if sufficiently long and not already present
    if (full.length > 300 && !document.getElementById('copilot-visible-transcript')) {
      const helper = document.createElement('div');
      helper.id = 'copilot-visible-transcript';
      helper.textContent = full;
      helper.style.cssText = 'position:fixed;left:-99999px;top:-99999px;white-space:pre-wrap;visibility:visible;height:auto;width:1px;';
      document.body.appendChild(helper);
    }
  } catch(e) {
    console.warn('Transcript expose failed:', e);
  }
}
</script>
<script>
// Make Panopto transcript text visible to Copilot's DOM reader (no UI impact)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', exposePanoptoTranscriptForCopilot);
} else {
  exposePanoptoTranscriptForCopilot();
}
// Pedagogy presets (QUB-aligned)
const PEDAGOGY = {
  "Concept Check (Retrieval)": {
    brief: "Quick checks of core ideas. Tight stems, one clearly best answer, and distractors based on likely misunderstandings.",
    inject: [
      "Use retrieval-practice style questions that check essential concepts from the lecture.",
      "Distractors must reflect plausible misunderstandings taken from the lecture wording only.",
      "Brief feedback explains the correct idea and points to a timestamp if detectable."
    ]
  },
  "Worked Examples (Scaffolded)": {
    brief: "Step-by-step problem solving with hints that fade. Great for methods and processes.",
    inject: [
      "Prefer worked-example prompts with ordered steps.",
      "Add a short 'why this step' note; in detailed feedback include 'common slip' guidance."
    ]
  },
  "Case/Scenario-Based": {
    brief: "Apply the lecture ideas to realistic situations; one answer is most defensible from the material.",
    inject: [
      "Frame items as short scenarios derived strictly from lecture captions/slides.",
      "Provide one best answer; others can be reasonable but less supported."
    ]
  },
  "Debate / Critical Analysis": {
    brief: "Compare viewpoints; justify the preferred answer with evidence from the lecture.",
    inject: [
      "Pose contrastive options; mark the one most defensible by the lecture evidence.",
      "Feedback references the relevant slide/timestamp where possible."
    ]
  },
  "Metacognitive Reflection": {
    brief: "Students reflect on process, limits, and next steps. Good as SA/Essay.",
    inject: [
      "Include prompts that ask students to explain approach and next steps tied to outcomes.",
      "Prefer short-answer or essay for depth where MC is weak."
    ]
  },
  "Accessibility-First (UDL)": {
    brief: "Plain UK English, inclusive phrasing, and multiple means of representation.",
    inject: [
      "Ensure each item stands alone without images; suggest alt text when PDF is generated.",
      "Avoid idioms and culturally specific references."
    ]
  }
};

// State
let state = {
  workflow: 'help',
  pedagogy: 'Concept Check (Retrieval)',
  quizTitle: '',
  quizLang: 'en-GB',
  quizCount: 3,
  quizFeedback: 'brief',
  questionTypes: ['multiple_choice_question'],
  notesInput: ''
};

const QUESTION_TYPES = [
  { id: 'multiple_choice_question', label: 'Multiple Choice' },
  { id: 'multiple_answers_question', label: 'Multiple Answers' },
  { id: 'true_false_question', label: 'True/False' },
  { id: 'short_answer_question', label: 'Short Answer' },
  { id: 'essay_question', label: 'Essay' },
  { id: 'numerical_question', label: 'Numerical' },
  { id: 'matching_question', label: 'Matching' }
];

/* ---------- Initialisation: mount chips once DOM is ready ---------- */
document.addEventListener('DOMContentLoaded', () => {
  try {
    mountStudyToolCards();
    mountNotesToolCards();
  } catch (e) {
    console.warn('Tool deck init failed:', e);
  }
});

// DOM helpers
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);

// Detect Panopto title (enhanced)
function detectPanoptoTitle() {
  const og = document.querySelector('meta[property="og:title"]')?.content?.trim();
  const data = document.querySelector('[data-role="session-title"], .session-title, .video-title')?.textContent?.trim();
  const doc = document.title?.trim();
  return og || data || doc || '';
}

const panoptoTitle = detectPanoptoTitle();

function slugify(s) {
  const a = (s || '').normalize('NFKD').replace(/[^\x00-\x7F]/g, '');
  return (a.replace(/[^A-Za-z0-9]+/g, '_').replace(/_+/g, '_').replace(/^_+|_+$/g, '') || 'Lecture_Quiz');
}

// Panopto source block (compact)
const PANOPTO_BLOCK = `SOURCE PREPARATION
1) Confirm this is a Panopto Watch page (not the Canvas embed).
2) Open Captions/Transcript and Contents/Slides panels; expand any collapsed sections.
3) Scroll the transcript to the very bottom once so every caption loads.
4) Wait until no new lines appear, then read the DOM for captions + slides only (no external sources).

TITLE EXTRACTION (MANDATORY): Extract real video title from <meta property="og:title">, [data-role="session-title"], .session-title, or document.title. Use the real title (e.g., "Week 5: Cell Division") ‚Äî never "Lecture Quiz" or placeholders.

FAIL-CLOSED: If the combined captions/slides corpus < 300 words after dedupe, return exactly:
  "INSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll transcript fully, then retry."
`;

// Prompt builders
function buildQuizPrompt() {
  const title = panoptoTitle || 'Lecture Quiz';
  const slug = slugify(title);
  const types = state.questionTypes.join(', ');
  const target = state.questionTypes.length * state.quizCount;
  const ped = PEDAGOGY[state.pedagogy] || PEDAGOGY["Concept Check (Retrieval)"];
  const pedBlock = ped.inject.map(l => `‚Ä¢ ${l}`).join('\n');
  
  let tfNum = '';
  if (state.questionTypes.includes('true_false_question')) tfNum += '\nTF: <response_lid> with 2 labels: True/False.';
  if (state.questionTypes.includes('numerical_question')) tfNum += '\nNUM: <response_num> + tolerance.';
  
  return `SYSTEM: Return EXACTLY 2 files: (1) ${slug}_quiz_qti.zip, (2) ${slug}_quiz.pdf
Use ONLY THIS Panopto page. Language=${state.quizLang}. Do NOT ask questions.
${PANOPTO_BLOCK}
PEDAGOGY: ${pedBlock}

HE STANDARDS: Clear stems testing outcomes (not trivia); plausible distractors from lecture; meaningful feedback explaining WHY with timestamps; mix Bloom levels; university-level precision.

Q TYPES: ${types} | ${state.quizCount} per type | TARGET=${target} exactly | Rewrite invalid as essay${tfNum}

QTI ZIP ‚Äî ${slug}_quiz_qti.zip:
imsmanifest.xml:
<?xml version="1.0" encoding="UTF-8"?>
<manifest identifier="man1" xmlns="http://www.imsglobal.org/xsd/imscp_v1p1">
  <resources><resource identifier="res1" type="imsqti_xmlv1p2" href="assessment.xml"><file href="assessment.xml"/></resource></resources>
</manifest>

assessment.xml:
<?xml version="1.0" encoding="UTF-8"?>
<questestinterop xmlns="http://www.imsglobal.org/xsd/ims_qtiasiv1p2">
  <assessment ident="asmt1" title="[ACTUAL_VIDEO_TITLE]"><section ident="root_section"><!-- ${target} items --></section></assessment>
</questestinterop>

MC ITEM:
<item ident="q1" title="Q1">
<itemmetadata><qtimetadata>
<qtimetadatafield><fieldlabel>question_type</fieldlabel><fieldentry>multiple_choice_question</fieldentry></qtimetadatafield>
<qtimetadatafield><fieldlabel>points_possible</fieldlabel><fieldentry>1</fieldentry></qtimetadatafield>
</qtimetadata></itemmetadata>
<presentation><material><mattext texttype="text/html">STEM</mattext></material>
<response_lid ident="response1" rcardinality="Single"><render_choice shuffle="Yes">
<response_label ident="A"><material><mattext texttype="text/html">OPT_A</mattext></material></response_label>
<response_label ident="B"><material><mattext texttype="text/html">OPT_B</mattext></material></response_label>
<response_label ident="C"><material><mattext texttype="text/html">OPT_C</mattext></material></response_label>
<response_label ident="D"><material><mattext texttype="text/html">OPT_D</mattext></material></response_label>
</render_choice></response_lid></presentation>
<resprocessing><outcomes><decvar varname="SCORE" vartype="Decimal" minvalue="0" maxvalue="100"/></outcomes>
<respcondition continue="No"><conditionvar><varequal respident="response1">CORRECT</varequal></conditionvar>
<setvar varname="SCORE" action="Set">100</setvar>${state.quizFeedback !== 'off' ? '<displayfeedback feedbacktype="Response" linkrefid="fb"/>' : ''}</respcondition></resprocessing>${state.quizFeedback !== 'off' ? '<itemfeedback ident="fb"><material><mattext texttype="text/html">WHY correct [mm:ss]</mattext></material></itemfeedback>' : ''}
</item>

GUARDS: UTF-8; escape XML chars; mattext‚â§1200; exactly ${target} items; all have metadata

PDF: A4. Title=[ACTUAL_VIDEO_TITLE], TOC, then 1Q/page: number, stem, options, answer${state.quizFeedback !== 'off' ? ', feedback+timestamp' : ''}

VALIDATE: (1) ‚â•300w or "INSUFFICIENT_PAGE_CONTENT", (2) Real title extracted, (3) ${target} items, (4) Valid XML, (5) All metadata, (6) HE quality (clear/defensible/plausible/meaningful), (7) Mixed Bloom, (8) Expert-approvable

OUTPUT: [ACTUAL_TITLE_SLUG]_quiz_qti.zip + [ACTUAL_TITLE_SLUG]_quiz.pdf using REAL title from og:title/[data-role="session-title"]/h1/document.title‚ÄîNOT "Lecture_Quiz" placeholder.`;
}

// -------- Study Tool Prompts (v13 with scroll/expand + Bloom intent) --------

function promptCoreConceptsV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_core_concepts.docx (Word A4).
Use only the Panopto Watch page. No external sources.

SOURCE PREPARATION
1. Confirm this is a Panopto ‚ÄúWatch‚Äù page.
2. Virtually scroll through and fully expand:
   ‚Äì ‚ÄúCaptions‚Äù / ‚ÄúTranscript‚Äù tab ‚Üí bottom
   ‚Äì ‚ÄúContents‚Äù / ‚ÄúSlides‚Äù tabs ‚Üí expand all
3. Wait until no new lines appear.
4. Extract and dedupe all caption + slide text (preserve [mm:ss]).
If corpus < 500 words ‚Üí
‚ÄúINSUFFICIENT_PAGE_CONTENT ‚Äî Expand captions & slides, scroll fully, then retry.‚Äù

TITLE & FILENAME
Extract REAL title from <meta property="og:title"> or [data-role="session-title"] or .session-title or document.title.
Use that title for H1 and filename [REAL_TITLE_SLUG]_study_core_concepts.docx.

TASK
Run all phases (collect ‚Üí analyse ‚Üí write ‚Üí validate ‚Üí output) automatically.
Do NOT pause or ask questions.

PURPOSE
Produce a timestamp-based conceptual study guide that explains key ideas and how they connect, using clear language and evidence.

STRUCTURE
1. Title page ‚Äî REAL title, module, date + 120-word ‚ÄúHow to use this guide‚Äù.
2. Learning outcomes ‚Äî 5 outcomes (10‚Äì18 words, ‚â• 3 Bloom levels) + 120-word alignment note.
3. Threshold concepts ‚Äî 3‚Äì5 ideas (80‚Äì110 words + [mm:ss]).
4. Key concepts ‚Äî ‚â• 12 concepts (55‚Äì75 words + [mm:ss]).
5. Concept map ‚Äî ‚âà 200 words (10‚Äì14 nodes/edges, ‚â• 6 timestamp links).
6. Appendix A ‚Äî ‚â• 24 quoted fragments (5‚Äì20 words + [mm:ss]).

BLOOM GUIDANCE (Student-friendly)
‚Ä¢ Remember = recall a definition or law
‚Ä¢ Understand = explain the idea in your own words
‚Ä¢ Apply = use the principle to solve a new problem
‚Ä¢ Analyse = break down parts and relationships
‚Ä¢ Evaluate = judge the best approach or solution
‚Ä¢ Create = design or combine ideas into something new

PEDAGOGY
Link concepts to outcomes; embed Beyond Blended pillars; apply ‚â•7 UDL checkpoints; UK English; QUB red #E0001B; WCAG-AA.

VALIDATION
Corpus ‚â• 500 words; ‚â• 3 thresholds; ‚â• 12 key concepts; ‚â• 24 timestamps; no placeholders; one .docx output.`;
}

function promptKnowledgeToolsV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_knowledge_tools.docx (Word A4).

SOURCE PREPARATION ‚Äî same scroll/expand steps as Prompt 1; fail if < 500 words.

PURPOSE
Turn lecture content into usable terminology and reasoning patterns that model expert thinking.

STRUCTURE
1. Glossary ‚Äî ‚â• 28 terms (25‚Äì35 words + authentic example + [mm:ss]).
2. Worked examples ‚Äî 3 (180‚Äì220 words): Context; Steps; Why; Common slip; ‚ÄúCheck you can‚Ä¶‚Äù + [mm:ss] and a short intent note (e.g., apply/analyse).
3. Mini cases ‚Äî 2 (180‚Äì220 words) with decision-making analysis + [mm:ss].
4. Appendix A ‚Äî ‚â• 24 timestamped quotes.

PEDAGOGY
Link each term/example to outcomes; Bloom Apply/Analyse via intent phrasing; ‚â•7 UDL checkpoints; Beyond Blended alignment; UK English.

VALIDATION
Glossary ‚â• 28; Examples = 3; Cases = 2; ‚â• 24 timestamps; no duplicates; one .docx output.`;
}

function promptPracticeTestingV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_practice_testing.docx (Word A4).

SOURCE PREPARATION ‚Äî scroll and expand captions & slides; fail if < 500 words.

TASK
Auto-run (collect ‚Üí topic-seed ‚Üí draft ‚Üí validate ‚Üí output). Do not ask for confirmation.

PURPOSE
Build a practice and testing section that develops retrieval and reasoning with clear feedback and Bloom-intent explanations.

STRUCTURE
1. Intro ‚Äî 100-word ‚ÄúHow to use this section‚Äù explaining that each task targets a different thinking skill.
2. Problem set ‚Äî 16 unique items (6 Recall, 6 Apply/Analyse, 4 Evaluate/Create).
   Each: Prompt ‚â§25 words; Hint 20‚Äì35; Solution 60‚Äì110 + [mm:ss];
   Why Correct 40‚Äì60; Common Misconception ‚â§25; short cognitive intent phrase.
3. Self-check quiz ‚Äî 14 MC/SA items on different topics; each with answer, 20‚Äì35 word rationale, misconception, [mm:ss], and cognitive intent note.
4. Mini-rubric excerpt (3 criteria √ó 3 levels).
5. Appendix A ‚Äî ‚â• 24 timestamped quotes.

PEDAGOGY
Use ‚â•5 distinct lecture topics; Balance Bloom levels; Beyond Blended (Pace, Flex, Support); ‚â•7 UDL checkpoints; UK English.

VALIDATION
16 unique problems (‚â•5 topics); 14 quiz items; ‚â•24 timestamps; no duplicates; one .docx output.`;
}

function promptReflectionPlanningV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_reflection_planning.docx (Word A4).

SOURCE PREPARATION ‚Äî scroll & expand captions/slides fully; fail if < 500 words.

PURPOSE
Develop self-reflection and study planning skills based on timestamped lecture evidence and awareness of thinking levels.

STRUCTURE
1. Reflection prompts ‚Äî 6‚Äì8 questions (each with a brief intent phrase like ‚ÄúThis helps you evaluate ‚Ä¶‚Äù + [mm:ss]).
2. Rewatch guide ‚Äî 8 clip intervals [mm:ss‚Äìmm:ss] with ‚Äúwatch for‚Ä¶‚Äù and an active task + intent note.
3. Two-week planner ‚Äî 14 rows with task, time estimate, and thinking skill column.
4. Appendix A ‚Äî ‚â• 24 timestamped quotes.

PEDAGOGY
Link to outcomes; Beyond Blended (Pace & Flex); ‚â•7 UDL checkpoints; inclusive UK English.

VALIDATION
‚â•6 reflections; 8 rewatch segments; 14-day planner; ‚â•24 timestamps; one .docx output.`;
}

function promptExtensionSupportV13(){
  return `SYSTEM
Return ONE file only: [REAL_TITLE_SLUG]_study_extension_support.docx (Word A4).

SOURCE PREPARATION ‚Äî scroll and expand captions/slides to bottom; fail if < 500 words.

PURPOSE
Provide long-term retrieval, collaboration, and inclusive learning support based on lecture evidence.

STRUCTURE
1. Flashcards ‚Äî 45 items across ‚â•6 topics; each = ID; Question; Answer; 1-sentence connection; Difficulty (Fdn/Int/Adv + brief intent phrase); Related IDs; [mm:ss].
   Include Appendix B ‚Äî CSV table (all fields).
2. Group tasks ‚Äî 3 activities (think-pair-share, jigsaw, mini-debate) 140‚Äì180 words + [mm:ss] and intent descriptions.
3. Authentic practice task ‚Äî 1 task (170‚Äì220 words + 3√ó3 rubric & feedback plan).
4. UDL & Accessibility audit ‚Äî ‚â•9 checkpoints with practical alternatives.
5. Where to get help ‚Äî inclusive signposting (QUB links ok).
6. Appendix A ‚Äî ‚â•24 timestamped quotes.

PEDAGOGY
Spaced retrieval + social learning; map items to outcomes; Beyond Blended (Flex, Support); ‚â•9 UDL checkpoints; UK English.

VALIDATION
45 flashcards (all fields complete); 3 group tasks; UDL ‚â•9; ‚â•24 timestamps; no placeholders; one .docx output.`;
}

// Registry for tool cards
const STUDY_TOOLS = [
  {
    id:'core',
    icon:'üìö',
    name:'Core Concepts',
    points:[
      'Surface the key thresholds and big ideas',
      'Summarise 12+ core concepts with timestamps',
      'Map relationships in a concept map',
      'Evidence every section with ‚â•24 snippets'
    ],
    builder: promptCoreConceptsV13
  },
  {
    id:'knowledge',
    icon:'üõ†Ô∏è',
    name:'Knowledge Tools',
    points:[
      'Build a 28-term glossary with authentic examples',
      'Model 3 worked examples plus 2 mini cases',
      'Explain slips, fixes, and Bloom intent',
      'Bundle an evidence appendix for QA'
    ],
    builder: promptKnowledgeToolsV13
  },
  {
    id:'practice',
    icon:'üß†',
    name:'Practice & Testing',
    points:[
      'Create 16 interleaved problems with feedback',
      'Add a 14-item self-check quiz with rationales',
      'Flag misconceptions and Bloom focus per item',
      'Include a mini rubric for rapid marking'
    ],
    builder: promptPracticeTestingV13
  },
  {
    id:'reflect',
    icon:'üîÅ',
    name:'Reflection & Planning',
    points:[
      'Prompt 6‚Äì8 metacognitive check-ins',
      'Serve 8 timestamped rewatch tasks',
      'Lay out a 14-day plan with time estimates',
      'Tie actions to outcomes and thinking levels'
    ],
    builder: promptReflectionPlanningV13
  },
  {
    id:'support',
    icon:'üåê',
    name:'Extension & Support',
    points:[
      'Generate 45 flashcards with difficulty + links',
      'Offer 3 collaborative group tasks with cues',
      'Design an authentic task with a 3√ó3 rubric',
      'Audit ‚â•9 UDL checkpoints and help routes'
    ],
    builder: promptExtensionSupportV13
  },
];

const TOOL_STYLE_PALETTE = [
  { accent: '#F97316', badge: 'rgba(249,115,22,0.12)', chip: 'rgba(249,115,22,0.08)', chipBorder: 'rgba(249,115,22,0.25)', accentHover: '#ea580c' },
  { accent: '#8B5CF6', badge: 'rgba(139,92,246,0.12)', chip: 'rgba(139,92,246,0.08)', chipBorder: 'rgba(139,92,246,0.25)', accentHover: '#7c3aed' },
  { accent: '#0EA5E9', badge: 'rgba(14,165,233,0.12)', chip: 'rgba(14,165,233,0.08)', chipBorder: 'rgba(14,165,233,0.25)', accentHover: '#0284c7' },
  { accent: '#F973AB', badge: 'rgba(249,115,171,0.12)', chip: 'rgba(249,115,171,0.08)', chipBorder: 'rgba(249,115,171,0.25)', accentHover: '#ec4899' },
  { accent: '#0FA968', badge: 'rgba(15,169,104,0.12)', chip: 'rgba(15,169,104,0.08)', chipBorder: 'rgba(15,169,104,0.25)', accentHover: '#0c8e58' }
];

let currentStudyPrompt = '';
let currentNotesTemplate = null;
let currentNotesPrompt = '';

function mountStudyToolCards(){
  const grid = document.getElementById('studyToolsGrid');
  if(!grid) return;
  grid.innerHTML = '';
  STUDY_TOOLS.forEach((tool, index)=>{
    const card = document.createElement('div');
    card.className = 'preset-card tool-card';
    const style = TOOL_STYLE_PALETTE[index % TOOL_STYLE_PALETTE.length] || TOOL_STYLE_PALETTE[0];
    card.style.setProperty('--tool-accent', style.accent);
    card.style.setProperty('--tool-accent-hover', style.accentHover || style.accent);
    card.style.setProperty('--tool-badge-bg', style.badge);
    card.style.setProperty('--tool-chip-bg', style.chip);
    card.style.setProperty('--tool-chip-border', style.chipBorder);
    const points = (tool.points || []).map(point => `<li>${point}</li>`).join('');
    card.innerHTML = `
      <div class="tool-badge">${tool.icon} ${tool.name}</div>
      <ul class="tool-points">${points}</ul>
      <div class="tool-actions">
        <button class="btn-primary" data-tool="${tool.id}">üìã Copy Prompt</button>
        <button class="btn btn-ghost" data-preview="${tool.id}">üëÅ Preview</button>
      </div>`;
    grid.appendChild(card);
  });

  grid.querySelectorAll('button[data-tool]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-tool');
      const tool = STUDY_TOOLS.find(t=>t.id===id);
      if(!tool) return;
      const prompt = tool.builder();
      setStudyPreview(prompt, tool.name);
      copyTextToClipboard(prompt);
    });
  });
  grid.querySelectorAll('button[data-preview]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-preview');
      const tool = STUDY_TOOLS.find(t=>t.id===id);
      if(!tool) return;
      const prompt = tool.builder();
      setStudyPreview(prompt, tool.name);
    });
  });
}

function setStudyPreview(text, label){
  currentStudyPrompt = text || '';
  const panel = $('studyPreviewPanel');
  const placeholder = $('studyPreviewPlaceholder');
  const pre = $('studyPreviewText');
  const meta = $('studyPreviewMeta');
  const titleEl = $('studyPreviewTitle');
  if (!panel) return;
  setCharStatus(text ? text.length : 0);
  panel.classList.remove('hidden');
  if (titleEl) titleEl.textContent = 'Preview';
  if (!text) {
    if (placeholder) {
      placeholder.textContent = 'Select ‚ÄúPreview‚Äù on a tool to view the full prompt here.';
      placeholder.classList.remove('hidden');
    }
    if (pre) pre.classList.add('hidden');
    if (meta) meta.textContent = '';
    return;
  }
  if (placeholder) placeholder.classList.add('hidden');
  if (pre) {
    pre.textContent = text;
    pre.classList.remove('hidden');
  }
  if (meta) {
    const count = text.length.toLocaleString();
    meta.textContent = `${count} chars ‚Ä¢ ${label}`;
  }
  if (titleEl && label) {
    titleEl.textContent = `Preview ‚Äî ${label}`;
  }
  setTimeout(()=>{
    panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 100);
}

function showToast(){
  const t = $('toast');
  if(!t) return;
  t.classList.add('show');
  setTimeout(()=> t.classList.remove('show'), 1800);
}

function copyTextToClipboard(text){
  if (!text) return;
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showToast();
    }).catch(err => {
      alert('Failed to copy to clipboard: ' + err.message);
    });
    return;
  }
  const ta = document.createElement('textarea');
  ta.value = text;
  ta.style.position = 'fixed';
  ta.style.top = '0';
  ta.style.left = '0';
  ta.style.opacity = '0';
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  try {
    document.execCommand('copy');
    showToast();
  } catch (e) {
    alert('Failed to copy: ' + e.message);
  }
  document.body.removeChild(ta);
}

const NOTES_TEMPLATES = [
  {
    id: 'summary',
    icon: 'üìù',
    name: 'Structured Summary',
    points: [
      'Surface the key arguments and evidence in the notes',
      'Group related concepts with timestamp or heading cues',
      'Highlight misconceptions, clarifications, and next steps',
      'Compile an evidence appendix for quality assurance'
    ],
    build: (notes, meta) => `SYSTEM
Return ONE file only: ${meta.slug}_notes_summary.docx (Word A4). Do NOT ask questions. Do NOT use external sources.

NOTES SAFEGUARD
‚Ä¢ Use only the supplied notes. If cleaned text < 400 words, return ‚ÄúINSUFFICIENT_NOTES ‚Äî add more detail and retry.‚Äù
‚Ä¢ Auto-run collect ‚Üí analyse ‚Üí write ‚Üí validate (no user confirmation).
‚Ä¢ Use UK English, WCAG-AA contrast, Queen‚Äôs red (#E0001B).

OUTPUT STRUCTURE
1) Title page ‚Äî use "${meta.title}" + module, date, and a 90‚Äì120 word ‚ÄúHow to use this guide‚Äù.
2) Key outcomes ‚Äî 4‚Äì6 outcome statements linked directly to the notes.
3) Section summaries ‚Äî 5‚Äì8 sections: heading, what it covers, why it matters, evidence snippet.
4) Concept connectors ‚Äî bullets for links, misconceptions, follow-up actions.
5) Appendix A ‚Äî ‚â•18 quoted evidence snippets (5‚Äì20 words + source/heading).

NOTES (verbatim ‚Äî analyse only this text):
${notes}
`
  },
  {
    id: 'revision',
    icon: 'üéØ',
    name: 'Revision Deck',
    points: [
      'Build 30 flashcards with answers and difficulty tags',
      'Add a 10-question self-check quiz with rationales',
      'Surface common slips and suggestions for next study moves',
      'Keep everything grounded in timestamped note evidence'
    ],
    build: (notes, meta) => `SYSTEM
Return ONE file only: ${meta.slug}_notes_revision.docx (Word A4). Do NOT ask questions. Do NOT use external sources.

NOTES SAFEGUARD
‚Ä¢ Use only the supplied notes. If cleaned text < 400 words, return ‚ÄúINSUFFICIENT_NOTES ‚Äî add more detail and retry.‚Äù
‚Ä¢ Auto-run collect ‚Üí analyse ‚Üí write ‚Üí validate.
‚Ä¢ Use UK English, WCAG-AA, Queen‚Äôs red accents.

OUTPUT STRUCTURE
1) Orientation ‚Äî ‚â§120 words on how to revise with this pack.
2) Flashcards ‚Äî table of 30 cards: ID, Question, Answer, Connection to notes, Difficulty (Fdn/Int/Adv), Source [heading/time].
3) Quick quiz ‚Äî 10 items (MC/SA mix) with answer, 20‚Äì30 word rationale, likely misconception, source.
4) Study tips ‚Äî 6 bullet recommendations linked to upcoming assessments.
5) Appendix A ‚Äî ‚â•18 quoted evidence snippets (5‚Äì20 words + source/heading).

NOTES (verbatim ‚Äî analyse only this text):
${notes}
`
  },
  {
    id: 'workshop',
    icon: 'üó∫Ô∏è',
    name: 'Workshop Plan',
    points: [
      'Draft a ready-to-run session plan from the notes',
      'Sequence activities with timings and participation modes',
      'Provide reflection prompts and follow-up support routes',
      'Evidence every section with note references'
    ],
    build: (notes, meta) => `SYSTEM
Return ONE file only: ${meta.slug}_notes_plan.docx (Word A4). Do NOT ask questions. Do NOT use external sources.

NOTES SAFEGUARD
‚Ä¢ Use only the supplied notes. If cleaned text < 400 words, return ‚ÄúINSUFFICIENT_NOTES ‚Äî add more detail and retry.‚Äù
‚Ä¢ Auto-run collect ‚Üí analyse ‚Üí write ‚Üí validate.
‚Ä¢ Use UK English, WCAG-AA, inclusive tone.

OUTPUT STRUCTURE
1) Session overview ‚Äî two short paragraphs covering purpose, context, and success metrics drawn from the notes.
2) Workshop blueprint ‚Äî table with columns: Phase, Duration, Objectives, Activity steps, Evidence references, Participation mode.
3) Reflection prompts ‚Äî 6 prompts spanning analyse/evaluate/create linked to the notes.
4) Support & follow-up ‚Äî bullet list of help routes, resources, accessibility adjustments.
5) Appendix A ‚Äî ‚â•18 quoted evidence snippets (5‚Äì20 words + source/heading).

NOTES (verbatim ‚Äî analyse only this text):
${notes}
`
  }
];

function deriveNotesMeta(raw) {
  const lines = (raw || '').split(/\r?\n/).map(l => l.trim()).filter(Boolean);
  let title = lines.length ? lines[0].replace(/^#+\s*/, '') : 'Notes Pack';
  if (title.length < 4 && lines.length > 1) title = lines[1];
  const cleanTitle = title || 'Notes Pack';
  const slug = slugify(cleanTitle);
  return { title: cleanTitle, slug: slug || 'Notes_Pack' };
}

function getNotesInput() {
  return ($('notesInput')?.value || '').trim();
}

function buildNotesOutput(template, rawNotes) {
  const notes = (rawNotes || '').trim();
  if (!notes) {
    return { error: 'Please paste your notes first.' };
  }
  const meta = deriveNotesMeta(notes);
  const prompt = template.build(notes, meta);
  return { prompt, label: template.name };
}

function mountNotesToolCards(){
  const grid = document.getElementById('notesToolsGrid');
  if(!grid) return;
  grid.innerHTML = '';
  NOTES_TEMPLATES.forEach((tool, index)=>{
    const card = document.createElement('div');
    card.className = 'preset-card tool-card';
    const style = TOOL_STYLE_PALETTE[(index + 2) % TOOL_STYLE_PALETTE.length];
    card.style.setProperty('--tool-accent', style.accent);
    card.style.setProperty('--tool-accent-hover', style.accentHover || style.accent);
    card.style.setProperty('--tool-badge-bg', style.badge);
    card.style.setProperty('--tool-chip-bg', style.chip);
    card.style.setProperty('--tool-chip-border', style.chipBorder);
    const points = (tool.points || []).map(point => `<li>${point}</li>`).join('');
    card.innerHTML = `
      <div class=\"tool-badge\">${tool.icon} ${tool.name}</div>
      <ul class=\"tool-points\">${points}</ul>
      <div class=\"tool-actions\">
        <button class=\"btn-primary\" data-tool=\"${tool.id}\">üìã Copy Prompt</button>
        <button class=\"btn btn-ghost\" data-preview=\"${tool.id}\">üëÅ Preview</button>
      </div>`;
    grid.appendChild(card);
  });

  if (state.workflow === 'notes') {
    setNotesPreview('', '', null);
  } else {
    setCharStatus((currentNotesPrompt || '').length);
  }

  grid.querySelectorAll('button[data-tool]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-tool');
      const template = NOTES_TEMPLATES.find(t=>t.id===id);
      const result = buildNotesOutput(template, getNotesInput());
      if (result.error) { alert(result.error); return; }
      if (result.prompt.length > 8000) {
        setNotesPreview(result.prompt, template.name, template);
        alert('This prompt is over 8000 characters. Trim your notes and preview again.');
        return;
      }
      setNotesPreview(result.prompt, template.name, template);
      copyTextToClipboard(result.prompt);
    });
  });

  grid.querySelectorAll('button[data-preview]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-preview');
      const template = NOTES_TEMPLATES.find(t=>t.id===id);
      const result = buildNotesOutput(template, getNotesInput());
      if (result.error) { alert(result.error); return; }
      setNotesPreview(result.prompt, template.name, template);
      if (result.prompt.length > 8000) {
        alert('This prompt is over 8000 characters. Trim your notes to stay within the limit.');
      }
    });
  });
  if (state.workflow === 'notes') {
    setNotesPreview('', '', null);
  }
}

function setNotesPreview(text, label, template){
  const panel = $('notesPreviewPanel');
  const placeholder = $('notesPreviewPlaceholder');
  const pre = $('notesPreviewText');
  const meta = $('notesPreviewMeta');
  const titleEl = $('notesPreviewTitle');
  if (!panel) return;
  const content = text || '';
  if (template) {
    currentNotesTemplate = template;
  } else if (!content) {
    currentNotesTemplate = null;
  }
  currentNotesPrompt = content;
  setCharStatus(content.length);
  panel.classList.remove('hidden');
  if (titleEl) titleEl.textContent = label ? `Preview ‚Äî ${label}` : 'Preview';
  if (!content) {
    if (placeholder) {
      placeholder.textContent = 'Paste notes and choose ‚ÄúPreview‚Äù to check the final prompt.';
      placeholder.classList.remove('hidden');
    }
    if (pre) pre.classList.add('hidden');
    if (meta) meta.textContent = '';
    return;
  }
  if (placeholder) placeholder.classList.add('hidden');
  if (pre) {
    pre.textContent = content;
    pre.classList.remove('hidden');
  }
  if (meta) {
    const count = content.length.toLocaleString();
    let message = `${count} chars` + (label ? ` ‚Ä¢ ${label}` : '');
    if (content.length > 8000) message += ' ‚Ä¢ Trim notes to stay under 8000';
    meta.textContent = message;
  }
}

function refreshNotesPreview(){
  if (!currentNotesTemplate) return;
  const result = buildNotesOutput(currentNotesTemplate, getNotesInput());
  if (result.error) {
    setNotesPreview('', '', null);
    return;
  }
  setNotesPreview(result.prompt, currentNotesTemplate.name, currentNotesTemplate);
}

// Render preview
function render() {
  if (state.workflow === 'study') {
    setCharStatus(0);
    if ($('previewPlaceholder')) $('previewPlaceholder').classList.remove('hidden');
    if ($('previewText')) $('previewText').classList.add('hidden');
    return;
  }

  if (state.workflow === 'notes') {
    setCharStatus(currentNotesPrompt ? currentNotesPrompt.length : 0);
    return;
  }

  let prompt = '';
  if (state.workflow === 'quiz') prompt = buildQuizPrompt();

  setCharStatus(prompt.length);
  
  if (prompt) {
    $('previewPlaceholder').classList.add('hidden');
    $('previewText').classList.remove('hidden');
    $('previewText').textContent = prompt;
  } else {
    $('previewPlaceholder').classList.remove('hidden');
    $('previewText').classList.add('hidden');
  }
}

// Copy to clipboard
function copyPrompt() {
  if (state.workflow === 'study') {
    if (!currentStudyPrompt) {
      alert('Select a tool and preview or copy its prompt first.');
      return;
    }
    if (currentStudyPrompt.length > 8000) {
      alert('This prompt is over 8000 characters. Trim inputs and preview again.');
      return;
    }
    copyTextToClipboard(currentStudyPrompt);
    return;
  }

  if (state.workflow === 'notes') {
    if (!currentNotesPrompt) {
      alert('Paste your notes, choose a tool, then preview before copying.');
      return;
    }
    if (currentNotesPrompt.length > 8000) {
      alert('This prompt is over 8000 characters. Trim your notes and preview again.');
      return;
    }
    copyTextToClipboard(currentNotesPrompt);
    return;
  }

  let prompt = '';
  if (state.workflow === 'quiz') prompt = buildQuizPrompt();

  if (!prompt || prompt.trim() === '') {
    console.error('No prompt generated!');
    alert('No prompt to copy yet. Please ensure you have selected your options.');
    return;
  }

  copyTextToClipboard(prompt);
}

// Init question type chips
function initQuestionTypes() {
  const container = $('questionTypes');
  container.innerHTML = '';
  QUESTION_TYPES.forEach(type => {
    const chip = document.createElement('div');
    chip.className = 'chip' + (state.questionTypes.includes(type.id) ? ' active' : '');
    chip.textContent = type.label;
    chip.onclick = () => {
      if (state.questionTypes.includes(type.id)) {
        state.questionTypes = state.questionTypes.filter(t => t !== type.id);
      } else {
        state.questionTypes.push(type.id);
      }
      chip.classList.toggle('active');
      render();
    };
    container.appendChild(chip);
  });
}

// Init
function init() {
  // Update pedagogy brief on load (quiz)
  const p = PEDAGOGY[state.pedagogy];
  if (p) $('pedBrief').textContent = p.brief;
  
  // Update pedagogy brief on load (notes)
  // Hero content for each page
  const heroContent = {
    help: {
      badge: 'Getting Started',
      title: 'Welcome to Prompt Builder',
      subtitle: 'Your guide to generating QUB-aligned quizzes and study resources in minutes',
      class: 'help-hero'
    },
    quiz: {
      badge: 'Canvas Quiz Builder',
      title: 'Create Perfect Quizzes in Seconds',
      subtitle: 'Transform your Panopto lectures into Canvas-ready quizzes with AI‚Äîaligned with Queen\'s Beyond Blended pedagogy',
      class: 'quiz-hero'
    },
    study: {
      badge: 'Study Guide Generator',
      title: 'Build Comprehensive Study Resources',
      subtitle: 'Generate rich, pedagogy-first study guides with flashcards, problems, and reflections from your lectures',
      class: 'study-hero'
    },
    notes: {
      badge: 'Notes to Resources',
      title: 'Transform Notes into Study Packs',
      subtitle: 'Convert your lecture notes into structured, student-ready study materials with expert guidance',
      class: 'notes-hero'
    },
  };
  
  // Help button - navigate to Getting Started page
  if ($('helpToggle')) {
    $('helpToggle').onclick = () => {
      $$('.workflow-btn').forEach(b => b.classList.remove('active'));
      const helpBtn = document.querySelector('[data-tab="help"]');
      if (helpBtn) {
        helpBtn.classList.add('active');
        state.workflow = 'help';
        $$('.workflow-content').forEach(w => w.classList.add('hidden'));
        document.querySelector('.help-workflow').classList.remove('hidden');
        
        // Hide preview section and update hero banner
        const previewSection = $('previewSection');
        if (previewSection) previewSection.style.display = 'none';
        
        const hero = heroContent.help;
        if (hero) {
          const heroBanner = $('heroBanner');
          heroBanner.className = 'hero-banner ' + hero.class;
          $('heroBadgeText').textContent = hero.badge;
          $('heroTitle').textContent = hero.title;
          $('heroSubtitle').textContent = hero.subtitle;
        }
        // Ensure FAQ gets initialized when entering help
        setTimeout(() => {
          if (typeof setupFaqAccordion === 'function') setupFaqAccordion();
        }, 0);
      }
    };
  }
  
  // Dismiss handlers
  if ($('dismissAbout')) {
    $('dismissAbout').onclick = () => {
      $('about').classList.remove('show');
    };
  }
  
  if ($('hidePreflight')) {
    $('hidePreflight').onclick = () => {
      $('preflight').classList.remove('show');
    };
  }
  
  if ($('hideCanvasHow')) {
    $('hideCanvasHow').onclick = () => {
      $('canvasHow').classList.remove('show');
    };
  }
  
  initQuestionTypes();
  render();
  
  // Attach progressive enhancement handlers in case inline onClick is stripped
  $$('.workflow-btn').forEach(btn => {
    btn.addEventListener('click', () => window.switchWorkflow(btn.dataset.tab));
  });

  // Last-resort: delegate clicks anywhere in the document to catch edge cases
  document.addEventListener('click', (ev) => {
    const btn = ev.target && ev.target.closest && ev.target.closest('.workflow-btn');
    if (btn && btn.dataset && btn.dataset.tab) {
      ev.preventDefault();
      window.switchWorkflow(btn.dataset.tab);
    }
  }, true);

  // Expose switchWorkflow for inline onclick
  window.switchWorkflow = function(tab) {
    console.log('switchWorkflow called with tab:', tab);
    if (!tab) return;
    // Update active state
    $$('.workflow-btn').forEach(b => b.classList.remove('active'));
    const activeBtn = document.querySelector('[data-tab="' + tab + '"]');
    if (activeBtn) activeBtn.classList.add('active');
    state.workflow = tab;

    // Toggle content visibility
    $$('.workflow-content').forEach(w => w.classList.add('hidden'));
    const target = document.querySelector('.' + tab + '-workflow');
    console.log('Target element for', tab + '-workflow:', target);
    if (target) {
      target.classList.remove('hidden');
      console.log('Successfully switched to', tab, 'workflow');
    } else {
      console.error('Could not find element with class', tab + '-workflow');
    }

    // Update hero banner
    const hero = heroContent[state.workflow];
    if (hero) {
      const heroBanner = $('heroBanner');
      heroBanner.className = 'hero-banner ' + hero.class;
      $('heroBadgeText').textContent = hero.badge;
      $('heroTitle').textContent = hero.title;
      $('heroSubtitle').textContent = hero.subtitle;
    }

    if (state.workflow === 'study') {
      setTimeout(() => {
        try {
          mountStudyToolCards();
        } catch (e) {
          console.warn('Study tools deck failed:', e);
        }
      }, 0);
    } else if (state.workflow === 'notes') {
      setTimeout(() => {
        try {
          mountNotesToolCards();
          refreshNotesPreview();
        } catch (e) {
          console.warn('Notes tools deck failed:', e);
        }
      }, 0);
    }

    // Show/hide preview section
    const previewSection = $('previewSection');
    if (previewSection) previewSection.style.display = (state.workflow === 'help' || state.workflow === 'study' || state.workflow === 'notes') ? 'none' : 'block';

    const studyPanel = $('studyPreviewPanel');
    if (studyPanel) {
      if (state.workflow === 'study') {
        studyPanel.classList.remove('hidden');
        setStudyPreview('', '');
      } else {
        studyPanel.classList.add('hidden');
        currentStudyPrompt = '';
      }
    }

    const notesPanel = $('notesPreviewPanel');
    if (notesPanel) {
      if (state.workflow === 'notes') {
        notesPanel.classList.remove('hidden');
        refreshNotesPreview();
      } else {
        notesPanel.classList.add('hidden');
        currentNotesPrompt = '';
        currentNotesTemplate = null;
      }
    }

    // Re-setup FAQ when switching to help page
    if (state.workflow === 'help') {
      setTimeout(() => {
        if (typeof setupFaqAccordion === 'function') setupFaqAccordion();
      }, 0);
    } else if (state.workflow !== 'study' && state.workflow !== 'notes') {
      render();
    }
  };
  
  // Show Getting Started by default
  window.switchWorkflow('help');
  
  // Pedagogy selector
  $('pedagogy').addEventListener('change', () => {
    state.pedagogy = $('pedagogy').value;
    const p = PEDAGOGY[state.pedagogy];
    $('pedBrief').textContent = p?.brief || '';
    render();
  });
  
  // Advanced toggles
  $('advancedToggle').onclick = () => {
    $('advancedContent').classList.toggle('open');
    $('advancedToggle').querySelector('.advanced-toggle').classList.toggle('open');
  };
  
  // Form inputs - Quiz
  if ($('quizTitle')) {
    $('quizTitle').oninput = e => { state.quizTitle = e.target.value; render(); };
  }
  const quizLangEl = $('quizLang');
  if (quizLangEl) {
    quizLangEl.onchange = e => { state.quizLang = e.target.value; render(); };
  }
  const quizCountEl = $('quizCount');
  if (quizCountEl) {
    quizCountEl.oninput = e => { state.quizCount = +e.target.value; render(); };
  }
  const quizFeedbackEl = $('quizFeedback');
  if (quizFeedbackEl) {
    quizFeedbackEl.onchange = e => { state.quizFeedback = e.target.value; render(); };
  }
  
  // Form inputs - Study Guide (using inline handlers, no duplicates needed)
  
  // Form inputs - From Notes (using inline handlers, no duplicates needed)
  if ($('notesInput')) {
    $('notesInput').oninput = e => {
      state.notesInput = e.target.value;
      if (state.workflow === 'notes') {
        refreshNotesPreview();
        if (!currentNotesTemplate) setCharStatus(0);
      }
    };
  }
  
  // Copy buttons
  if ($('generateQuiz')) {
    console.log('Wiring generateQuiz button');
  $('generateQuiz').onclick = copyPrompt;
  }
  if ($('generateNotes')) {
    console.log('Wiring generateNotes button');
  $('generateNotes').onclick = copyPrompt;
  }
  if ($('copyTop')) {
    console.log('Wiring copyTop button');
    $('copyTop').onclick = copyPrompt;
  }
  
  // FAQ Accordion - robust setup with measured heights
  function setupFaqAccordion() {
    const items = document.querySelectorAll('.faq-item');
    if (!items || items.length === 0) return;
    items.forEach(item => {
      const question = item.querySelector('.faq-question');
      const answer = item.querySelector('.faq-answer');
      if (!question || !answer) return;

      // Ensure collapsed state baseline
      item.classList.remove('open');
      answer.style.maxHeight = '0px';
      question.setAttribute('role', 'button');
      question.setAttribute('tabindex', '0');
      question.setAttribute('aria-expanded', 'false');

      const toggle = () => {
        // Close others first
        document.querySelectorAll('.faq-item.open').forEach(other => {
          if (other !== item) {
            other.classList.remove('open');
            const otherAns = other.querySelector('.faq-answer');
            const otherQ = other.querySelector('.faq-question');
            if (otherAns) otherAns.style.maxHeight = '0px';
            if (otherQ) otherQ.setAttribute('aria-expanded', 'false');
          }
        });

        // Toggle this one
        const isOpen = item.classList.toggle('open');
        question.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        if (isOpen) {
          // Measure content height
          const inner = answer.querySelector('.faq-answer-text');
          const h = inner ? (inner.scrollHeight + 32) : 300; // padding guard
          answer.style.maxHeight = h + 'px';
        } else {
          answer.style.maxHeight = '0px';
        }
      };

      question.onclick = toggle;
      question.onkeydown = (ev) => {
        if (ev.key === 'Enter' || ev.key === ' ') {
          ev.preventDefault();
          toggle();
        }
      };
    });
  }

  // Initial setup
  setupFaqAccordion();
}

init();
</script>

</body>
</html>
